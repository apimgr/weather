{{template "head" .}}
{{template "navbar" .}}

<!-- Main Content -->
<main class="container">
    <div class="admin-header">
        <div>
            <h1>üéõÔ∏è Admin Dashboard</h1>
            <p class="subtitle">System overview and management</p>
        </div>
    </div>

    <!-- System Statistics -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">üë•</div>
            <div class="stat-content">
                <div class="stat-value" id="totalUsers">0</div>
                <div class="stat-label">Total Users</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">üìç</div>
            <div class="stat-content">
                <div class="stat-value" id="totalLocations">0</div>
                <div class="stat-label">Saved Locations</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">üîë</div>
            <div class="stat-content">
                <div class="stat-value" id="totalTokens">0</div>
                <div class="stat-label">API Tokens</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">üîî</div>
            <div class="stat-content">
                <div class="stat-value" id="totalNotifications">0</div>
                <div class="stat-label">Notifications</div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="card">
        <h2>‚ö° Quick Actions</h2>
        <div class="action-grid">
            <a href="/admin/users" class="action-card">
                <div class="action-icon">üë•</div>
                <div class="action-title">User Management</div>
                <div class="action-description">Manage user accounts and permissions</div>
            </a>
            <a href="/admin/backup" class="action-card">
                <div class="action-icon">üíæ</div>
                <div class="action-title">Backup & Restore</div>
                <div class="action-description">Create and manage backups</div>
            </a>
            <a href="/admin/settings" class="action-card">
                <div class="action-icon">‚öôÔ∏è</div>
                <div class="action-title">Server Settings</div>
                <div class="action-description">Configure system settings</div>
            </a>
            <a href="/admin/channels" class="action-card">
                <div class="action-icon">üì¨</div>
                <div class="action-title">Notifications</div>
                <div class="action-description">Manage notification channels</div>
            </a>
        </div>
    </div>

    <!-- Server Status -->
    <div class="card">
        <div class="card-header">
            <h2>üñ•Ô∏è Server Status</h2>
            <button class="btn btn-secondary" onclick="loadServerStatus()">üîÑ Refresh</button>
        </div>

        <div class="status-grid">
            <div class="status-item">
                <div class="status-label">Server Title</div>
                <div class="status-value" id="serverTitle">{{.server.Title}}</div>
            </div>
            <div class="status-item">
                <div class="status-label">HTTP Port</div>
                <div class="status-value" id="httpPort">{{.server.HTTPPort}}</div>
            </div>
            <div class="status-item">
                <div class="status-label">Timezone</div>
                <div class="status-value" id="timezone">{{.server.Timezone}}</div>
            </div>
            <div class="status-item">
                <div class="status-label">Database Status</div>
                <div class="status-value">
                    <span class="badge badge-success">‚úì Connected</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="card">
        <div class="card-header">
            <h2>üìã Recent Activity</h2>
            <a href="/admin/logs" class="btn btn-secondary">View All Logs</a>
        </div>

        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>User</th>
                        <th>Action</th>
                        <th>Resource</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody id="activityTableBody">
                    <!-- Populated by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- System Health -->
    <div class="card">
        <h2>üè• System Health</h2>
        <div class="health-grid">
            <div class="health-item">
                <div class="health-icon">‚úÖ</div>
                <div class="health-content">
                    <div class="health-title">Database</div>
                    <div class="health-status">Healthy</div>
                </div>
            </div>
            <div class="health-item">
                <div class="health-icon" id="backupHealth">‚úÖ</div>
                <div class="health-content">
                    <div class="health-title">Backups</div>
                    <div class="health-status" id="backupStatus">Enabled</div>
                </div>
            </div>
            <div class="health-item">
                <div class="health-icon">‚úÖ</div>
                <div class="health-content">
                    <div class="health-title">Logging</div>
                    <div class="health-status">Active</div>
                </div>
            </div>
            <div class="health-item">
                <div class="health-icon" id="alertHealth">‚úÖ</div>
                <div class="health-content">
                    <div class="health-title">Weather Alerts</div>
                    <div class="health-status" id="alertStatus">Enabled</div>
                </div>
            </div>
        </div>
    </div>
</main>

<script>
    // Load data on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadSystemStats();
        loadRecentActivity();
        loadServerStatus();

        // Refresh stats every 30 seconds
        setInterval(loadSystemStats, 30000);
    });

    // Load system statistics
    async function loadSystemStats() {
        try {
            const response = await fetch('/api/v1/admin/stats');
            if (!response.ok) throw new Error('Failed to load stats');

            const stats = await response.json();

            document.getElementById('totalUsers').textContent = stats.users.total || 0;
            document.getElementById('totalLocations').textContent = stats.locations || 0;
            document.getElementById('totalTokens').textContent = stats.tokens || 0;
            document.getElementById('totalNotifications').textContent = stats.notifications || 0;
        } catch (error) {
            console.error('Error loading system stats:', error);
        }
    }

    // Load recent activity
    async function loadRecentActivity() {
        try {
            const response = await fetch('/api/v1/admin/logs?limit=10');
            if (!response.ok) throw new Error('Failed to load activity');

            const logs = await response.json();
            renderActivity(logs);
        } catch (error) {
            console.error('Error loading activity:', error);
            document.getElementById('activityTableBody').innerHTML =
                '<tr><td colspan="5" style="text-align: center; padding: 2rem;">No recent activity</td></tr>';
        }
    }

    // Render activity table
    function renderActivity(logs) {
        const tbody = document.getElementById('activityTableBody');
        tbody.innerHTML = '';

        if (logs.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 2rem;">No recent activity</td></tr>';
            return;
        }

        logs.forEach(log => {
            const tr = document.createElement('tr');
            const time = new Date(log.created_at).toLocaleString();
            tr.innerHTML = `
                <td>${time}</td>
                <td>${log.user_email || 'System'}</td>
                <td><span class="badge badge-info">${log.action || '-'}</span></td>
                <td>${log.resource || '-'}</td>
                <td>${log.details || '-'}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    // Load server status
    async function loadServerStatus() {
        try {
            const response = await fetch('/api/v1/admin/backup/stats');
            if (response.ok) {
                const backupStats = await response.json();
                const backupEnabled = backupStats.enabled;

                document.getElementById('backupStatus').textContent = backupEnabled ? 'Enabled' : 'Disabled';
                document.getElementById('backupHealth').textContent = backupEnabled ? '‚úÖ' : '‚ö†Ô∏è';
            }
        } catch (error) {
            console.error('Error loading server status:', error);
        }

        // Load weather alerts status
        try {
            const response = await fetch('/api/v1/admin/settings/features.weather_alerts');
            if (response.ok) {
                const setting = await response.json();
                const alertsEnabled = setting.value === 'true';

                document.getElementById('alertStatus').textContent = alertsEnabled ? 'Enabled' : 'Disabled';
                document.getElementById('alertHealth').textContent = alertsEnabled ? '‚úÖ' : '‚ö†Ô∏è';
            }
        } catch (error) {
            console.error('Error loading alerts status:', error);
        }
    }
</script>

{{template "footer" .}}
