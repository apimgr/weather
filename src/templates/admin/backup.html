{{template "head" .}}
{{template "navbar" .}}

<!-- Main Content -->
    <main class="container">
        <div class="admin-header">
            <div>
                <h1>üíæ Backup Management</h1>
                <p class="subtitle">Manage system backups and restore points</p>
            </div>
            <button class="btn btn-primary" onclick="createBackup()">
                ‚ûï Create Backup Now
            </button>
        </div>

        <!-- Backup Statistics -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üìä</div>
                <div class="stat-content">
                    <div class="stat-value" id="totalBackups">0</div>
                    <div class="stat-label">Total Backups</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üíø</div>
                <div class="stat-content">
                    <div class="stat-value" id="totalSize">0 MB</div>
                    <div class="stat-label">Total Size</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üìÖ</div>
                <div class="stat-content">
                    <div class="stat-value" id="lastBackup">Never</div>
                    <div class="stat-label">Last Backup</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">‚úÖ</div>
                <div class="stat-content">
                    <div class="stat-value" id="backupStatus">Enabled</div>
                    <div class="stat-label">Auto Backup</div>
                </div>
            </div>
        </div>

        <!-- Backup Configuration -->
        <div class="card">
            <h2>Backup Configuration</h2>
            <form id="backupConfigForm" onsubmit="saveBackupConfig(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label class="toggle-label">
                            <input type="checkbox" id="backup_enabled" {{if .settings.backup_enabled}}checked{{end}}>
                            <span class="toggle-slider"></span>
                            <span class="toggle-text">Automatic Backups Enabled</span>
                        </label>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="backup_interval">Backup Interval (hours)</label>
                        <input type="number" id="backup_interval" value="{{.settings.backup_interval}}" min="1" max="168">
                        <small>How often to create automatic backups (1-168 hours)</small>
                    </div>

                    <div class="form-group">
                        <label for="backup_retention">Retention Period (days)</label>
                        <input type="number" id="backup_retention" value="{{.settings.backup_retention}}" min="1" max="365">
                        <small>How long to keep backups before deletion (1-365 days)</small>
                    </div>
                </div>

                <div class="form-group">
                    <label for="backup_location">Backup Location</label>
                    <input type="text" id="backup_location" value="{{.settings.backup_location}}" placeholder="/data/backups">
                    <small>Directory where backups will be stored</small>
                </div>

                <button type="submit" class="btn btn-primary">Save Configuration</button>
            </form>
        </div>

        <!-- Restore from Upload -->
        <div class="card">
            <h2>Restore from Backup File</h2>
            <form id="restoreForm" onsubmit="restoreBackup(event)">
                <div class="form-group">
                    <label for="backupFile">Select Backup File</label>
                    <input type="file" id="backupFile" accept=".sql,.sql.gz,.tar.gz,.zip" required>
                    <small>Upload a backup file (.sql, .sql.gz, .tar.gz, or .zip)</small>
                </div>

                <div class="alert alert-warning">
                    ‚ö†Ô∏è <strong>Warning:</strong> Restoring from a backup will overwrite all current data. Make sure you have a recent backup before proceeding.
                </div>

                <button type="submit" class="btn btn-danger">Restore from File</button>
            </form>
        </div>

        <!-- Backup History -->
        <div class="card">
            <div class="card-header">
                <h2>Backup History</h2>
                <button class="btn btn-secondary" onclick="loadBackups()">üîÑ Refresh</button>
            </div>

            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Filename</th>
                            <th>Type</th>
                            <th>Size</th>
                            <th>Created</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="backupsTableBody">
                        <!-- Populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Scripts -->
    <script src="/static/js/app.js"></script>
    <script>
        let backups = [];

        // Load backups on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadBackups();
            loadBackupStats();
            Notifications.fetch();
            Notifications.startPolling(60000);
        });

        // Load backup statistics
        async function loadBackupStats() {
            try {
                const response = await fetch('/api/v1/admin/backup/stats');
                if (!response.ok) throw new Error('Failed to load stats');

                const stats = await response.json();

                document.getElementById('totalBackups').textContent = stats.total || 0;
                document.getElementById('totalSize').textContent = formatBytes(stats.total_size || 0);
                document.getElementById('lastBackup').textContent = stats.last_backup ? formatDate(stats.last_backup) : 'Never';
                document.getElementById('backupStatus').textContent = stats.enabled ? 'Enabled' : 'Disabled';
            } catch (error) {
                console.error('Error loading backup stats:', error);
            }
        }

        // Load backup history
        async function loadBackups() {
            try {
                const response = await fetch('/api/v1/admin/backup/list');
                if (!response.ok) throw new Error('Failed to load backups');

                backups = await response.json();
                renderBackups();
            } catch (error) {
                Toast.error('Failed to load backups: ' + error.message);
                console.error('Error loading backups:', error);
            }
        }

        // Render backups table
        function renderBackups() {
            const tbody = document.getElementById('backupsTableBody');
            tbody.innerHTML = '';

            if (backups.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem;">No backups found</td></tr>';
                return;
            }

            backups.forEach(backup => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${backup.filename}</td>
                    <td><span class="badge ${getTypeBadge(backup.type)}">${backup.type}</span></td>
                    <td>${formatBytes(backup.size)}</td>
                    <td>${formatDate(backup.created_at)}</td>
                    <td><span class="badge ${backup.status === 'completed' ? 'badge-success' : 'badge-warning'}">${backup.status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="downloadBackup('${backup.filename}')">Download</button>
                        <button class="btn btn-sm btn-success" onclick="restoreFromBackup('${backup.filename}')">Restore</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteBackup('${backup.filename}')">Delete</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Get badge class for backup type
        function getTypeBadge(type) {
            switch(type) {
                case 'database': return 'badge-primary';
                case 'files': return 'badge-info';
                case 'full': return 'badge-success';
                default: return 'badge-secondary';
            }
        }

        // Format bytes to human readable
        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + ' ' + sizes[i];
        }

        // Format date
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        }

        // Create manual backup
        async function createBackup() {
            if (!showConfirm('Create a new backup now? This may take a few moments.')) {
                return;
            }

            try {
                Toast.info('Creating backup...');

                const response = await fetch('/api/v1/admin/backup/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type: 'full' })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to create backup');
                }

                const result = await response.json();
                Toast.success('Backup created successfully: ' + result.filename);
                loadBackups();
                loadBackupStats();
            } catch (error) {
                Toast.error('Failed to create backup: ' + error.message);
                console.error('Error creating backup:', error);
            }
        }

        // Download backup
        function downloadBackup(filename) {
            window.location.href = `/api/v1/admin/backup/download/${filename}`;
        }

        // Restore from existing backup
        async function restoreFromBackup(filename) {
            if (!showConfirm(`Are you sure you want to restore from "${filename}"? This will overwrite all current data. This action cannot be undone.`)) {
                return;
            }

            try {
                Toast.info('Restoring from backup...');

                const response = await fetch('/api/v1/admin/backup/restore', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filename: filename })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to restore backup');
                }

                Toast.success('Backup restored successfully. Please refresh the page.');
                setTimeout(() => window.location.reload(), 2000);
            } catch (error) {
                Toast.error('Failed to restore backup: ' + error.message);
                console.error('Error restoring backup:', error);
            }
        }

        // Delete backup
        async function deleteBackup(filename) {
            if (!showConfirm(`Are you sure you want to delete "${filename}"? This action cannot be undone.`)) {
                return;
            }

            try {
                const response = await fetch(`/api/v1/admin/backup/${filename}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to delete backup');
                }

                Toast.success('Backup deleted successfully');
                loadBackups();
                loadBackupStats();
            } catch (error) {
                Toast.error('Failed to delete backup: ' + error.message);
                console.error('Error deleting backup:', error);
            }
        }

        // Restore from uploaded file
        async function restoreBackup(event) {
            event.preventDefault();

            const fileInput = document.getElementById('backupFile');
            if (!fileInput.files || fileInput.files.length === 0) {
                Toast.error('Please select a backup file');
                return;
            }

            if (!showConfirm('Are you sure you want to restore from this file? This will overwrite all current data.')) {
                return;
            }

            const formData = new FormData();
            formData.append('backup', fileInput.files[0]);

            try {
                Toast.info('Uploading and restoring backup...');

                const response = await fetch('/api/v1/admin/backup/upload-restore', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to restore backup');
                }

                Toast.success('Backup restored successfully. Please refresh the page.');
                setTimeout(() => window.location.reload(), 2000);
            } catch (error) {
                Toast.error('Failed to restore backup: ' + error.message);
                console.error('Error restoring backup:', error);
            }
        }

        // Save backup configuration
        async function saveBackupConfig(event) {
            event.preventDefault();

            const config = {
                'backup.enabled': document.getElementById('backup_enabled').checked,
                'backup.interval': parseInt(document.getElementById('backup_interval').value),
                'backup.retention': parseInt(document.getElementById('backup_retention').value),
                'backup.location': document.getElementById('backup_location').value
            };

            try {
                for (let [key, value] of Object.entries(config)) {
                    const response = await fetch(`/api/v1/admin/settings/${key}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ value: value })
                    });

                    if (!response.ok) {
                        throw new Error(`Failed to update ${key}`);
                    }
                }

                Toast.success('Backup configuration saved successfully');
            } catch (error) {
                Toast.error('Failed to save configuration: ' + error.message);
                console.error('Error saving configuration:', error);
            }
        }
    </script>

{{template "footer" .}}
