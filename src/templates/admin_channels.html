<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notification Channels - Admin</title>
    <link rel="stylesheet" href="/static/css/dracula.css">
    <script src="/static/js/app.js" defer></script>
    <style>
        .channel-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        .channel-card {
            background: var(--dracula-current-line);
            border: 1px solid var(--dracula-comment);
            border-radius: 8px;
            padding: 1rem;
            transition: all 0.3s;
        }
        .channel-card:hover {
            border-color: var(--dracula-purple);
            box-shadow: 0 4px 8px rgba(189, 147, 249, 0.2);
        }
        .channel-card.enabled {
            border-color: var(--dracula-green);
        }
        .channel-card.failed {
            border-color: var(--dracula-red);
        }
        .channel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .channel-name {
            font-weight: bold;
            color: var(--dracula-cyan);
        }
        .channel-status {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.875rem;
        }
        .status-enabled { background: var(--dracula-green); color: #000; }
        .status-disabled { background: var(--dracula-comment); color: #fff; }
        .status-failed { background: var(--dracula-red); color: #fff; }
        .status-testing { background: var(--dracula-yellow); color: #000; }
        .channel-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s;
        }
        .btn-primary {
            background: var(--dracula-purple);
            color: white;
        }
        .btn-success {
            background: var(--dracula-green);
            color: black;
        }
        .btn-danger {
            background: var(--dracula-red);
            color: white;
        }
        .btn-secondary {
            background: var(--dracula-comment);
            color: white;
        }
        .btn:hover {
            opacity: 0.8;
            transform: translateY(-1px);
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .category-section {
            margin-bottom: 2rem;
        }
        .category-title {
            color: var(--dracula-pink);
            font-size: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid var(--dracula-pink);
            padding-bottom: 0.5rem;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
        }
        .modal-content {
            background: var(--dracula-bg);
            margin: 5% auto;
            padding: 2rem;
            border: 1px solid var(--dracula-purple);
            border-radius: 8px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .close {
            cursor: pointer;
            font-size: 2rem;
            color: var(--dracula-red);
        }
        .form-group {
            margin-bottom: 1rem;
        }
        .form-group label {
            display: block;
            color: var(--dracula-cyan);
            margin-bottom: 0.25rem;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.5rem;
            background: var(--dracula-current-line);
            border: 1px solid var(--dracula-comment);
            color: var(--dracula-foreground);
            border-radius: 4px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .stat-card {
            background: var(--dracula-current-line);
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }
        .stat-value {
            font-size: 2rem;
            color: var(--dracula-purple);
            font-weight: bold;
        }
        .stat-label {
            color: var(--dracula-comment);
            font-size: 0.875rem;
        }
        .filter-bar {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            align-items: center;
        }
        .search-box {
            flex: 1;
            padding: 0.5rem;
            background: var(--dracula-current-line);
            border: 1px solid var(--dracula-comment);
            color: var(--dracula-foreground);
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-container">
            <a href="/" class="navbar-brand">
                üå§Ô∏è Weather Service
            </a>
            <div class="navbar-menu">
                <a href="/" class="navbar-link">Weather</a>
                <a href="/moon" class="navbar-link">Moon</a>
                <a href="/earthquake" class="navbar-link">Earthquakes</a>
                <a href="/hurricane" class="navbar-link">Hurricanes</a>
                <a href="/user/dashboard" class="navbar-link">Dashboard</a>
                {{ if eq .user.Role "admin" }}
                <a href="/admin" class="navbar-link active">Admin</a>
                {{ end }}
            </div>
            <div class="navbar-actions">
                <button class="notification-bell" onclick="window.location.href='/notifications'" title="Notifications">
                    üîî
                    <span class="notification-badge" id="notification-badge" class="display-none">0</span>
                </button>
                <div class="profile-avatar">
                    <div class="avatar" onclick="Dropdown.toggle('profile-dropdown', 'profile-avatar')" id="profile-avatar">
                        {{ if .user.Email }}
                            {{ index .user.Email 0 | printf "%c" | upper }}
                        {{ else }}
                            U
                        {{ end }}
                    </div>
                    <div class="profile-dropdown" id="profile-dropdown">
                        <div class="profile-dropdown-header">
                            <div>{{ .user.Email }}</div>
                            <div class="profile-dropdown-role">{{ .user.Role }}</div>
                        </div>
                        <nav class="profile-dropdown-menu">
                            <a href="/user/preferences" class="profile-dropdown-item">‚öôÔ∏è Preferences</a>
                            <a href="/notifications" class="profile-dropdown-item">üîî Notifications</a>
                            <a href="/docs" class="profile-dropdown-item">üìö API Docs</a>
                            <a href="/logout" class="profile-dropdown-item">üö™ Logout</a>
                        </nav>
                    </div>
                </div>
                <button class="navbar-toggle" onclick="MobileMenu.toggle()" aria-label="Menu">
                    ‚ò∞
                </button>
            </div>
        </div>
        <div class="navbar-menu-mobile">
            <a href="/" class="navbar-link">Weather</a>
            <a href="/moon" class="navbar-link">Moon</a>
            <a href="/earthquake" class="navbar-link">Earthquakes</a>
            <a href="/hurricane" class="navbar-link">Hurricanes</a>
            <a href="/user/dashboard" class="navbar-link">Dashboard</a>
            {{ if eq .user.Role "admin" }}
            <a href="/admin" class="navbar-link active">Admin</a>
            {{ end }}
        </div>
    </nav>

    <div class="container">
        <h1>üîî Notification Channels</h1>

        <!-- Stats Dashboard -->
        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" id="total-channels">0</div>
                <div class="stat-label">Total Channels</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="enabled-channels">0</div>
                <div class="stat-label">Enabled</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="pending-notifications">0</div>
                <div class="stat-label">Pending</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="dead-letters">0</div>
                <div class="stat-label">Dead Letters</div>
            </div>
        </div>

        <!-- Filters -->
        <div class="filter-bar">
            <input type="text" class="search-box" id="search" placeholder="Search channels...">
            <select id="category-filter" class="search-box" style="flex: 0 0 200px;">
                <option value="">All Categories</option>
                <option value="email">Email</option>
                <option value="messaging">Messaging</option>
                <option value="sms">SMS</option>
                <option value="push">Push</option>
                <option value="webhook">Webhook</option>
                <option value="voice">Voice</option>
                <option value="collaboration">Collaboration</option>
                <option value="monitoring">Monitoring</option>
                <option value="social">Social</option>
            </select>
            <select id="status-filter" class="search-box" style="flex: 0 0 200px;">
                <option value="">All Status</option>
                <option value="enabled">Enabled</option>
                <option value="disabled">Disabled</option>
                <option value="failed">Failed</option>
            </select>
            <button class="btn btn-primary" onclick="initializeChannels()">Initialize All</button>
        </div>

        <!-- Channels by Category -->
        <div id="channels-container"></div>
    </div>

    <!-- Configuration Modal -->
    <div id="config-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Configure Channel</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div id="modal-body"></div>
        </div>
    </div>

    <!-- Test Modal -->
    <div id="test-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Test Channel</h2>
                <span class="close" onclick="closeTestModal()">&times;</span>
            </div>
            <div class="form-group">
                <label for="test-recipient">Recipient:</label>
                <input type="text" id="test-recipient" placeholder="email@example.com">
            </div>
            <button class="btn btn-primary" onclick="sendTest()">Send Test</button>
            <div id="test-result" style="margin-top: 1rem;"></div>
        </div>
    </div>

    <script>
        let channels = [];
        let currentChannel = null;

        async function loadChannels() {
            try {
                const response = await fetch('/api/admin/channels');
                const data = await response.json();
                channels = data.channels || [];
                renderChannels();
            } catch (error) {
                console.error('Failed to load channels:', error);
            }
        }

        async function loadStats() {
            try {
                const response = await fetch('/api/admin/channels/queue/stats');
                const stats = await response.json();
                document.getElementById('total-channels').textContent = channels.length;
                document.getElementById('enabled-channels').textContent =
                    channels.filter(c => c.enabled).length;
                document.getElementById('pending-notifications').textContent = stats.pending || 0;
                document.getElementById('dead-letters').textContent = stats.dead_letters || 0;
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }

        function renderChannels() {
            const container = document.getElementById('channels-container');
            const search = document.getElementById('search').value.toLowerCase();
            const categoryFilter = document.getElementById('category-filter').value;
            const statusFilter = document.getElementById('status-filter').value;

            // Filter channels
            let filtered = channels.filter(c => {
                const matchSearch = c.channel_name.toLowerCase().includes(search);
                const matchCategory = !categoryFilter || c.channel_type.includes(categoryFilter);
                const matchStatus = !statusFilter || c.state === statusFilter;
                return matchSearch && matchCategory && matchStatus;
            });

            // Group by category
            const grouped = {};
            filtered.forEach(channel => {
                const category = channel.channel_type.split('_')[0];
                if (!grouped[category]) grouped[category] = [];
                grouped[category].push(channel);
            });

            container.innerHTML = '';
            Object.keys(grouped).sort().forEach(category => {
                const section = document.createElement('div');
                section.className = 'category-section';
                section.innerHTML = `
                    <div class="category-title">${category.charAt(0).toUpperCase() + category.slice(1)}</div>
                    <div class="channel-grid" id="category-${category}"></div>
                `;
                container.appendChild(section);

                const grid = section.querySelector('.channel-grid');
                grouped[category].forEach(channel => {
                    const card = createChannelCard(channel);
                    grid.appendChild(card);
                });
            });

            loadStats();
        }

        function createChannelCard(channel) {
            const card = document.createElement('div');
            card.className = `channel-card ${channel.enabled ? 'enabled' : ''} ${channel.state === 'failed' ? 'failed' : ''}`;

            const statusClass = `status-${channel.state || 'disabled'}`;
            const statusText = channel.enabled ? (channel.state || 'enabled') : 'disabled';

            card.innerHTML = `
                <div class="channel-header">
                    <div class="channel-name">${channel.channel_name}</div>
                    <div class="channel-status ${statusClass}">${statusText}</div>
                </div>
                <div style="color: var(--dracula-comment); font-size: 0.875rem; margin-bottom: 0.5rem;">
                    ${channel.channel_type}
                </div>
                ${channel.last_test_at ? `
                    <div style="font-size: 0.75rem; color: var(--dracula-comment);">
                        Last tested: ${new Date(channel.last_test_at).toLocaleString()}
                    </div>
                ` : ''}
                ${channel.last_error ? `
                    <div style="font-size: 0.75rem; color: var(--dracula-red); margin-top: 0.25rem;">
                        ${channel.last_error}
                    </div>
                ` : ''}
                <div class="channel-actions">
                    <button class="btn btn-secondary" onclick="configureChannel('${channel.channel_type}')">
                        ‚öôÔ∏è Configure
                    </button>
                    <button class="btn btn-primary" onclick="testChannel('${channel.channel_type}')">
                        üß™ Test
                    </button>
                    ${channel.enabled ? `
                        <button class="btn btn-danger" onclick="toggleChannel('${channel.channel_type}', false)">
                            Disable
                        </button>
                    ` : `
                        <button class="btn btn-success" onclick="toggleChannel('${channel.channel_type}', true)">
                            Enable
                        </button>
                    `}
                </div>
            `;
            return card;
        }

        function configureChannel(type) {
            currentChannel = type;
            // Load channel config and show modal
            fetch(`/api/admin/channels/${type}`)
                .then(r => r.json())
                .then(channel => {
                    document.getElementById('modal-title').textContent = `Configure ${channel.channel_name}`;
                    document.getElementById('modal-body').innerHTML = `
                        <div class="form-group">
                            <label>Channel Type:</label>
                            <input type="text" value="${channel.channel_type}" disabled>
                        </div>
                        <div class="form-group">
                            <label>Configuration (JSON):</label>
                            <textarea id="channel-config" rows="10">${channel.config || '{}'}</textarea>
                        </div>
                        <button class="btn btn-primary" onclick="saveConfig()">Save</button>
                    `;
                    document.getElementById('config-modal').style.display = 'block';
                });
        }

        function saveConfig() {
            const config = JSON.parse(document.getElementById('channel-config').value);
            fetch(`/api/admin/channels/${currentChannel}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({enabled: true, config: config})
            })
            .then(r => r.json())
            .then(() => {
                closeModal();
                loadChannels();
            });
        }

        function testChannel(type) {
            currentChannel = type;
            document.getElementById('test-modal').style.display = 'block';
            document.getElementById('test-result').innerHTML = '';
        }

        function sendTest() {
            const recipient = document.getElementById('test-recipient').value;
            if (!recipient) {
                showAlert('Please enter a recipient');
                return;
            }

            document.getElementById('test-result').innerHTML = '<div style="color: var(--dracula-yellow)">Sending...</div>';

            fetch(`/api/admin/channels/${currentChannel}/test`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({recipient: recipient})
            })
            .then(r => r.json())
            .then(data => {
                if (data.message) {
                    document.getElementById('test-result').innerHTML =
                        `<div style="color: var(--dracula-green)">‚úÖ ${data.message}</div>`;
                    setTimeout(() => {
                        closeTestModal();
                        loadChannels();
                    }, 2000);
                } else {
                    document.getElementById('test-result').innerHTML =
                        `<div style="color: var(--dracula-red)">‚ùå ${data.error}</div>`;
                }
            })
            .catch(err => {
                document.getElementById('test-result').innerHTML =
                    `<div style="color: var(--dracula-red)">‚ùå ${err.message}</div>`;
            });
        }

        async function toggleChannel(type, enable) {
            const url = `/api/admin/channels/${type}/${enable ? 'enable' : 'disable'}`;
            await fetch(url, {method: 'POST'});
            loadChannels();
        }

        async function initializeChannels() {
            await fetch('/api/admin/channels/initialize', {method: 'POST'});
            loadChannels();
        }

        function closeModal() {
            document.getElementById('config-modal').style.display = 'none';
        }

        function closeTestModal() {
            document.getElementById('test-modal').style.display = 'none';
        }

        // Event listeners
        document.getElementById('search').addEventListener('input', renderChannels);
        document.getElementById('category-filter').addEventListener('change', renderChannels);
        document.getElementById('status-filter').addEventListener('change', renderChannels);

        // Load on page load
        loadChannels();
        setInterval(loadStats, 30000); // Update stats every 30 seconds

        // Initialize notification polling
        if (typeof Notifications !== 'undefined') {
            Notifications.startPolling(30000);
        }
    </script>
</body>
</html>
