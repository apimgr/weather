{{template "head" .}}
{{template "navbar" .}}

<main class="container">
    <div class="admin-header">
        <div>
            <h1>‚öôÔ∏è User Preferences</h1>
            <p class="subtitle">Customize your weather experience</p>
        </div>
    </div>

    <!-- Notification Preferences -->
    <div class="card">
        <h2>üîî Notification Preferences</h2>
        <p style="color: var(--dracula-comment); margin-bottom: 1.5rem;">
            Choose how you want to receive weather alerts and notifications
        </p>

        <form id="notificationForm" onsubmit="saveNotificationPreferences(event)">
            <!-- Email Notifications -->
            <div class="form-group">
                <div class="preference-item">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <span style="font-size: 2rem;">üìß</span>
                        <div style="flex: 1;">
                            <h3 style="margin: 0; color: var(--dracula-cyan);">Email Notifications</h3>
                            <p style="margin: 0.25rem 0 0 0; font-size: 0.9rem; color: var(--dracula-comment);">
                                Receive weather alerts via email
                            </p>
                        </div>
                        <label class="toggle-label">
                            <input type="checkbox" id="email_enabled" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div id="email_config" style="margin-top: 1rem; padding-left: 3rem;">
                        <div class="form-group">
                            <label for="email_address">Email Address</label>
                            <input type="email" id="email_address" value="{{.user.Email}}" placeholder="your@email.com">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Push Notifications -->
            <div class="form-group">
                <div class="preference-item">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <span style="font-size: 2rem;">üì±</span>
                        <div style="flex: 1;">
                            <h3 style="margin: 0; color: var(--dracula-cyan);">Push Notifications</h3>
                            <p style="margin: 0.25rem 0 0 0; font-size: 0.9rem; color: var(--dracula-comment);">
                                Get instant alerts on your device (browser notifications)
                            </p>
                        </div>
                        <label class="toggle-label">
                            <input type="checkbox" id="push_enabled">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Telegram Notifications -->
            <div class="form-group">
                <div class="preference-item">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <span style="font-size: 2rem;">üí¨</span>
                        <div style="flex: 1;">
                            <h3 style="margin: 0; color: var(--dracula-cyan);">Telegram</h3>
                            <p style="margin: 0.25rem 0 0 0; font-size: 0.9rem; color: var(--dracula-comment);">
                                Receive alerts via Telegram messenger
                            </p>
                        </div>
                        <label class="toggle-label">
                            <input type="checkbox" id="telegram_enabled" onchange="toggleTelegramConfig()">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div id="telegram_config" style="margin-top: 1rem; padding-left: 3rem; display: none;">
                        <div class="form-group">
                            <label for="telegram_chat_id">Telegram Chat ID</label>
                            <input type="text" id="telegram_chat_id" placeholder="123456789">
                            <small style="display: block; margin-top: 0.25rem; color: var(--dracula-comment);">
                                Get your Chat ID by messaging <a href="https://t.me/userinfobot" target="_blank" style="color: var(--dracula-cyan);">@userinfobot</a>
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Discord Notifications -->
            <div class="form-group">
                <div class="preference-item">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <span style="font-size: 2rem;">üéÆ</span>
                        <div style="flex: 1;">
                            <h3 style="margin: 0; color: var(--dracula-cyan);">Discord</h3>
                            <p style="margin: 0.25rem 0 0 0; font-size: 0.9rem; color: var(--dracula-comment);">
                                Get weather updates in your Discord server
                            </p>
                        </div>
                        <label class="toggle-label">
                            <input type="checkbox" id="discord_enabled" onchange="toggleDiscordConfig()">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div id="discord_config" style="margin-top: 1rem; padding-left: 3rem; display: none;">
                        <div class="form-group">
                            <label for="discord_webhook">Discord Webhook URL</label>
                            <input type="text" id="discord_webhook" placeholder="https://discord.com/api/webhooks/...">
                            <small style="display: block; margin-top: 0.25rem; color: var(--dracula-comment);">
                                Create a webhook in your Discord server settings
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <div style="margin-top: 2rem;">
                <button type="submit" class="btn btn-primary">Save Notification Preferences</button>
            </div>
        </form>
    </div>

    <!-- Weather Preferences -->
    <div class="card">
        <h2>üå§Ô∏è Weather Display Preferences</h2>

        <form id="weatherForm" onsubmit="saveWeatherPreferences(event)">
            <div class="form-row">
                <div class="form-group">
                    <label for="temperature_unit">Temperature Unit</label>
                    <select id="temperature_unit">
                        <option value="fahrenheit">Fahrenheit (¬∞F)</option>
                        <option value="celsius">Celsius (¬∞C)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="wind_speed_unit">Wind Speed Unit</label>
                    <select id="wind_speed_unit">
                        <option value="mph">Miles per Hour (mph)</option>
                        <option value="kmh">Kilometers per Hour (km/h)</option>
                        <option value="ms">Meters per Second (m/s)</option>
                        <option value="knots">Knots</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="timezone">Timezone</label>
                    <select id="timezone">
                        <option value="America/New_York">Eastern Time (ET)</option>
                        <option value="America/Chicago">Central Time (CT)</option>
                        <option value="America/Denver">Mountain Time (MT)</option>
                        <option value="America/Los_Angeles">Pacific Time (PT)</option>
                        <option value="Europe/London">London (GMT)</option>
                        <option value="Europe/Paris">Paris (CET)</option>
                        <option value="Asia/Tokyo">Tokyo (JST)</option>
                        <option value="UTC">UTC</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="date_format">Date Format</label>
                    <select id="date_format">
                        <option value="US">US (MM/DD/YYYY)</option>
                        <option value="EU">EU (DD/MM/YYYY)</option>
                        <option value="ISO">ISO (YYYY-MM-DD)</option>
                    </select>
                </div>
            </div>

            <div style="margin-top: 2rem;">
                <button type="submit" class="btn btn-primary">Save Weather Preferences</button>
            </div>
        </form>
    </div>

    <!-- Alert Settings -->
    <div class="card">
        <h2>‚ö†Ô∏è Weather Alert Settings</h2>

        <form id="alertForm" onsubmit="saveAlertSettings(event)">
            <div class="form-group">
                <label class="toggle-label">
                    <input type="checkbox" id="severe_weather_alerts" checked>
                    <span class="toggle-slider"></span>
                    <span class="toggle-text">Severe Weather Alerts</span>
                </label>
                <small style="display: block; margin-top: 0.5rem; color: var(--dracula-comment);">
                    Get notified about severe weather warnings (tornadoes, hurricanes, etc.)
                </small>
            </div>

            <div class="form-group">
                <label class="toggle-label">
                    <input type="checkbox" id="temperature_alerts" checked>
                    <span class="toggle-slider"></span>
                    <span class="toggle-text">Temperature Alerts</span>
                </label>
                <small style="display: block; margin-top: 0.5rem; color: var(--dracula-comment);">
                    Get notified about extreme temperatures
                </small>
            </div>

            <div class="form-group">
                <label class="toggle-label">
                    <input type="checkbox" id="precipitation_alerts">
                    <span class="toggle-slider"></span>
                    <span class="toggle-text">Precipitation Alerts</span>
                </label>
                <small style="display: block; margin-top: 0.5rem; color: var(--dracula-comment);">
                    Get notified about upcoming rain or snow
                </small>
            </div>

            <div class="form-group">
                <label class="toggle-label">
                    <input type="checkbox" id="wind_alerts">
                    <span class="toggle-slider"></span>
                    <span class="toggle-text">Wind Alerts</span>
                </label>
                <small style="display: block; margin-top: 0.5rem; color: var(--dracula-comment);">
                    Get notified about high wind conditions
                </small>
            </div>

            <div style="margin-top: 2rem;">
                <button type="submit" class="btn btn-primary">Save Alert Settings</button>
            </div>
        </form>
    </div>
</main>

<script>
    // Toggle config sections
    function toggleTelegramConfig() {
        const enabled = document.getElementById('telegram_enabled').checked;
        document.getElementById('telegram_config').style.display = enabled ? 'block' : 'none';
    }

    function toggleDiscordConfig() {
        const enabled = document.getElementById('discord_enabled').checked;
        document.getElementById('discord_config').style.display = enabled ? 'block' : 'none';
    }

    // Save notification preferences
    async function saveNotificationPreferences(event) {
        event.preventDefault();

        const preferences = {
            email_enabled: document.getElementById('email_enabled').checked,
            email_address: document.getElementById('email_address').value,
            push_enabled: document.getElementById('push_enabled').checked,
            telegram_enabled: document.getElementById('telegram_enabled').checked,
            telegram_chat_id: document.getElementById('telegram_chat_id').value,
            discord_enabled: document.getElementById('discord_enabled').checked,
            discord_webhook: document.getElementById('discord_webhook').value
        };

        try {
            const response = await fetch('/api/v1/user/preferences/notifications', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(preferences)
            });

            if (!response.ok) throw new Error('Failed to save preferences');

            Toast.success('Notification preferences saved');
        } catch (error) {
            Toast.error('Failed to save preferences: ' + error.message);
        }
    }

    // Save weather preferences
    async function saveWeatherPreferences(event) {
        event.preventDefault();

        const preferences = {
            temperature_unit: document.getElementById('temperature_unit').value,
            wind_speed_unit: document.getElementById('wind_speed_unit').value,
            timezone: document.getElementById('timezone').value,
            date_format: document.getElementById('date_format').value
        };

        try {
            const response = await fetch('/api/v1/user/preferences/weather', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(preferences)
            });

            if (!response.ok) throw new Error('Failed to save preferences');

            Toast.success('Weather preferences saved');
        } catch (error) {
            Toast.error('Failed to save preferences: ' + error.message);
        }
    }

    // Save alert settings
    async function saveAlertSettings(event) {
        event.preventDefault();

        const settings = {
            severe_weather_alerts: document.getElementById('severe_weather_alerts').checked,
            temperature_alerts: document.getElementById('temperature_alerts').checked,
            precipitation_alerts: document.getElementById('precipitation_alerts').checked,
            wind_alerts: document.getElementById('wind_alerts').checked
        };

        try {
            const response = await fetch('/api/v1/user/preferences/alerts', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(settings)
            });

            if (!response.ok) throw new Error('Failed to save settings');

            Toast.success('Alert settings saved');
        } catch (error) {
            Toast.error('Failed to save settings: ' + error.message);
        }
    }

    // Load preferences on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadPreferences();
    });

    async function loadPreferences() {
        try {
            const response = await fetch('/api/v1/user/preferences');
            if (response.ok) {
                const prefs = await response.json();

                // Load notification preferences
                if (prefs.notifications) {
                    document.getElementById('email_enabled').checked = prefs.notifications.email_enabled || false;
                    document.getElementById('email_address').value = prefs.notifications.email_address || '';
                    document.getElementById('push_enabled').checked = prefs.notifications.push_enabled || false;
                    document.getElementById('telegram_enabled').checked = prefs.notifications.telegram_enabled || false;
                    document.getElementById('telegram_chat_id').value = prefs.notifications.telegram_chat_id || '';
                    document.getElementById('discord_enabled').checked = prefs.notifications.discord_enabled || false;
                    document.getElementById('discord_webhook').value = prefs.notifications.discord_webhook || '';

                    toggleTelegramConfig();
                    toggleDiscordConfig();
                }

                // Load weather preferences
                if (prefs.weather) {
                    document.getElementById('temperature_unit').value = prefs.weather.temperature_unit || 'fahrenheit';
                    document.getElementById('wind_speed_unit').value = prefs.weather.wind_speed_unit || 'mph';
                    document.getElementById('timezone').value = prefs.weather.timezone || 'America/New_York';
                    document.getElementById('date_format').value = prefs.weather.date_format || 'US';
                }

                // Load alert settings
                if (prefs.alerts) {
                    document.getElementById('severe_weather_alerts').checked = prefs.alerts.severe_weather_alerts !== false;
                    document.getElementById('temperature_alerts').checked = prefs.alerts.temperature_alerts !== false;
                    document.getElementById('precipitation_alerts').checked = prefs.alerts.precipitation_alerts || false;
                    document.getElementById('wind_alerts').checked = prefs.alerts.wind_alerts || false;
                }
            }
        } catch (error) {
            console.error('Failed to load preferences:', error);
        }
    }
</script>

{{template "footer" .}}
