<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather - Initializing</title>
    <link rel="stylesheet" href="/static/css/dracula.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>‚òï</text></svg>">
    <style>
        .coffee-spinner {
            font-size: 4rem;
            animation: steam 2s ease-in-out infinite;
            text-align: center;
            margin: 2rem 0;
        }

        @keyframes steam {
            0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 1; }
            25% { transform: translateY(-5px) rotate(1deg); opacity: 0.9; }
            50% { transform: translateY(-10px) rotate(0deg); opacity: 0.8; }
            75% { transform: translateY(-5px) rotate(-1deg); opacity: 0.9; }
        }

        .loading-dots {
            display: inline-block;
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }

        .loading-dots::after {
            content: '';
            animation: dots 1.5s steps(4, end) infinite;
        }

        .status-info {
            background-color: var(--dracula-current-line);
            border-radius: 0.5rem;
            padding: 1rem;
            margin: 1rem 0;
            text-align: center;
        }

        .retry-countdown {
            color: var(--dracula-orange);
            font-weight: bold;
            font-size: 1.2rem;
        }
    </style>
</head>
<body>
    <div class="weather-container">
        <div class="weather-header">
            ‚òï Weather
        </div>

        <div style="text-align: center; margin: 3rem 0;">
            <div class="coffee-spinner">‚òï</div>

            <h2 style="color: var(--dracula-cyan); margin: 1rem 0;">
                Warming up the weather service<span class="loading-dots"></span>
            </h2>

            <div class="status-info">
                <div style="color: var(--dracula-yellow); margin: 0.5rem 0;">
                    üåç Loading global location database...
                </div>
                <div style="color: var(--dracula-green); margin: 0.5rem 0;">
                    üå§Ô∏è Connecting to weather services...
                </div>
                <div style="color: var(--dracula-purple); margin: 0.5rem 0;">
                    üé® Preparing beautiful interfaces...
                </div>
            </div>

            <div style="margin: 2rem 0;">
                <p class="text-comment">
                    The service is initializing. This usually takes a few moments while we load
                    weather data and location databases.
                </p>

                <div style="margin: 1.5rem 0;">
                    <span style="color: var(--dracula-cyan);">Next check in:</span>
                    <span id="countdown" class="retry-countdown">30</span>
                    <span style="color: var(--dracula-cyan);">seconds</span>
                    <div style="color: var(--dracula-comment); font-size: 0.875rem; margin-top: 0.5rem;">
                        (Auto-checking every 15 seconds)
                    </div>
                </div>

                <button id="retry-btn" class="search-button" style="margin: 1rem 0;">
                    üîÑ Try Again Now
                </button>
            </div>

            <div style="margin: 2rem 0; padding: 1rem; background-color: var(--dracula-bg); border-radius: 0.375rem;">
                <h4 style="color: var(--dracula-orange); margin-top: 0;">While You Wait...</h4>
                <p style="color: var(--dracula-foreground); font-size: 0.875rem; line-height: 1.6;">
                    This service provides beautiful ASCII weather art for terminals and responsive web interfaces.
                    Try these console commands once it's ready:
                </p>
                <div style="font-family: monospace; background: var(--dracula-current-line); padding: 0.75rem; border-radius: 0.25rem; margin: 0.75rem 0; overflow-x: auto;">
                    <div style="color: var(--dracula-cyan); white-space: nowrap;">curl -q -LSs {{.HostInfo.FullHost}}/London,GB?format=3</div>
                    <div style="color: var(--dracula-pink); white-space: nowrap;">curl -q -LSs {{.HostInfo.FullHost}}/moon/Tokyo,JP</div>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>Loading weather service ‚Ä¢ Please wait while we initialize...</p>
        </div>
    </div>

    <script>
        let countdown = 30;  // Wait 30 seconds before first check
        let countdownInterval;
        let healthCheckInterval;
        let firstCheckDone = false;

        function updateCountdown() {
            document.getElementById('countdown').textContent = Math.max(countdown, 0);
            countdown--;

            if (countdown < 0) {
                clearInterval(countdownInterval);
                retryConnection();
            }
        }

        function startCountdown(seconds) {
            // Clear any existing interval
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }
            countdown = seconds;
            // Start new countdown
            countdownInterval = setInterval(updateCountdown, 1000);
        }

        function checkHealth() {
            console.log('Checking service health...');

            fetch('/healthz')
                .then(response => response.json())
                .then(data => {
                    console.log('Health check:', data);

                    // Check if service is ready
                    if (data.ready === true) {
                        console.log('‚úÖ Service ready! Redirecting...');

                        // Clear all intervals
                        if (countdownInterval) clearInterval(countdownInterval);
                        if (healthCheckInterval) clearInterval(healthCheckInterval);

                        // Redirect to the originally requested URL or homepage
                        const urlParams = new URLSearchParams(window.location.search);
                        const redirectUrl = urlParams.get('redirect') || '/';
                        window.location.href = redirectUrl;
                    } else {
                        console.log('‚è≥ Service still initializing:', data.initialization);

                        // After first check, start periodic checks every 15 seconds
                        if (!firstCheckDone) {
                            firstCheckDone = true;
                            if (healthCheckInterval) clearInterval(healthCheckInterval);
                            healthCheckInterval = setInterval(checkHealth, 15000); // Check every 15 seconds
                            startCountdown(15); // Reset countdown to 15 seconds
                        }
                    }
                })
                .catch(error => {
                    console.log('‚ùå Health check failed:', error.message);

                    // After first check, start periodic checks even if failed
                    if (!firstCheckDone) {
                        firstCheckDone = true;
                        if (healthCheckInterval) clearInterval(healthCheckInterval);
                        healthCheckInterval = setInterval(checkHealth, 15000);
                        startCountdown(15);
                    }
                });
        }

        function retryConnection() {
            console.log('Retrying connection...');

            // Clear countdown interval
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }

            // Show loading state
            const retryBtn = document.getElementById('retry-btn');
            retryBtn.textContent = '‚òï Checking...';
            retryBtn.disabled = true;

            // Check if service is ready
            fetch('/healthz')
                .then(response => response.json())
                .then(data => {
                    if (data.ready === true) {
                        // Service is ready, redirect to main page
                        console.log('‚úÖ Service ready, redirecting...');

                        // Clear all intervals
                        if (healthCheckInterval) clearInterval(healthCheckInterval);

                        const urlParams = new URLSearchParams(window.location.search);
                        const redirectUrl = urlParams.get('redirect') || '/';
                        window.location.href = redirectUrl;
                    } else {
                        throw new Error(`Service not ready: ${JSON.stringify(data.initialization)}`);
                    }
                })
                .catch(error => {
                    console.log('‚è≥ Service still initializing:', error.message);

                    // Reset countdown and try again after 15 seconds
                    retryBtn.textContent = 'üîÑ Try Again Now';
                    retryBtn.disabled = false;

                    // Restart countdown with 15 seconds
                    startCountdown(15);
                });
        }

        // Start initial countdown (30 seconds before first check)
        startCountdown(30);

        // Manual retry button
        document.getElementById('retry-btn').addEventListener('click', function() {
            retryConnection();
        });

        // Do first health check after 30 seconds
        setTimeout(checkHealth, 30000);
    </script>
</body>
</html>
