<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üåç Earthquake Monitor - Weather</title>
    <link rel="stylesheet" href="/static/css/dracula.css">
    <script src="/static/js/app.js" defer></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
    {{template "navbar" .}}

    <div class="weather-container">

        <!-- Location Search Form -->
        <form id="earthquake-form" style="margin: 1rem 0; width: 100%;">
            <div style="display: flex; flex-direction: column; gap: 0.75rem; width: 100%;">
                <div style="display: flex; gap: 0.5rem; width: 100%;">
                    <input type="text" name="location" id="eq-location-input" placeholder="üîç Search location..."
                           value="{{.Location}}" autocomplete="off"
                           style="flex: 1; padding: 0.75rem 1rem; font-size: 1rem; border: 1px solid var(--dracula-current-line); border-radius: 0.375rem; background-color: var(--dracula-bg); color: var(--dracula-fg);">
                    <select name="feed" style="padding: 0.75rem 1rem; font-size: 1rem; border: 1px solid var(--dracula-current-line); border-radius: 0.375rem; background-color: var(--dracula-bg); color: var(--dracula-fg);">
                        <option value="all_hour" {{if eq .FeedType "all_hour"}}selected{{end}}>Past Hour</option>
                        <option value="all_day" {{if eq .FeedType "all_day"}}selected{{end}}>Past Day</option>
                        <option value="all_week" {{if eq .FeedType "all_week"}}selected{{end}}>Past Week</option>
                        <option value="all_month" {{if eq .FeedType "all_month"}}selected{{end}}>Past Month</option>
                        <option value="4.5_day" {{if eq .FeedType "4.5_day"}}selected{{end}}>M4.5+ Day</option>
                        <option value="4.5_week" {{if eq .FeedType "4.5_week"}}selected{{end}}>M4.5+ Week</option>
                        <option value="significant_day" {{if eq .FeedType "significant_day"}}selected{{end}}>Significant Day</option>
                        <option value="significant_week" {{if eq .FeedType "significant_week"}}selected{{end}}>Significant Week</option>
                    </select>
                    <select name="sort" style="padding: 0.75rem 1rem; font-size: 1rem; border: 1px solid var(--dracula-current-line); border-radius: 0.375rem; background-color: var(--dracula-bg); color: var(--dracula-fg);">
                        <option value="newest">Newest First</option>
                        <option value="oldest">Oldest First</option>
                        <option value="magnitude">By Magnitude</option>
                        <option value="depth">By Depth</option>
                    </select>
                    <input type="number" name="number" placeholder="Limit (0=all)" min="0" value="{{.Number}}"
                           style="padding: 0.75rem 1rem; font-size: 1rem; border: 1px solid var(--dracula-current-line); border-radius: 0.375rem; background-color: var(--dracula-bg); color: var(--dracula-fg); width: 150px;">
                </div>
                {{if .Location}}
                <input type="number" name="radius" placeholder="Radius (km)" value="{{.Radius}}" min="100" max="20000"
                       style="padding: 0.75rem 1rem; font-size: 1rem; border: 1px solid var(--dracula-current-line); border-radius: 0.375rem; background-color: var(--dracula-bg); color: var(--dracula-fg);">
                {{end}}
                <div style="display: flex; gap: 0.5rem; width: 100%;">
                    <button type="submit" class="search-button" style="flex: 1;">
                        üåç Search Earthquakes
                    </button>
                    {{if .Location}}
                    <a href="/earthquake?feed={{.FeedType}}" class="search-button" style="flex: 1; text-align: center; line-height: 2.5rem; text-decoration: none;">
                        üó∫Ô∏è View All
                    </a>
                    {{end}}
                </div>
            </div>
        </form>

        <!-- Statistics -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin: 1.5rem 0;">
            <div style="background: var(--dracula-bg); padding: 1.5rem; border-radius: 0.5rem; border: 1px solid var(--dracula-current-line); text-align: center;">
                <div style="font-size: 2rem; font-weight: bold; color: var(--dracula-cyan);">{{len .Earthquakes}}</div>
                <div style="color: var(--dracula-comment); margin-top: 0.5rem;">Total Earthquakes</div>
            </div>
            <div style="background: var(--dracula-bg); padding: 1.5rem; border-radius: 0.5rem; border: 1px solid var(--dracula-current-line); text-align: center;">
                <div style="font-size: 2rem; font-weight: bold; color: var(--dracula-orange);">
                    {{$maxMag := 0.0}}
                    {{range .Earthquakes}}
                        {{if gt .Magnitude $maxMag}}{{$maxMag = .Magnitude}}{{end}}
                    {{end}}
                    {{printf "%.1f" $maxMag}}
                </div>
                <div style="color: var(--dracula-comment); margin-top: 0.5rem;">Largest Magnitude</div>
            </div>
            <div style="background: var(--dracula-bg); padding: 1.5rem; border-radius: 0.5rem; border: 1px solid var(--dracula-current-line); text-align: center;">
                <div style="font-size: 2rem; font-weight: bold; color: var(--dracula-purple);">
                    {{$tsunami := 0}}
                    {{range .Earthquakes}}
                        {{if eq .Tsunami 1}}{{$tsunami = 1}}{{end}}
                    {{end}}
                    {{if gt $tsunami 0}}‚ö†Ô∏è{{else}}‚úì{{end}}
                </div>
                <div style="color: var(--dracula-comment); margin-top: 0.5rem;">Tsunami Warnings</div>
            </div>
        </div>

        <!-- Interactive Map -->
        <div id="map" style="height: 600px; width: 100%; border-radius: 0.5rem; border: 1px solid var(--dracula-current-line); margin: 1.5rem 0;"></div>

        <!-- Earthquake List -->
        <div style="margin-top: 1.5rem;">
            <h2 style="color: var(--dracula-cyan);">Recent Earthquakes</h2>
            <div style="max-height: 600px; overflow-y: auto;">
                {{range .Earthquakes}}
                <div onclick="focusEarthquake({{.Latitude}}, {{.Longitude}})" class="earthquake-item"
                     style="background: var(--dracula-bg); padding: 1rem; margin: 0.5rem 0; border-radius: 0.5rem; border-left: 4px solid {{if eq .Tsunami 1}}var(--dracula-cyan){{else if lt .Magnitude 2.0}}var(--dracula-green){{else if lt .Magnitude 4.0}}var(--dracula-yellow){{else if lt .Magnitude 5.0}}var(--dracula-orange){{else}}var(--dracula-red){{end}}; cursor: pointer; transition: all 0.3s; position: relative;">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <span style="display: inline-block; width: 3rem; height: 3rem; border-radius: 50%; text-align: center; line-height: 3rem; font-weight: bold; background-color: {{if lt .Magnitude 2.0}}var(--dracula-green){{else if lt .Magnitude 4.0}}var(--dracula-yellow){{else if lt .Magnitude 5.0}}var(--dracula-orange){{else if lt .Magnitude 6.0}}var(--dracula-red){{else}}var(--dracula-purple){{end}};">
                            {{printf "%.1f" .Magnitude}}
                        </span>
                        <div style="flex: 1;">
                            <strong style="color: var(--dracula-fg);">{{.Place}}</strong>
                            {{if eq .Tsunami 1}}<span style="color: var(--dracula-cyan); margin-left: 0.5rem;">üåä TSUNAMI</span>{{end}}
                            <div style="color: var(--dracula-comment); margin-top: 0.25rem; font-size: 0.875rem;">
                                {{.Time.Format "2006-01-02 15:04:05"}} ‚Ä¢ Depth: {{printf "%.1f" .Depth}}km
                                {{if .Felt}} ‚Ä¢ Felt by {{.Felt}} people{{end}}
                            </div>
                            <div class="eq-details" style="display: none; margin-top: 0.5rem; padding: 0.5rem; background: var(--dracula-current-line); border-radius: 0.25rem; font-size: 0.875rem;">
                                <div><strong>Coordinates:</strong> {{printf "%.4f" .Latitude}}, {{printf "%.4f" .Longitude}}</div>
                                <div><strong>Type:</strong> {{.MagnitudeType}} {{.Type}}</div>
                                <div><strong>Status:</strong> {{.Status}}</div>
                                {{if .CDI}}<div><strong>CDI:</strong> {{printf "%.1f" .CDI}}</div>{{end}}
                                {{if .MMI}}<div><strong>MMI:</strong> {{printf "%.1f" .MMI}}</div>{{end}}
                            </div>
                        </div>
                        <a href="/earthquake/detail/{{.ID}}" onclick="event.stopPropagation();" style="color: var(--dracula-cyan); text-decoration: none; font-weight: 500;">Details ‚Üí</a>
                    </div>
                </div>
                {{else}}
                <p style="text-align: center; color: var(--dracula-comment); padding: 2rem;">No earthquakes found.</p>
                {{end}}
            </div>
        </div>

        {{if .Earthquakes}}
        <!-- Console Commands -->
        <div style="background-color: var(--dracula-bg); padding: 1.5rem; border-radius: 0.5rem; border: 1px solid var(--dracula-current-line); margin-top: 2rem;">
            <h3 style="color: var(--dracula-green); margin-top: 0;">üìü Console Commands</h3>
            <div style="font-family: monospace; font-size: 0.875rem;">
                <div style="margin: 0.75rem 0;">
                    <strong style="color: var(--dracula-green);">All Earthquakes:</strong>
                    <code style="color: var(--dracula-cyan);">curl -s {{.HostInfo.FullHost}}/api/v1/earthquakes?feed={{.FeedType}}</code>
                </div>
                {{if .Location}}
                <div style="margin: 0.75rem 0;">
                    <strong style="color: var(--dracula-green);">Near Location:</strong>
                    <code style="color: var(--dracula-cyan);">curl -s {{.HostInfo.FullHost}}/api/v1/earthquakes?feed={{.FeedType}}</code>
                </div>
                {{end}}
            </div>
        </div>
        {{end}}

        <div class="footer" style="text-align: center; margin-top: 3rem; padding: 2rem 1rem; border-top: 1px solid var(--dracula-current-line); color: var(--dracula-comment);">
            <p style="margin: 0.5rem 0; font-size: 0.875rem;">Data from <a href="https://earthquake.usgs.gov/" target="_blank" style="color: var(--dracula-cyan); text-decoration: none;">USGS Earthquake Hazards Program</a></p>
            <p style="margin: 0; font-size: 0.875rem; display: flex; justify-content: center; align-items: center; gap: 1.5rem;">
                <a href="https://github.com/apimgr/weather" target="_blank" style="color: var(--dracula-cyan); text-decoration: none;">Weather</a>
                <span style="color: var(--dracula-pink);">‚Ä¢</span>
                <span>Made with <span style="color: var(--dracula-red);">‚ù§Ô∏è</span></span>
                <span style="color: var(--dracula-pink);">‚Ä¢</span>
                <a href="/docs" style="color: var(--dracula-green); text-decoration: none;">v2.0.0</a>
            </p>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Auto-fill location with closest earthquake on page load
        window.addEventListener('DOMContentLoaded', function() {
            const earthquakes = [
                {{range .Earthquakes}}
                {
                    lat: {{.Latitude}},
                    lng: {{.Longitude}},
                    mag: {{.Magnitude}},
                    place: "{{.Place}}"
                },
                {{end}}
            ];

            // If no location is set and we have earthquakes, find the closest one
            {{if not .Location}}
            if (earthquakes.length > 0) {
                const centerLat = {{.CenterLat}};
                const centerLon = {{.CenterLon}};

                // Find closest earthquake to user location
                let closest = earthquakes[0];
                let minDist = Number.MAX_VALUE;

                earthquakes.forEach(eq => {
                    const dist = Math.sqrt(Math.pow(eq.lat - centerLat, 2) + Math.pow(eq.lng - centerLon, 2));
                    if (dist < minDist) {
                        minDist = dist;
                        closest = eq;
                    }
                });

                // Extract location from place (e.g., "10 km NE of Albany, NY" -> "Albany, NY")
                let locationName = closest.place;
                const match = locationName.match(/(?:of|near)\s+([^,]+(?:,\s*[^,]+)?)/i);
                if (match) {
                    locationName = match[1].trim();
                }

                // Set the input value
                document.getElementById('eq-location-input').placeholder = 'üîç ' + locationName + ' (closest)';
            }
            {{end}}
        });

        // Initialize map
        const map = L.map('map').setView([{{.CenterLat}}, {{.CenterLon}}], {{if .Location}}6{{else}}2{{end}});

        // Add tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors',
            maxZoom: 18
        }).addTo(map);

        // Add earthquakes to map
        const earthquakes = [
            {{range .Earthquakes}}
            {
                lat: {{.Latitude}},
                lng: {{.Longitude}},
                mag: {{.Magnitude}},
                place: "{{.Place}}",
                time: "{{.Time.Format "2006-01-02 15:04:05"}}",
                depth: {{.Depth}},
                tsunami: {{.Tsunami}},
                url: "{{.URL}}"
            },
            {{end}}
        ];

        const markers = [];
        earthquakes.forEach(eq => {
            // Size marker based on magnitude
            const size = Math.max(5, eq.mag * 4);
            const color = eq.mag < 2 ? '#50fa7b' :
                         eq.mag < 4 ? '#f1fa8c' :
                         eq.mag < 5 ? '#ffb86c' :
                         eq.mag < 6 ? '#ff5555' : '#bd93f9';

            const marker = L.circleMarker([eq.lat, eq.lng], {
                radius: size,
                fillColor: color,
                color: '#f8f8f2',
                weight: 2,
                opacity: 0.8,
                fillOpacity: 0.6
            }).addTo(map);

            // Popup content
            const popupContent = `
                <div style="color: #282a36; font-family: sans-serif;">
                    <strong style="font-size: 1.2em;">M ${eq.mag.toFixed(1)}</strong><br>
                    ${eq.place}<br>
                    <span style="font-size: 0.9em;">${eq.time}</span><br>
                    Depth: ${eq.depth.toFixed(1)}km
                    ${eq.tsunami ? '<br><strong style="color: #8be9fd;">üåä TSUNAMI WARNING</strong>' : ''}
                    <br><a href="${eq.url}" target="_blank" style="color: #8be9fd;">View Details</a>
                </div>
            `;
            marker.bindPopup(popupContent);
            markers.push(marker);
        });

        // Fit map to show all earthquake markers when location is searched
        {{if .Location}}
        if (markers.length > 0) {
            const group = L.featureGroup(markers);
            map.fitBounds(group.getBounds().pad(0.1));
        }
        {{end}}

        // Function to focus on earthquake
        function focusEarthquake(lat, lng) {
            map.setView([lat, lng], 8);
        }

        // Toggle details on click
        document.querySelectorAll('.earthquake-item').forEach(item => {
            item.addEventListener('click', function(e) {
                const details = this.querySelector('.eq-details');
                if (details) {
                    details.style.display = details.style.display === 'none' ? 'block' : 'none';
                }
            });

            // Hover effect
            item.addEventListener('mouseenter', function() {
                this.style.transform = 'translateX(5px)';
                this.style.boxShadow = '0 4px 12px rgba(139, 233, 253, 0.3)';
            });

            item.addEventListener('mouseleave', function() {
                this.style.transform = 'translateX(0)';
                this.style.boxShadow = 'none';
            });
        });

        // Auto-refresh every 5 minutes
        setTimeout(() => location.reload(), 300000);

        // Initialize notification polling
        if (typeof Notifications !== 'undefined') {
            Notifications.startPolling(30000);
        }
    </script>
</body>
</html>
