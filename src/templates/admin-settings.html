<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.title}} - {{.server.Title}}</title>
    <link rel="stylesheet" href="/static/css/dracula.css">
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="nav-left">
            <a href="/" class="nav-brand">üå§Ô∏è {{.server.Title}}</a>
            <a href="/user/dashboard" class="nav-link">Dashboard</a>
            <a href="/admin" class="nav-link">Admin</a>
        </div>
        <div class="nav-right">
            <button class="icon-button" onclick="Notifications.fetch()">
                <span class="notification-bell">üîî</span>
                <span class="notification-badge" id="notificationBadge" class="display-none">0</span>
            </button>
            <div class="profile-avatar">{{ index .user.Email 0 | printf "%c" | upper }}</div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container">
        <div class="admin-header">
            <h1>‚öôÔ∏è Server Settings</h1>
            <p class="subtitle">Configure your weather service</p>
        </div>

        <!-- Settings Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchSettingsTab('server')">üè† Server</button>
            <button class="tab" onclick="switchSettingsTab('security')">üîí Security</button>
            <button class="tab" onclick="switchSettingsTab('features')">‚ú® Features</button>
            <button class="tab" onclick="switchSettingsTab('backup')">üíæ Backup</button>
            <button class="tab" onclick="switchSettingsTab('logging')">üìù Logging</button>
        </div>

        <!-- Server Tab -->
        <div id="tab-server" class="tab-content active">
            <div class="card">
                <h2>Server Branding</h2>
                <form id="form-server-branding" onsubmit="saveSettings(event, 'server-branding')">
                    <div class="form-group">
                        <label for="server_title">Server Title</label>
                        <input type="text" id="server_title" name="server.title" value="{{.settings.server_title}}" placeholder="Weather Service">
                        <small>Displayed in the header and page titles</small>
                    </div>

                    <div class="form-group">
                        <label for="server_tagline">Tagline</label>
                        <input type="text" id="server_tagline" name="server.tagline" value="{{.settings.server_tagline}}" placeholder="Your personal weather dashboard">
                        <small>Short subtitle shown under the title</small>
                    </div>

                    <div class="form-group">
                        <label for="server_description">Description</label>
                        <textarea id="server_description" name="server.description" rows="3" placeholder="A comprehensive platform for weather forecasts...">{{.settings.server_description}}</textarea>
                        <small>Full description for about page and meta tags</small>
                    </div>

                    <button type="submit" class="btn btn-primary">Save Branding</button>
                </form>
            </div>

            <div class="card">
                <h2>Server Configuration</h2>
                <form id="form-server-config" onsubmit="saveSettings(event, 'server-config')">
                    <div class="form-group">
                        <label for="server_http_port">HTTP Port</label>
                        <input type="number" id="server_http_port" name="server.http_port" value="{{.settings.server_http_port}}" min="1" max="65535">
                        <small>Port for HTTP connections (requires restart)</small>
                    </div>

                    <div class="form-group">
                        <label for="server_https_port">HTTPS Port</label>
                        <input type="number" id="server_https_port" name="server.https_port" value="{{.settings.server_https_port}}" min="0" max="65535">
                        <small>Port for HTTPS connections (0 to disable, requires restart)</small>
                    </div>

                    <div class="form-group">
                        <label for="server_timezone">Server Timezone</label>
                        <select id="server_timezone" name="server.timezone">
                            <option value="America/New_York" {{if eq .settings.server_timezone "America/New_York"}}selected{{end}}>America/New_York (EST/EDT)</option>
                            <option value="America/Chicago" {{if eq .settings.server_timezone "America/Chicago"}}selected{{end}}>America/Chicago (CST/CDT)</option>
                            <option value="America/Denver" {{if eq .settings.server_timezone "America/Denver"}}selected{{end}}>America/Denver (MST/MDT)</option>
                            <option value="America/Los_Angeles" {{if eq .settings.server_timezone "America/Los_Angeles"}}selected{{end}}>America/Los_Angeles (PST/PDT)</option>
                            <option value="Europe/London" {{if eq .settings.server_timezone "Europe/London"}}selected{{end}}>Europe/London (GMT/BST)</option>
                            <option value="Europe/Paris" {{if eq .settings.server_timezone "Europe/Paris"}}selected{{end}}>Europe/Paris (CET/CEST)</option>
                            <option value="Asia/Tokyo" {{if eq .settings.server_timezone "Asia/Tokyo"}}selected{{end}}>Asia/Tokyo (JST)</option>
                            <option value="UTC" {{if eq .settings.server_timezone "UTC"}}selected{{end}}>UTC</option>
                        </select>
                        <small>Default timezone for the server</small>
                    </div>

                    <div class="form-group">
                        <label for="server_date_format">Date Format</label>
                        <select id="server_date_format" name="server.date_format">
                            <option value="US" {{if eq .settings.server_date_format "US"}}selected{{end}}>US (Jan 1, 2024)</option>
                            <option value="EU" {{if eq .settings.server_date_format "EU"}}selected{{end}}>EU (1 Jan 2024)</option>
                            <option value="ISO" {{if eq .settings.server_date_format "ISO"}}selected{{end}}>ISO (2024-01-01)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="server_time_format">Time Format</label>
                        <select id="server_time_format" name="server.time_format">
                            <option value="12-hour" {{if eq .settings.server_time_format "12-hour"}}selected{{end}}>12-hour (3:30 PM)</option>
                            <option value="24-hour" {{if eq .settings.server_time_format "24-hour"}}selected{{end}}>24-hour (15:30)</option>
                        </select>
                    </div>

                    <button type="submit" class="btn btn-primary">Save Configuration</button>
                </form>
            </div>
        </div>

        <!-- Security Tab -->
        <div id="tab-security" class="tab-content">
            <div class="card">
                <h2>Authentication & Sessions</h2>
                <form id="form-security" onsubmit="saveSettings(event, 'security')">
                    <div class="form-group">
                        <label for="security_session_timeout">Session Timeout (seconds)</label>
                        <input type="number" id="security_session_timeout" name="security.session_timeout" value="{{.settings.security_session_timeout}}" min="60">
                        <small>Default: 2592000 (30 days)</small>
                    </div>

                    <div class="form-group">
                        <label for="security_max_login_attempts">Max Login Attempts</label>
                        <input type="number" id="security_max_login_attempts" name="security.max_login_attempts" value="{{.settings.security_max_login_attempts}}" min="1">
                    </div>

                    <div class="form-group">
                        <label for="security_lockout_duration">Lockout Duration (minutes)</label>
                        <input type="number" id="security_lockout_duration" name="security.lockout_duration" value="{{.settings.security_lockout_duration}}" min="1">
                    </div>

                    <div class="form-group">
                        <label for="security_password_min_length">Minimum Password Length</label>
                        <input type="number" id="security_password_min_length" name="security.password_min_length" value="{{.settings.security_password_min_length}}" min="6">
                    </div>

                    <button type="submit" class="btn btn-primary">Save Security Settings</button>
                </form>
            </div>
        </div>

        <!-- Features Tab -->
        <div id="tab-features" class="tab-content">
            <div class="card">
                <h2>Feature Toggles</h2>
                <form id="form-features" onsubmit="saveSettings(event, 'features')">
                    <div class="form-group">
                        <label class="toggle-label">
                            <input type="checkbox" name="features.registration_enabled" {{if .settings.features_registration_enabled}}checked{{end}}>
                            <span class="toggle-slider"></span>
                            <span class="toggle-text">User Registration Enabled</span>
                        </label>
                        <small>Allow new users to register</small>
                    </div>

                    <div class="form-group">
                        <label class="toggle-label">
                            <input type="checkbox" name="features.api_enabled" {{if .settings.features_api_enabled}}checked{{end}}>
                            <span class="toggle-slider"></span>
                            <span class="toggle-text">API Access Enabled</span>
                        </label>
                        <small>Enable JSON API endpoints</small>
                    </div>

                    <div class="form-group">
                        <label class="toggle-label">
                            <input type="checkbox" name="features.weather_alerts" {{if .settings.features_weather_alerts}}checked{{end}}>
                            <span class="toggle-slider"></span>
                            <span class="toggle-text">Weather Alerts Enabled</span>
                        </label>
                        <small>Enable weather alert notifications</small>
                    </div>

                    <button type="submit" class="btn btn-primary">Save Feature Settings</button>
                </form>
            </div>
        </div>

        <!-- Backup Tab -->
        <div id="tab-backup" class="tab-content">
            <div class="card">
                <h2>Backup Configuration</h2>
                <form id="form-backup" onsubmit="saveSettings(event, 'backup')">
                    <div class="form-group">
                        <label class="toggle-label">
                            <input type="checkbox" name="backup.enabled" {{if .settings.backup_enabled}}checked{{end}}>
                            <span class="toggle-slider"></span>
                            <span class="toggle-text">Automatic Backups Enabled</span>
                        </label>
                    </div>

                    <div class="form-group">
                        <label for="backup_interval">Backup Interval (hours)</label>
                        <input type="number" id="backup_interval" name="backup.interval" value="{{.settings.backup_interval}}" min="1">
                    </div>

                    <div class="form-group">
                        <label for="backup_retention">Backup Retention (days)</label>
                        <input type="number" id="backup_retention" name="backup.retention" value="{{.settings.backup_retention}}" min="1">
                    </div>

                    <div class="form-group">
                        <label for="backup_location">Backup Location</label>
                        <input type="text" id="backup_location" name="backup.location" value="{{.settings.backup_location}}">
                    </div>

                    <button type="submit" class="btn btn-primary">Save Backup Settings</button>
                </form>
            </div>
        </div>

        <!-- Logging Tab -->
        <div id="tab-logging" class="tab-content">
            <div class="card">
                <h2>Logging Configuration</h2>
                <form id="form-logging" onsubmit="saveSettings(event, 'logging')">
                    <div class="form-group">
                        <label for="logging_level">Log Level</label>
                        <select id="logging_level" name="logging.level">
                            <option value="debug" {{if eq .settings.logging_level "debug"}}selected{{end}}>Debug</option>
                            <option value="info" {{if eq .settings.logging_level "info"}}selected{{end}}>Info</option>
                            <option value="warn" {{if eq .settings.logging_level "warn"}}selected{{end}}>Warning</option>
                            <option value="error" {{if eq .settings.logging_level "error"}}selected{{end}}>Error</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="logging_format">Log Format</label>
                        <select id="logging_format" name="logging.format">
                            <option value="json" {{if eq .settings.logging_format "json"}}selected{{end}}>JSON</option>
                            <option value="text" {{if eq .settings.logging_format "text"}}selected{{end}}>Text</option>
                            <option value="apache" {{if eq .settings.logging_format "apache"}}selected{{end}}>Apache Combined</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="toggle-label">
                            <input type="checkbox" name="logging.access_log" {{if .settings.logging_access_log}}checked{{end}}>
                            <span class="toggle-slider"></span>
                            <span class="toggle-text">Access Log Enabled</span>
                        </label>
                    </div>

                    <div class="form-group">
                        <label class="toggle-label">
                            <input type="checkbox" name="logging.error_log" {{if .settings.logging_error_log}}checked{{end}}>
                            <span class="toggle-slider"></span>
                            <span class="toggle-text">Error Log Enabled</span>
                        </label>
                    </div>

                    <div class="form-group">
                        <label class="toggle-label">
                            <input type="checkbox" name="logging.audit_log" {{if .settings.logging_audit_log}}checked{{end}}>
                            <span class="toggle-slider"></span>
                            <span class="toggle-text">Audit Log Enabled</span>
                        </label>
                    </div>

                    <div class="form-group">
                        <label for="logging_rotation_days">Log Rotation (days)</label>
                        <input type="number" id="logging_rotation_days" name="logging.rotation_days" value="{{.settings.logging_rotation_days}}" min="1">
                    </div>

                    <button type="submit" class="btn btn-primary">Save Logging Settings</button>
                </form>
            </div>
        </div>
    </main>

    <!-- Scripts -->
    <script src="/static/js/app.js"></script>
    <script>
        // Tab switching
        function switchSettingsTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            document.getElementById('tab-' + tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // Save settings
        async function saveSettings(event, category) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const settings = {};

            // Convert form data to settings object
            for (let [key, value] of formData.entries()) {
                if (form.elements[key].type === 'checkbox') {
                    settings[key] = form.elements[key].checked;
                } else {
                    settings[key] = value;
                }
            }

            try {
                // Send multiple settings updates
                for (let [key, value] of Object.entries(settings)) {
                    const response = await fetch(`/api/v1/admin/settings/${key}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ value: value })
                    });

                    if (!response.ok) {
                        throw new Error(`Failed to update ${key}`);
                    }
                }

                Toast.success(`${category} settings saved successfully`);

                // Reload page after a delay to show new settings
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } catch (error) {
                Toast.error('Failed to save settings: ' + error.message);
                console.error('Error saving settings:', error);
            }
        }

        // Initialize notifications
        document.addEventListener('DOMContentLoaded', function() {
            Notifications.fetch();
            Notifications.startPolling(60000); // Poll every minute
        });
    </script>
</body>
</html>
