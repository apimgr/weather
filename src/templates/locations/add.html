<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ .title }}</title>
    <link rel="stylesheet" href="/static/css/dracula.css">
    <script src="/static/js/app.js" defer></script>
</head>
<body>
    <!-- Unified Navigation Bar -->
    <nav class="navbar">
        <div class="navbar-container">
            <a href="/" class="navbar-brand">
                üå§Ô∏è Weather Service
            </a>
            <div class="navbar-menu">
                <a href="/" class="navbar-link">Weather</a>
                <a href="/moon" class="navbar-link">Moon</a>
                <a href="/earthquake" class="navbar-link">Earthquakes</a>
                <a href="/hurricane" class="navbar-link">Hurricanes</a>
                <a href="/user/dashboard" class="navbar-link active">Dashboard</a>
                {{ if eq .user.Role "admin" }}
                <a href="/admin" class="navbar-link">Admin</a>
                {{ end }}
            </div>
            <div class="navbar-actions">
                <button class="notification-bell" onclick="window.location.href='/notifications'" title="Notifications">
                    üîî
                    <span class="notification-badge" id="notification-badge">0</span>
                </button>
                <div class="profile-avatar">
                    <div class="avatar" onclick="Dropdown.toggle('profile-dropdown', 'profile-avatar')" id="profile-avatar">
                        {{ if .user.Email }}
                            {{ index .user.Email 0 | printf "%c" | upper }}
                        {{ else }}
                            U
                        {{ end }}
                    </div>
                    <div class="profile-dropdown" id="profile-dropdown">
                        <div class="profile-dropdown-header">
                            <div>{{ .user.Email }}</div>
                            <div class="profile-dropdown-role">{{ .user.Role }}</div>
                        </div>
                        <nav class="profile-dropdown-menu">
                            <a href="/user/preferences" class="profile-dropdown-item">‚öôÔ∏è Preferences</a>
                            <a href="/notifications" class="profile-dropdown-item">üîî Notifications</a>
                            <a href="/docs" class="profile-dropdown-item">üìö API Docs</a>
                            <a href="/logout" class="profile-dropdown-item">üö™ Logout</a>
                        </nav>
                    </div>
                </div>
                <button class="navbar-toggle" onclick="MobileMenu.toggle()" aria-label="Menu">
                    ‚ò∞
                </button>
            </div>
        </div>
        <div class="navbar-menu-mobile">
            <a href="/" class="navbar-link">Weather</a>
            <a href="/moon" class="navbar-link">Moon</a>
            <a href="/earthquake" class="navbar-link">Earthquakes</a>
            <a href="/hurricane" class="navbar-link">Hurricanes</a>
            <a href="/user/dashboard" class="navbar-link active">Dashboard</a>
            {{ if eq .user.Role "admin" }}
            <a href="/admin" class="navbar-link">Admin</a>
            {{ end }}
        </div>
    </nav>

    <div class="weather-container location-manager">
        <div class="location-manager__header">
            <h1 class="text-purple">Add New Location</h1>
            <a href="/user/dashboard" class="back-link">‚Üê Back to Dashboard</a>
        </div>

        <div class="card">
            <div class="card-body">
                <div id="message"></div>

                <!-- GPS Button -->
                <button class="btn btn-secondary gps-button" onclick="useCurrentLocation()">
                    üìç Use My Current Location
                </button>

                <!-- Tabs -->
                <div class="location-tabs">
                    <button class="location-tab active" onclick="switchTab(event, 'search')">üîç Search</button>
                    <button class="location-tab" onclick="switchTab(event, 'zip')">üìÆ ZIP Code</button>
                    <button class="location-tab" onclick="switchTab(event, 'coords')">üó∫Ô∏è Coordinates</button>
                </div>

                <!-- Search Tab -->
                <div id="search-tab" class="location-tab-content active">
                    <div class="form-group">
                        <label class="form-label">Search for a City</label>
                        <input type="text"
                               id="citySearch"
                               class="form-input"
                               placeholder="e.g., New York, London, Tokyo..."
                               oninput="searchCities(this.value)">
                        <p class="form-help">Start typing to search for cities worldwide</p>
                    </div>

                    <div class="search-results">
                        <div id="searchResults" class="results-dropdown"></div>
                    </div>
                </div>

                <!-- ZIP Code Tab -->
                <div id="zip-tab" class="location-tab-content">
                    <div class="form-group">
                        <label class="form-label">ZIP / Postal Code</label>
                        <input type="text"
                               id="zipCode"
                               class="form-input"
                               placeholder="e.g., 10001, SW1A 1AA, 75001">
                        <p class="form-help">Enter a US ZIP code or international postal code</p>
                    </div>
                    <button class="btn btn-primary" onclick="lookupZipCode()">Look Up Location</button>
                </div>

                <!-- Coordinates Tab -->
                <div id="coords-tab" class="location-tab-content">
                    <div class="form-group">
                        <label class="form-label">Latitude</label>
                        <input type="number"
                               id="manualLat"
                               class="form-input"
                               step="0.000001"
                               min="-90"
                               max="90"
                               placeholder="40.7128">
                        <p class="form-help">Between -90 and 90</p>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Longitude</label>
                        <input type="number"
                               id="manualLon"
                               class="form-input"
                               step="0.000001"
                               min="-180"
                               max="180"
                               placeholder="-74.0060">
                        <p class="form-help">Between -180 and 180</p>
                    </div>
                    <button class="btn btn-primary" onclick="lookupCoordinates()">Look Up Location</button>
                </div>

                <!-- Location Form (shown after selection) -->
                <form id="locationForm" class="location-confirm-form hidden">
                    <h3 class="text-cyan mb-md">Confirm Location Details</h3>

                    <div class="form-group">
                        <label class="form-label">Location Name</label>
                        <input type="text" id="name" class="form-input" required placeholder="e.g., Home, Office">
                        <p class="form-help">Give this location a memorable name</p>
                    </div>

                    <div class="form-group">
                        <label class="form-label">City</label>
                        <input type="text" id="displayCity" class="form-input" readonly>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Coordinates</label>
                        <input type="text" id="displayCoords" class="form-input" readonly>
                    </div>

                    <input type="hidden" id="latitude" name="latitude">
                    <input type="hidden" id="longitude" name="longitude">
                    <input type="hidden" id="timezone" name="timezone">

                    <div class="flex gap-md mt-lg">
                        <button type="submit" class="btn btn-primary">üíæ Save Location</button>
                        <button type="button" class="btn btn-secondary" onclick="resetForm()">üîÑ Start Over</button>
                        <button type="button" class="btn btn-ghost" onclick="window.location.href='/user/dashboard'">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        let searchTimeout;
        let selectedLocation = null;

        function switchTab(event, tabName) {
            // Hide all tabs
            document.querySelectorAll('.location-tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.location-tab').forEach(tab => tab.classList.remove('active'));

            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');

            // Reset form
            resetForm();
        }

        function searchCities(query) {
            clearTimeout(searchTimeout);

            if (query.length < 2) {
                document.getElementById('searchResults').classList.remove('active');
                return;
            }

            searchTimeout = setTimeout(async () => {
                try {
                    const response = await fetch(`/api/v1/locations/search?q=${encodeURIComponent(query)}`);
                    const results = await response.json();

                    displaySearchResults(results);
                } catch (error) {
                    console.error('Search failed:', error);
                }
            }, 300);
        }

        function displaySearchResults(results) {
            const container = document.getElementById('searchResults');

            if (!results || results.length === 0) {
                container.innerHTML = '<div class="result-item">No results found</div>';
                container.classList.add('active');
                return;
            }

            container.innerHTML = results.map(result => `
                <div class="result-item" onclick='selectLocation(${JSON.stringify(result)})'>
                    <div class="result-city">${result.name}</div>
                <div class="result-details">
                        ${result.admin1 ? result.admin1 + ', ' : ''}${result.country}
                        <span class="result-coords">‚Ä¢ ${result.latitude.toFixed(4)}, ${result.longitude.toFixed(4)}</span>
                    </div>
                </div>
            `).join('');

            container.classList.add('active');
        }

        function selectLocation(location) {
            selectedLocation = location;
            document.getElementById('searchResults').classList.remove('active');

            // Fill in the form
            document.getElementById('name').value = location.name;
            document.getElementById('displayCity').value = `${location.name}, ${location.admin1 ? location.admin1 + ', ' : ''}${location.country}`;
            document.getElementById('displayCoords').value = `${location.latitude.toFixed(6)}, ${location.longitude.toFixed(6)}`;
            document.getElementById('latitude').value = location.latitude;
            document.getElementById('longitude').value = location.longitude;
            document.getElementById('timezone').value = location.timezone || '';

            // Show the form
            document.getElementById('locationForm').classList.remove('hidden');
            showMessage('Location selected! Adjust the name if needed and click Save.', 'success');
        }

        async function lookupZipCode() {
            const zipCode = document.getElementById('zipCode').value.trim();

            if (!zipCode) {
                showMessage('Please enter a ZIP or postal code', 'error');
                return;
            }

            Loading.show('#zip-tab');

            try {
                const response = await fetch(`/api/v1/locations/lookup/zip/${encodeURIComponent(zipCode)}`);
                const location = await response.json();

                if (response.ok) {
                    selectLocation(location);
                } else {
                    showMessage(location.error || 'ZIP code not found', 'error');
                }
            } catch (error) {
                showMessage('Failed to look up ZIP code', 'error');
            } finally {
                Loading.hide('#zip-tab');
            }
        }

        async function lookupCoordinates() {
            const lat = parseFloat(document.getElementById('manualLat').value);
            const lon = parseFloat(document.getElementById('manualLon').value);

            if (isNaN(lat) || isNaN(lon)) {
                showMessage('Please enter valid coordinates', 'error');
                return;
            }

            Loading.show('#coords-tab');

            try {
                const response = await fetch(`/api/v1/locations/lookup/coords?lat=${lat}&lon=${lon}`);
                const location = await response.json();

                if (response.ok) {
                    selectLocation(location);
                } else {
                    showMessage(location.error || 'Location not found', 'error');
                }
            } catch (error) {
                showMessage('Failed to look up coordinates', 'error');
            } finally {
                Loading.hide('#coords-tab');
            }
        }

        function useCurrentLocation() {
            if (!navigator.geolocation) {
                showMessage('Geolocation is not supported by your browser', 'error');
                return;
            }

            showMessage('Getting your location...', 'info');

            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;

                    try {
                        const response = await fetch(`/api/v1/locations/lookup/coords?lat=${lat}&lon=${lon}`);
                        const location = await response.json();

                        if (response.ok) {
                            selectLocation(location);
                        } else {
                            showMessage('Could not identify your location', 'error');
                        }
                    } catch (error) {
                        showMessage('Failed to look up your location', 'error');
                    }
                },
                (error) => {
                    showMessage('Unable to get your location: ' + error.message, 'error');
                }
            );
        }

        function resetForm() {
            document.getElementById('locationForm').classList.add('hidden');
            document.getElementById('searchResults').classList.remove('active');
            document.getElementById('citySearch').value = '';
            document.getElementById('zipCode').value = '';
            document.getElementById('manualLat').value = '';
            document.getElementById('manualLon').value = '';
            selectedLocation = null;
            clearMessage();
        }

        document.getElementById('locationForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const data = {
                name: document.getElementById('name').value,
                latitude: parseFloat(document.getElementById('latitude').value),
                longitude: parseFloat(document.getElementById('longitude').value),
                timezone: document.getElementById('timezone').value || ''
            };

            try {
                const response = await fetch('/api/v1/locations', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    Toast.success('Location saved successfully!');
                    setTimeout(() => {
                        window.location.href = '/user/dashboard';
                    }, 1500);
                } else {
                    const error = await response.json();
                    showMessage(error.error || 'Failed to save location', 'error');
                }
            } catch (error) {
                showMessage('Error saving location', 'error');
            }
        });

        function showMessage(message, type) {
            Alert.create(message, {
                type: type,
                container: '#message'
            });
        }

        function clearMessage() {
            document.getElementById('message').innerHTML = '';
        }

        // Initialize notification polling
        if (typeof Notifications !== 'undefined') {
            Notifications.startPolling(30000);
        }
    </script>
</body>
</html>
