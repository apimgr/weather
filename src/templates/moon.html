<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Title}}</title>
    <link rel="stylesheet" href="/static/css/dracula.css">
    <script src="/static/js/app.js" defer></script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üåô</text></svg>">
</head>
<body>
    {{template "navbar" .}}

    <div class="weather-container">

        <!-- Location Search Form - Mobile First -->
        <form id="moon-form" class="moon-form">
            <div class="moon-form__wrapper">
                <!-- First row: Location input and units -->
                <div class="moon-form__row">
                    <div class="moon-form__input-wrapper">
                        <input
                            type="text"
                            id="moon-location-input"
                            name="location"
                            class="location-input moon-form__input"
                            placeholder="Enter city or coordinates"
                            value="{{.Location}}"
                            autocomplete="off"
                        >
                        <div id="moon-autocomplete-dropdown" class="autocomplete-dropdown"></div>
                    </div>
                    <select name="units" id="moon-units-select" class="location-input moon-form__units">
                        <option value="imperial"{{if eq .Units "imperial"}} selected{{end}}>¬∞F</option>
                        <option value="metric"{{if eq .Units "metric"}} selected{{end}}>¬∞C</option>
                    </select>
                </div>

                <!-- Second row: Buttons -->
                <div class="moon-form__row">
                    <button type="submit" class="search-button moon-form__button">
                        üåô Moon Info
                    </button>
                    <button type="button" id="moon-location-btn" class="search-button moon-form__button--location">
                        üìç My Location
                    </button>
                </div>
            </div>
        </form>

        {{if .MoonData}}
            {{template "location_details" .MoonData}}

            <!-- Current Moon Phase -->
            <div class="current-weather">
                <div class="weather-icon moon-weather-icon">
                    {{.MoonData.Moon.Icon}}
                </div>
                <div class="weather-details">
                    <div class="temperature moon-temp-display">
                        {{.MoonData.Moon.Phase}}
                    </div>
                    <div class="description">
                        {{.MoonData.Moon.Illumination}}% illuminated
                    </div>
                    <div class="weather-stats">
                        <div class="stat">Age: <span class="stat-value">{{.MoonData.Moon.Age}} days</span></div>
                        <div class="stat">Next Phase: <span class="stat-value">
                            {{if lt .MoonData.Moon.Age 7}}First Quarter{{else if lt .MoonData.Moon.Age 14}}Full Moon{{else if lt .MoonData.Moon.Age 21}}Last Quarter{{else}}New Moon{{end}}
                        </span></div>
                    </div>
                </div>
            </div>

            <!-- Moon and Sun Times -->
            <div class="grid-auto-fit-300">
                <!-- Moon Times -->
                <div class="info-box">
                    <h3 class="info-box__title info-box__title--lunar">üåô Lunar Information</h3>
                    <div class="info-box__content">
                        <div class="info-box__item">
                            <strong class="info-box__label">Phase:</strong>
                            <span class="info-box__value--primary">{{.MoonData.Moon.Phase}}</span>
                        </div>
                        <div class="info-box__item">
                            <strong class="info-box__label">Illumination:</strong>
                            <span class="info-box__value--green">{{.MoonData.Moon.Illumination}}%</span>
                        </div>
                        <div class="info-box__item">
                            <strong class="info-box__label">Age:</strong>
                            <span class="info-box__value--pink">{{.MoonData.Moon.Age}} days</span>
                        </div>
                        {{if and .MoonData.Moon.Rise .MoonData.Moon.Set}}
                        <div class="info-box__item">
                            <strong class="info-box__label">Moonrise:</strong>
                            <span class="info-box__value--orange">{{.MoonData.Moon.RiseFormatted}}</span>
                        </div>
                        <div class="info-box__item">
                            <strong class="info-box__label">Moonset:</strong>
                            <span class="info-box__value--orange">{{.MoonData.Moon.SetFormatted}}</span>
                        </div>
                        {{end}}
                    </div>
                </div>

                <!-- Sun Times -->
                <div class="info-box">
                    <h3 class="info-box__title info-box__title--solar">‚òÄÔ∏è Solar Information</h3>
                    <div class="info-box__content">
                        <div class="info-box__item">
                            <strong class="info-box__label">Sunrise:</strong>
                            <span class="info-box__value--primary">{{.MoonData.Sun.SunriseFormatted}}</span>
                        </div>
                        <div class="info-box__item">
                            <strong class="info-box__label">Sunset:</strong>
                            <span class="info-box__value--red">{{.MoonData.Sun.SunsetFormatted}}</span>
                        </div>
                        <div class="info-box__item">
                            <strong class="info-box__label">Solar Noon:</strong>
                            <span class="info-box__value--green">{{.MoonData.Sun.SolarNoonFormatted}}</span>
                        </div>
                        <div class="info-box__item">
                            <strong class="info-box__label">Day Length:</strong>
                            <span class="info-box__value--pink">{{.MoonData.Sun.DayLengthFormatted}}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Console Command Examples -->
            <div class="console-section">
                <h3 class="console-section__title">Console Access</h3>
                <div class="console-commands">
                    <div class="command-item">
                        <strong class="console-section__label">Weather:</strong>
                        <div class="code-wrapper">
                            <code class="mobile-code">curl -q -LSs {{.HostInfo.FullHost}}/{{.MoonData.Location.NameEncoded}}</code>
                            <button class="copy-btn" onclick="copyCommand(this, 'curl -q -LSs {{.HostInfo.FullHost}}/{{.MoonData.Location.NameEncoded}}')">Copy</button>
                        </div>
                    </div>
                    <div class="command-item">
                        <strong class="console-section__label">One-Line:</strong>
                        <div class="code-wrapper">
                            <code class="mobile-code">curl -q -LSs {{.HostInfo.FullHost}}/{{.MoonData.Location.NameEncoded}}?format=3</code>
                            <button class="copy-btn" onclick="copyCommand(this, 'curl -q -LSs {{.HostInfo.FullHost}}/{{.MoonData.Location.NameEncoded}}?format=3')">Copy</button>
                        </div>
                    </div>
                    <div class="command-item">
                        <strong class="console-section__label">Moon:</strong>
                        <div class="code-wrapper">
                            <code class="mobile-code">curl -q -LSs {{.HostInfo.FullHost}}/moon</code>
                            <button class="copy-btn" onclick="copyCommand(this, 'curl -q -LSs {{.HostInfo.FullHost}}/moon')">Copy</button>
                        </div>
                    </div>
                    <div class="command-item">
                        <strong class="console-section__label">Moon Location:</strong>
                        <div class="code-wrapper">
                            <code class="mobile-code">curl -q -LSs {{.HostInfo.FullHost}}/moon/{{.MoonData.Location.NameEncoded}}</code>
                            <button class="copy-btn" onclick="copyCommand(this, 'curl -q -LSs {{.HostInfo.FullHost}}/moon/{{.MoonData.Location.NameEncoded}}')">Copy</button>
                        </div>
                    </div>
                </div>
            </div>
        {{else}}
            <div class="welcome-section">
                <h2 class="welcome-section__title">üåô Moon Phase Information</h2>
                <p>Enter a location above to see moon phase information, or try these examples:</p>
                <div class="city-links-grid">
                    <a href="?location=London" class="city-link">üá¨üáß London</a>
                    <a href="?location=Tokyo" class="city-link">üáØüáµ Tokyo</a>
                    <a href="?location=New York" class="city-link">üá∫üá∏ New York</a>
                    <a href="?location=Sydney" class="city-link">üá¶üá∫ Sydney</a>
                </div>
            </div>
        {{end}}

    </div>

    <script>
        // Form handling for moon page
        document.addEventListener('DOMContentLoaded', function() {
            const moonForm = document.getElementById('moon-form');
            const locationInput = document.getElementById('moon-location-input');
            const unitsSelect = document.getElementById('moon-units-select');
            const locationBtn = document.getElementById('moon-location-btn');

            // Handle form submission
            if (moonForm) {
                moonForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const location = locationInput.value.trim();
                    const units = unitsSelect.value;

                    if (!location) {
                        window.location.href = `${window.location.origin}/moon`;
                        return;
                    }

                    const cleanLocation = location.replace(/ /g, '+');
                    const unitsParam = units !== 'imperial' ? `?units=${units}` : '';
                    window.location.href = `${window.location.origin}/moon/${cleanLocation}${unitsParam}`;
                });
            }

            // Handle My Location button
            if (locationBtn) {
                locationBtn.addEventListener('click', async function() {
                    const originalText = this.textContent;
                    this.disabled = true;
                    this.textContent = 'üìç Getting location...';

                    try {
                        const position = await new Promise((resolve, reject) => {
                            navigator.geolocation.getCurrentPosition(resolve, reject, {
                                timeout: 10000,
                                enableHighAccuracy: true
                            });
                        });

                        const lat = position.coords.latitude.toFixed(4);
                        const lon = position.coords.longitude.toFixed(4);
                        const units = unitsSelect.value;
                        const unitsParam = units !== 'imperial' ? `?units=${units}` : '';

                        this.textContent = 'üìç Found!';
                        setTimeout(() => {
                            window.location.href = `${window.location.origin}/moon/${lat},${lon}${unitsParam}`;
                        }, 500);
                    } catch (error) {
                        // Fallback to IP detection
                        fetch('/debug/ip')
                            .then(response => response.json())
                            .then(data => {
                                if (data.location && data.location.value) {
                                    const detectedLocation = data.location.value.replace(/ /g, '+');
                                    const units = unitsSelect.value;
                                    const unitsParam = units !== 'imperial' ? `?units=${units}` : '';
                                    this.textContent = 'üìç Found!';
                                    setTimeout(() => {
                                        window.location.href = `${window.location.origin}/moon/${detectedLocation}${unitsParam}`;
                                    }, 500);
                                } else {
                                    throw new Error('No location');
                                }
                            })
                            .catch(() => {
                                this.textContent = originalText;
                                this.disabled = false;
                                showAlert('Unable to detect your location. Please enter it manually.');
                            });
                    }
                });
            }

            // Autocomplete functionality for moon page
            let autocompleteTimeout;
            if (locationInput) {
                locationInput.addEventListener('input', function(e) {
                    clearTimeout(autocompleteTimeout);
                    const query = e.target.value.trim();
                    if (query.length < 2) {
                        hideMoonAutocomplete();
                        return;
                    }
                    autocompleteTimeout = setTimeout(() => {
                        searchMoonLocations(query);
                    }, 300);
                });

                // Hide autocomplete when clicking outside
                document.addEventListener('click', function(e) {
                    if (!e.target.closest('#moon-location-input') && !e.target.closest('#moon-autocomplete-dropdown')) {
                        hideMoonAutocomplete();
                    }
                });
            }
        });

        function searchMoonLocations(query) {
            fetch(`/api/v1/search?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.results && data.results.length > 0) {
                        showMoonAutocomplete(data.results);
                    } else {
                        hideMoonAutocomplete();
                    }
                })
                .catch(err => {
                    console.error('Autocomplete error:', err);
                    hideMoonAutocomplete();
                });
        }

        function showMoonAutocomplete(results) {
            const dropdown = document.getElementById('moon-autocomplete-dropdown');
            dropdown.innerHTML = '';

            results.slice(0, 15).forEach(result => {
                const item = document.createElement('div');
                item.className = 'autocomplete-item';

                const locationName = result.admin1
                    ? `${result.name}, ${result.admin1}, ${result.countryCode}`
                    : `${result.name}, ${result.countryCode}`;

                item.innerHTML = `
                    <span class="autocomplete-item city-name">${result.name}</span>
                    <span class="autocomplete-item location-details">${result.admin1 ? result.admin1 + ', ' : ''}${result.countryCode}</span>
                `;

                item.addEventListener('click', function() {
                    const units = document.getElementById('moon-units-select').value;
                    // Use coordinates for navigation (more accurate)
                    const coords = `${result.latitude.toFixed(4)},${result.longitude.toFixed(4)}`;
                    const unitsParam = units !== 'imperial' ? `?units=${units}` : '';
                    const newUrl = `${window.location.origin}/moon/${coords}${unitsParam}`;
                    hideMoonAutocomplete();
                    window.location.href = newUrl;
                });

                dropdown.appendChild(item);
            });

            dropdown.style.display = 'block';
        }

        function hideMoonAutocomplete() {
            const dropdown = document.getElementById('moon-autocomplete-dropdown');
            if (dropdown) {
                dropdown.style.display = 'none';
                dropdown.innerHTML = '';
            }
        }

        // Copy command to clipboard
        function copyCommand(button, text) {
            navigator.clipboard.writeText(text).then(() => {
                const originalText = button.textContent;
                button.textContent = '‚úì Copied!';
                button.classList.add('copied');
                setTimeout(() => {
                    button.textContent = originalText;
                    button.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
                button.textContent = '‚úó Failed';
                setTimeout(() => {
                    button.textContent = 'Copy';
                }, 2000);
            });
        }

        // Initialize notification polling
        if (typeof Notifications !== 'undefined') {
            Notifications.startPolling(30000);
        }
    </script>

{{if not .HideFooter}}
{{template "footer" .}}
{{else}}
</body>
</html>
{{end}}
