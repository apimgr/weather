<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Title}}</title>
    <link rel="stylesheet" href="/static/css/dracula.css">
    <script src="/static/js/app.js" defer></script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üåô</text></svg>">
</head>
<body>
    {{template "navbar" .}}

    <div class="weather-container">

        <!-- Location Search Form - Mobile First -->
        <form id="moon-form" style="margin: 1rem 0; width: 100%;">
            <div style="display: flex; flex-direction: column; gap: 0.75rem; width: 100%;">
                <!-- First row: Location input and units -->
                <div style="display: flex; gap: 0.5rem; width: 100%;">
                    <div style="position: relative; flex: 1;">
                        <input
                            type="text"
                            id="moon-location-input"
                            name="location"
                            class="location-input"
                            placeholder="Enter city or coordinates"
                            value="{{.Location}}"
                            style="flex: 1; min-width: 0; width: 100%;"
                            autocomplete="off"
                        >
                        <div id="moon-autocomplete-dropdown" class="autocomplete-dropdown"></div>
                    </div>
                    <select name="units" id="moon-units-select" class="location-input" style="flex-shrink: 0; width: 5rem;">
                        <option value="imperial"{{if eq .Units "imperial"}} selected{{end}}>¬∞F</option>
                        <option value="metric"{{if eq .Units "metric"}} selected{{end}}>¬∞C</option>
                    </select>
                </div>

                <!-- Second row: Buttons -->
                <div style="display: flex; gap: 0.5rem; width: 100%;">
                    <button type="submit" class="search-button" style="flex: 1;">
                        üåô Moon Info
                    </button>
                    <button type="button" id="moon-location-btn" class="search-button"
                            style="flex: 1; background-color: var(--dracula-cyan);">
                        üìç My Location
                    </button>
                </div>
            </div>
        </form>

        {{if .MoonData}}
            {{template "location_details" .MoonData}}

            <!-- Current Moon Phase -->
            <div class="current-weather">
                <div class="weather-icon" style="font-size: 4rem;">
                    {{.MoonData.Moon.Icon}}
                </div>
                <div class="weather-details">
                    <div class="temperature" style="color: var(--dracula-purple);">
                        {{.MoonData.Moon.Phase}}
                    </div>
                    <div class="description">
                        {{.MoonData.Moon.Illumination}}% illuminated
                    </div>
                    <div class="weather-stats">
                        <div class="stat">Age: <span class="stat-value">{{.MoonData.Moon.Age}} days</span></div>
                        <div class="stat">Next Phase: <span class="stat-value">
                            {{if lt .MoonData.Moon.Age 7}}First Quarter{{else if lt .MoonData.Moon.Age 14}}Full Moon{{else if lt .MoonData.Moon.Age 21}}Last Quarter{{else}}New Moon{{end}}
                        </span></div>
                    </div>
                </div>
            </div>

            <!-- Moon and Sun Times -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; margin: 1.5rem 0;">
                <!-- Moon Times -->
                <div style="background-color: var(--dracula-bg); padding: 1.5rem; border-radius: 0.5rem; border: 1px solid var(--dracula-current-line);">
                    <h3 style="color: var(--dracula-purple); margin-top: 0; text-align: center;">üåô Lunar Information</h3>
                    <div style="color: var(--dracula-foreground);">
                        <div style="margin: 0.75rem 0;">
                            <strong style="color: var(--dracula-cyan);">Phase:</strong>
                            <span style="color: var(--dracula-yellow);">{{.MoonData.Moon.Phase}}</span>
                        </div>
                        <div style="margin: 0.75rem 0;">
                            <strong style="color: var(--dracula-cyan);">Illumination:</strong>
                            <span style="color: var(--dracula-green);">{{.MoonData.Moon.Illumination}}%</span>
                        </div>
                        <div style="margin: 0.75rem 0;">
                            <strong style="color: var(--dracula-cyan);">Age:</strong>
                            <span style="color: var(--dracula-pink);">{{.MoonData.Moon.Age}} days</span>
                        </div>
                        {{if and .MoonData.Moon.Rise .MoonData.Moon.Set}}
                        <div style="margin: 0.75rem 0;">
                            <strong style="color: var(--dracula-cyan);">Moonrise:</strong>
                            <span style="color: var(--dracula-orange);">{{.MoonData.Moon.RiseFormatted}}</span>
                        </div>
                        <div style="margin: 0.75rem 0;">
                            <strong style="color: var(--dracula-cyan);">Moonset:</strong>
                            <span style="color: var(--dracula-orange);">{{.MoonData.Moon.SetFormatted}}</span>
                        </div>
                        {{end}}
                    </div>
                </div>

                <!-- Sun Times -->
                <div style="background-color: var(--dracula-bg); padding: 1.5rem; border-radius: 0.5rem; border: 1px solid var(--dracula-current-line);">
                    <h3 style="color: var(--dracula-yellow); margin-top: 0; text-align: center;">‚òÄÔ∏è Solar Information</h3>
                    <div style="color: var(--dracula-foreground);">
                        <div style="margin: 0.75rem 0;">
                            <strong style="color: var(--dracula-cyan);">Sunrise:</strong>
                            <span style="color: var(--dracula-yellow);">{{.MoonData.Sun.SunriseFormatted}}</span>
                        </div>
                        <div style="margin: 0.75rem 0;">
                            <strong style="color: var(--dracula-cyan);">Sunset:</strong>
                            <span style="color: var(--dracula-red);">{{.MoonData.Sun.SunsetFormatted}}</span>
                        </div>
                        <div style="margin: 0.75rem 0;">
                            <strong style="color: var(--dracula-cyan);">Solar Noon:</strong>
                            <span style="color: var(--dracula-green);">{{.MoonData.Sun.SolarNoonFormatted}}</span>
                        </div>
                        <div style="margin: 0.75rem 0;">
                            <strong style="color: var(--dracula-cyan);">Day Length:</strong>
                            <span style="color: var(--dracula-pink);">{{.MoonData.Sun.DayLengthFormatted}}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Console Command Examples -->
            <div style="margin-top: 30px; padding: 20px; background-color: var(--dracula-bg); border-radius: 6px;">
                <h3 style="color: var(--dracula-purple); text-align: center; margin-top: 0;">Console Access</h3>
                <div class="console-commands">
                    <div class="command-item">
                        <strong style="color: var(--dracula-green);">Weather:</strong>
                        <div class="code-wrapper">
                            <code class="mobile-code">curl -q -LSs {{.HostInfo.FullHost}}/{{.MoonData.Location.NameEncoded}}</code>
                            <button class="copy-btn" onclick="copyCommand(this, 'curl -q -LSs {{.HostInfo.FullHost}}/{{.MoonData.Location.NameEncoded}}')">Copy</button>
                        </div>
                    </div>
                    <div class="command-item">
                        <strong style="color: var(--dracula-green);">One-Line:</strong>
                        <div class="code-wrapper">
                            <code class="mobile-code">curl -q -LSs {{.HostInfo.FullHost}}/{{.MoonData.Location.NameEncoded}}?format=3</code>
                            <button class="copy-btn" onclick="copyCommand(this, 'curl -q -LSs {{.HostInfo.FullHost}}/{{.MoonData.Location.NameEncoded}}?format=3')">Copy</button>
                        </div>
                    </div>
                    <div class="command-item">
                        <strong style="color: var(--dracula-green);">Moon:</strong>
                        <div class="code-wrapper">
                            <code class="mobile-code">curl -q -LSs {{.HostInfo.FullHost}}/moon</code>
                            <button class="copy-btn" onclick="copyCommand(this, 'curl -q -LSs {{.HostInfo.FullHost}}/moon')">Copy</button>
                        </div>
                    </div>
                    <div class="command-item">
                        <strong style="color: var(--dracula-green);">Moon Location:</strong>
                        <div class="code-wrapper">
                            <code class="mobile-code">curl -q -LSs {{.HostInfo.FullHost}}/moon/{{.MoonData.Location.NameEncoded}}</code>
                            <button class="copy-btn" onclick="copyCommand(this, 'curl -q -LSs {{.HostInfo.FullHost}}/moon/{{.MoonData.Location.NameEncoded}}')">Copy</button>
                        </div>
                    </div>
                </div>
            </div>
        {{else}}
            <div style="text-align: center; color: var(--dracula-comment); margin: 40px 0;">
                <h2 style="color: var(--dracula-purple);">üåô Moon Phase Information</h2>
                <p>Enter a location above to see moon phase information, or try these examples:</p>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin: 20px 0;">
                    <a href="?location=London" style="color: var(--dracula-pink); text-decoration: none; padding: 8px; background: var(--dracula-bg); border-radius: 4px; display: block;">üá¨üáß London</a>
                    <a href="?location=Tokyo" style="color: var(--dracula-pink); text-decoration: none; padding: 8px; background: var(--dracula-bg); border-radius: 4px; display: block;">üáØüáµ Tokyo</a>
                    <a href="?location=New York" style="color: var(--dracula-pink); text-decoration: none; padding: 8px; background: var(--dracula-bg); border-radius: 4px; display: block;">üá∫üá∏ New York</a>
                    <a href="?location=Sydney" style="color: var(--dracula-pink); text-decoration: none; padding: 8px; background: var(--dracula-bg); border-radius: 4px; display: block;">üá¶üá∫ Sydney</a>
                </div>
            </div>
        {{end}}

    </div>

    <script>
        // Form handling for moon page
        document.addEventListener('DOMContentLoaded', function() {
            const moonForm = document.getElementById('moon-form');
            const locationInput = document.getElementById('moon-location-input');
            const unitsSelect = document.getElementById('moon-units-select');
            const locationBtn = document.getElementById('moon-location-btn');

            // Handle form submission
            if (moonForm) {
                moonForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const location = locationInput.value.trim();
                    const units = unitsSelect.value;

                    if (!location) {
                        window.location.href = `${window.location.origin}/moon`;
                        return;
                    }

                    const cleanLocation = location.replace(/ /g, '+');
                    const unitsParam = units !== 'imperial' ? `?units=${units}` : '';
                    window.location.href = `${window.location.origin}/moon/${cleanLocation}${unitsParam}`;
                });
            }

            // Handle My Location button
            if (locationBtn) {
                locationBtn.addEventListener('click', async function() {
                    const originalText = this.textContent;
                    this.disabled = true;
                    this.textContent = 'üìç Getting location...';

                    try {
                        const position = await new Promise((resolve, reject) => {
                            navigator.geolocation.getCurrentPosition(resolve, reject, {
                                timeout: 10000,
                                enableHighAccuracy: true
                            });
                        });

                        const lat = position.coords.latitude.toFixed(4);
                        const lon = position.coords.longitude.toFixed(4);
                        const units = unitsSelect.value;
                        const unitsParam = units !== 'imperial' ? `?units=${units}` : '';

                        this.textContent = 'üìç Found!';
                        setTimeout(() => {
                            window.location.href = `${window.location.origin}/moon/${lat},${lon}${unitsParam}`;
                        }, 500);
                    } catch (error) {
                        // Fallback to IP detection
                        fetch('/debug/ip')
                            .then(response => response.json())
                            .then(data => {
                                if (data.location && data.location.value) {
                                    const detectedLocation = data.location.value.replace(/ /g, '+');
                                    const units = unitsSelect.value;
                                    const unitsParam = units !== 'imperial' ? `?units=${units}` : '';
                                    this.textContent = 'üìç Found!';
                                    setTimeout(() => {
                                        window.location.href = `${window.location.origin}/moon/${detectedLocation}${unitsParam}`;
                                    }, 500);
                                } else {
                                    throw new Error('No location');
                                }
                            })
                            .catch(() => {
                                this.textContent = originalText;
                                this.disabled = false;
                                showAlert('Unable to detect your location. Please enter it manually.');
                            });
                    }
                });
            }

            // Autocomplete functionality for moon page
            let autocompleteTimeout;
            if (locationInput) {
                locationInput.addEventListener('input', function(e) {
                    clearTimeout(autocompleteTimeout);
                    const query = e.target.value.trim();
                    if (query.length < 2) {
                        hideMoonAutocomplete();
                        return;
                    }
                    autocompleteTimeout = setTimeout(() => {
                        searchMoonLocations(query);
                    }, 300);
                });

                // Hide autocomplete when clicking outside
                document.addEventListener('click', function(e) {
                    if (!e.target.closest('#moon-location-input') && !e.target.closest('#moon-autocomplete-dropdown')) {
                        hideMoonAutocomplete();
                    }
                });
            }
        });

        function searchMoonLocations(query) {
            fetch(`/api/v1/search?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.results && data.results.length > 0) {
                        showMoonAutocomplete(data.results);
                    } else {
                        hideMoonAutocomplete();
                    }
                })
                .catch(err => {
                    console.error('Autocomplete error:', err);
                    hideMoonAutocomplete();
                });
        }

        function showMoonAutocomplete(results) {
            const dropdown = document.getElementById('moon-autocomplete-dropdown');
            dropdown.innerHTML = '';

            results.slice(0, 8).forEach(result => {
                const item = document.createElement('div');
                item.className = 'autocomplete-item';

                const locationName = result.admin1
                    ? `${result.name}, ${result.admin1}, ${result.country_code}`
                    : `${result.name}, ${result.country_code}`;

                item.innerHTML = `
                    <span style="color: var(--dracula-cyan); font-weight: 500;">${result.name}</span>
                    <span style="color: var(--dracula-comment); font-size: 0.875rem;">${result.admin1 ? result.admin1 + ', ' : ''}${result.country_code}</span>
                `;

                item.addEventListener('click', function() {
                    const units = document.getElementById('moon-units-select').value;
                    // Use coordinates for navigation (more accurate)
                    const coords = `${result.latitude.toFixed(4)},${result.longitude.toFixed(4)}`;
                    const unitsParam = units !== 'imperial' ? `?units=${units}` : '';
                    const newUrl = `${window.location.origin}/moon/${coords}${unitsParam}`;
                    hideMoonAutocomplete();
                    window.location.href = newUrl;
                });

                dropdown.appendChild(item);
            });

            dropdown.style.display = 'block';
        }

        function hideMoonAutocomplete() {
            const dropdown = document.getElementById('moon-autocomplete-dropdown');
            if (dropdown) {
                dropdown.style.display = 'none';
                dropdown.innerHTML = '';
            }
        }

        // Copy command to clipboard
        function copyCommand(button, text) {
            navigator.clipboard.writeText(text).then(() => {
                const originalText = button.textContent;
                button.textContent = '‚úì Copied!';
                button.classList.add('copied');
                setTimeout(() => {
                    button.textContent = originalText;
                    button.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
                button.textContent = '‚úó Failed';
                setTimeout(() => {
                    button.textContent = 'Copy';
                }, 2000);
            });
        }

        // Initialize notification polling
        if (typeof Notifications !== 'undefined') {
            Notifications.startPolling(30000);
        }
    </script>

{{if not .HideFooter}}
{{template "footer" .}}
{{else}}
</body>
</html>
{{end}}
