{{template "head" .}}
{{template "admin_header" .}}
{{template "admin_nav" .}}

<main class="container p-4">
    <h1>üßÖ Tor Hidden Service</h1>
    <p>Manage your Tor hidden service and .onion address</p>

    <!-- Status Card -->
    <section class="card mb-4 p-4" role="region" aria-labelledby="status-heading">
        <h2 id="status-heading">Service Status</h2>

        <div class="status-row">
            <span class="status-indicator {{if .TorStatus.enabled}}status-connected{{else}}status-disconnected{{end}}"
                  role="img"
                  aria-label="{{if .TorStatus.enabled}}Connected{{else}}Disconnected{{end}}"></span>
            <strong id="tor-status-text">{{if .TorStatus.enabled}}Connected{{else}}Disconnected{{end}}</strong>
        </div>

        {{if .TorStatus.enabled}}
        <div class="onion-address-box" role="region" aria-labelledby="address-label">
            <div>
                <label id="address-label" class="d-block mb-1">Your .onion Address:</label>
                <code id="onion-address">{{.TorStatus.onion_address}}</code>
            </div>
            <button class="btn btn-secondary"
                    onclick="copyAddress()"
                    aria-label="Copy .onion address to clipboard">
                üìã Copy
            </button>
        </div>
        {{end}}

        <div class="action-row">
            {{if .TorStatus.enabled}}
            <button class="btn btn-danger mr-md"
                    onclick="disableTor()"
                    aria-label="Disable Tor service">
                Disable Tor
            </button>
            <button class="btn btn-secondary"
                    onclick="showRegenerateModal()"
                    aria-label="Regenerate .onion address">
                üîÑ Regenerate Address
            </button>
            {{else}}
            <button class="btn btn-primary"
                    onclick="enableTor()"
                    aria-label="Enable Tor service">
                Enable Tor
            </button>
            {{end}}
        </div>
    </section>

    <!-- Vanity Address Generation -->
    <section class="card mb-4 p-4" role="region" aria-labelledby="vanity-heading">
        <h2 id="vanity-heading">Vanity Address Generation</h2>
        <p>Generate a custom .onion address with your desired prefix (max 6 characters)</p>

        <div class="form-group">
            <label for="vanity-prefix" class="form-label text-purple">
                Desired Prefix
                <span aria-hidden="true">*</span>
            </label>
            <input type="text"
                   id="vanity-prefix"
                   class="form-input"
                   maxlength="6"
                   pattern="[a-z2-7]+"
                   placeholder="weather (example)"
                   aria-required="true"
                   aria-describedby="prefix-help">
            <small id="prefix-help" class="form-help">
                Use only lowercase letters (a-z) and numbers (2-7). Max 6 characters for reasonable generation time.
            </small>
        </div>

        <div class="mb-3">
            <strong>Estimated Generation Time:</strong>
            <ul class="mt-1">
                <li>1-4 characters: Seconds to minutes</li>
                <li>5 characters: Minutes to hours</li>
                <li>6 characters: Hours to days</li>
            </ul>
        </div>

        <button class="btn btn-primary"
                id="generate-vanity-btn"
                onclick="generateVanity()"
                aria-label="Start vanity address generation">
            üé≤ Generate Vanity Address
        </button>

        <!-- Vanity Progress (shown when generating) -->
        <div id="vanity-progress" class="vanity-progress d-none" role="status" aria-live="polite">
            <h3>‚è≥ Generating: "<span id="vanity-prefix-display"></span>"</h3>

            <div class="progress-stats">
                <div class="stat-item">
                    <div class="stat-value" id="attempts-count">0</div>
                    <div class="stat-label">Attempts</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="elapsed-time">0s</div>
                    <div class="stat-label">Elapsed</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="estimated-time">Calculating...</div>
                    <div class="stat-label">Estimated</div>
                </div>
            </div>

            <div class="mt-3">
                <button class="btn btn-danger"
                        onclick="cancelVanity()"
                        aria-label="Cancel vanity generation">
                    ‚èπÔ∏è Cancel
                </button>
            </div>

            <!-- Success message (shown when complete) -->
            <div id="vanity-success" class="success-box d-none">
                <strong>‚úÖ Vanity address found!</strong>
                <div class="mt-1">
                    <code id="vanity-address-result"></code>
                </div>
                <button class="btn btn-primary mt-3"
                        onclick="applyVanity()"
                        aria-label="Apply vanity address">
                    Apply This Address
                </button>
            </div>
        </div>
    </section>

    <!-- Import External Keys -->
    <section class="card mb-4 p-4" role="region" aria-labelledby="import-heading">
        <h2 id="import-heading">Import External Keys</h2>
        <p>Import keys generated with external tools (for prefixes longer than 6 characters)</p>

        <form id="import-form" onsubmit="importKeys(event)" enctype="multipart/form-data">
            <input type="hidden" name="csrf_token" value="{{.csrf_token}}">
            <div class="form-group">
                <label for="key-file" class="form-label text-purple">
                    Tor Private Key File
                    <span aria-hidden="true">*</span>
                </label>
                <input type="file"
                       id="key-file"
                       name="key_file"
                       class="form-input"
                       accept=".key,.pem"
                       required
                       aria-required="true"
                       aria-describedby="import-help">
                <small id="import-help" class="form-help">
                    Upload the hs_ed25519_secret_key file from mkp224o or similar tool
                </small>
            </div>

            <button type="submit" class="btn btn-primary" aria-label="Import keys">
                üì• Import Keys
            </button>
        </form>

        <div class="help-section mt-3">
            <details>
                <summary class="cursor-pointer font-semibold">
                    ‚ÑπÔ∏è Help: Generating Longer Vanity Addresses (7+ characters)
                </summary>
                <div class="mt-3">
                    <p>For prefixes longer than 6 characters, use external tools with GPU acceleration:</p>

                    <h4 class="mt-3">Using mkp224o (Recommended):</h4>
                    <pre class="code-block"><code># Install
git clone https://github.com/cathugger/mkp224o
cd mkp224o && ./autogen.sh && ./configure && make

# Generate (example: 7-char prefix "weather7")
./mkp224o -d ./keys weather7

# Output in: ./keys/weather7xxxxx.onion/
#   ‚îú‚îÄ hs_ed25519_secret_key  (upload this file)
#   ‚îî‚îÄ hostname</code></pre>

                    <h4 class="mt-3">Time Estimates:</h4>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Prefix Length</th>
                                <th>CPU Time</th>
                                <th>GPU Time</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>7 chars</td>
                                <td>Days to weeks</td>
                                <td>Hours to days</td>
                            </tr>
                            <tr>
                                <td>8 chars</td>
                                <td>Weeks to months</td>
                                <td>Days to weeks</td>
                            </tr>
                            <tr>
                                <td>9+ chars</td>
                                <td>Months to years</td>
                                <td>Weeks to months</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </details>
        </div>
    </section>

    <!-- Export Keys -->
    <section class="card mb-4 p-4" role="region" aria-labelledby="export-heading">
        <h2 id="export-heading">Export Current Keys</h2>
        <p>Download your current Tor hidden service private key for backup</p>

        <button class="btn btn-secondary"
                onclick="exportKeys()"
                aria-label="Export current keys">
            üì§ Download Private Key
        </button>

        <p class="warning-text">
            <strong>‚ö†Ô∏è Security Warning:</strong> Keep your private key safe. Anyone with access to it can impersonate your .onion address.
        </p>
    </section>
</main>

<!-- Regenerate Confirmation Modal -->
<div id="regenerate-modal" class="modal-overlay" role="dialog" aria-labelledby="modal-title" aria-modal="true">
    <div class="modal">
        <h2 id="modal-title">‚ö†Ô∏è Confirm Address Regeneration</h2>
        <p>This will delete your current .onion address and generate a new one.</p>
        <p><strong>Your old address will stop working immediately!</strong></p>
        <p>Current address: <code>{{.TorStatus.onion_address}}</code></p>

        <div class="modal-actions">
            <button class="btn btn-danger mr-md"
                    onclick="confirmRegenerate()"
                    aria-label="Confirm regeneration">
                Yes, Regenerate Address
            </button>
            <button class="btn btn-secondary"
                    onclick="closeRegenerateModal()"
                    aria-label="Cancel regeneration">
                Cancel
            </button>
        </div>
    </div>
</div>

<script>
    // Path variables - SPEC compliant (AI.md PART 13)
    const API_PATH = '{{.api_path}}';
    const ADMIN_API_PATH = '{{.admin_api_path}}';

    // API calls
    async function enableTor() {
        try {
            const response = await fetch(ADMIN_API_PATH + '/server/tor/enable', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            const data = await response.json();
            if (response.ok) {
                Toast.show('Tor enabled successfully!', 'success');
                location.reload();
            } else {
                Toast.show('Failed to enable Tor: ' + (data.error?.message || 'Unknown error'), 'error');
            }
        } catch (error) {
            Toast.show('Error: ' + error.message, 'error');
        }
    }

    async function disableTor() {
        if (!await showConfirm('Are you sure you want to disable Tor?', 'Disable Tor')) return;

        try {
            const response = await fetch(ADMIN_API_PATH + '/server/tor/disable', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            const data = await response.json();
            if (response.ok) {
                Toast.show('Tor disabled successfully!', 'success');
                location.reload();
            } else {
                Toast.show('Failed to disable Tor: ' + (data.error?.message || 'Unknown error'), 'error');
            }
        } catch (error) {
            Toast.show('Error: ' + error.message, 'error');
        }
    }

    function showRegenerateModal() {
        document.getElementById('regenerate-modal').classList.add('active');
    }

    function closeRegenerateModal() {
        document.getElementById('regenerate-modal').classList.remove('active');
    }

    async function confirmRegenerate() {
        closeRegenerateModal();

        try {
            const response = await fetch(ADMIN_API_PATH + '/server/tor/regenerate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            const data = await response.json();
            if (response.ok) {
                Toast.show('Address regenerated successfully!', 'success');
                location.reload();
            } else {
                Toast.show('Failed to regenerate: ' + (data.error?.message || 'Unknown error'), 'error');
            }
        } catch (error) {
            Toast.show('Error: ' + error.message, 'error');
        }
    }

    async function generateVanity() {
        const prefix = document.getElementById('vanity-prefix').value.toLowerCase();
        if (!prefix || prefix.length < 1 || prefix.length > 6) {
            Toast.show('Please enter a prefix between 1-6 characters', 'warning');
            return;
        }

        if (!/^[a-z2-7]+$/.test(prefix)) {
            Toast.show('Please use only lowercase letters (a-z) and numbers (2-7)', 'warning');
            return;
        }

        try {
            const response = await fetch(ADMIN_API_PATH + '/server/tor/vanity/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prefix })
            });
            const data = await response.json();

            if (response.ok) {
                document.getElementById('vanity-prefix-display').textContent = prefix;
                document.getElementById('vanity-progress').classList.remove('d-none');
                document.getElementById('generate-vanity-btn').disabled = true;
                startVanityPolling();
            } else {
                Toast.show('Failed to start generation: ' + (data.error?.message || 'Unknown error'), 'error');
            }
        } catch (error) {
            Toast.show('Error: ' + error.message, 'error');
        }
    }

    let vanityPolling;
    function startVanityPolling() {
        vanityPolling = setInterval(updateVanityStatus, 1000);
    }

    async function updateVanityStatus() {
        try {
            const response = await fetch(ADMIN_API_PATH + '/server/tor/vanity/status');
            const data = await response.json();

            if (data.running) {
                document.getElementById('attempts-count').textContent = data.attempts.toLocaleString();
                const elapsed = Math.floor((Date.now() - new Date(data.start_time)) / 1000);
                document.getElementById('elapsed-time').textContent = formatDuration(elapsed);
                document.getElementById('estimated-time').textContent = data.estimated_time || 'Calculating...';
            } else if (data.address) {
                clearInterval(vanityPolling);
                document.getElementById('vanity-success').classList.remove('d-none');
                document.getElementById('vanity-address-result').textContent = data.address;
            }
        } catch (error) {
            console.error('Error polling status:', error);
        }
    }

    function formatDuration(seconds) {
        if (seconds < 60) return seconds + 's';
        const minutes = Math.floor(seconds / 60);
        if (minutes < 60) return minutes + 'm ' + (seconds % 60) + 's';
        const hours = Math.floor(minutes / 60);
        return hours + 'h ' + (minutes % 60) + 'm';
    }

    async function cancelVanity() {
        try {
            await fetch(ADMIN_API_PATH + '/server/tor/vanity/cancel', { method: 'POST' });
            clearInterval(vanityPolling);
            document.getElementById('vanity-progress').classList.add('d-none');
            document.getElementById('generate-vanity-btn').disabled = false;
        } catch (error) {
            Toast.show('Error: ' + error.message, 'error');
        }
    }

    async function applyVanity() {
        if (!await showConfirm('Apply this vanity address? Your current address will be replaced.', 'Apply Vanity Address')) return;

        try {
            const response = await fetch(ADMIN_API_PATH + '/server/tor/vanity/apply', { method: 'POST' });
            const data = await response.json();
            if (response.ok) {
                Toast.show('Vanity address applied successfully!', 'success');
                location.reload();
            } else {
                Toast.show('Failed to apply: ' + (data.error?.message || 'Unknown error'), 'error');
            }
        } catch (error) {
            Toast.show('Error: ' + error.message, 'error');
        }
    }

    async function importKeys(event) {
        event.preventDefault();

        const formData = new FormData(event.target);

        try {
            const response = await fetch(ADMIN_API_PATH + '/server/tor/keys/import', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();

            if (response.ok) {
                Toast.show('Keys imported successfully!', 'success');
                location.reload();
            } else {
                Toast.show('Failed to import: ' + (data.error?.message || 'Unknown error'), 'error');
            }
        } catch (error) {
            Toast.show('Error: ' + error.message, 'error');
        }
    }

    function exportKeys() {
        window.location.href = ADMIN_API_PATH + '/server/tor/keys/export';
    }

    function copyAddress() {
        const address = document.getElementById('onion-address').textContent;
        navigator.clipboard.writeText(address).then(() => {
            Toast.show('Address copied to clipboard!', 'success');
        });
    }
</script>

{{template "footer" .}}
