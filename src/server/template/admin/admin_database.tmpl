{{define "admin/admin-database.tmpl"}}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.title}}</title>
    <link rel="stylesheet" href="/static/css/admin.css">
    <link rel="stylesheet" href="/static/css/template-overrides.css">
</head>
<body>
    {{template "components/admin-header.tmpl" .}}

    <div class="admin-container">
        {{template "components/admin-sidebar.tmpl" .}}

        <main class="admin-content" role="main">
            <div class="content-header">
                <h1>üóÑÔ∏è Database & Cache Management</h1>
                <p class="subtitle">Optimize database performance and manage caching</p>
            </div>

            <!-- Database Status Section -->
            <section class="admin-card" aria-labelledby="db-status-heading">
                <div class="card-header">
                    <h2 id="db-status-heading">Database Status</h2>
                    <p class="card-description">Current database connection and statistics</p>
                </div>
                <div class="card-body">
                    <div id="db-stats" class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-label">Connection Status</div>
                            <div class="stat-value" id="db-status">
                                <span class="loading">Loading...</span>
                            </div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Database Type</div>
                            <div class="stat-value" id="db-type">-</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Database Size</div>
                            <div class="stat-value" id="db-size">-</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Total Tables</div>
                            <div class="stat-value" id="db-tables">-</div>
                        </div>
                    </div>

                    <button class="btn btn-secondary" onclick="refreshStats()" aria-label="Refresh database statistics">
                        üîÑ Refresh Stats
                    </button>
                </div>
            </section>

            <!-- Database Optimization Section -->
            <section class="admin-card" aria-labelledby="db-optimize-heading">
                <div class="card-header">
                    <h2 id="db-optimize-heading">Database Optimization</h2>
                    <p class="card-description">Improve database performance with optimization tools</p>
                </div>
                <div class="card-body">
                    <div class="alert alert-info" role="status">
                        <strong>Note:</strong> These operations may take a few seconds depending on database size. They are safe to run on a live database.
                    </div>

                    <div class="optimization-actions">
                        <div class="action-card">
                            <div class="action-info">
                                <h3>Optimize Database</h3>
                                <p>Defragment tables and rebuild indexes for better performance</p>
                                <ul>
                                    <li>Reclaims unused space</li>
                                    <li>Improves query speed</li>
                                    <li>Rebuilds table statistics</li>
                                </ul>
                            </div>
                            <button class="btn btn-primary" id="optimize-btn" onclick="optimizeDatabase()" aria-label="Optimize database">
                                ‚ö° Optimize Now
                            </button>
                        </div>

                        <div class="action-card">
                            <div class="action-info">
                                <h3>Vacuum Database (SQLite)</h3>
                                <p>Compact the database file and free unused space</p>
                                <ul>
                                    <li>Reduces file size</li>
                                    <li>Improves disk I/O</li>
                                    <li>Cleans deleted data</li>
                                </ul>
                            </div>
                            <button class="btn btn-primary" id="vacuum-btn" onclick="vacuumDatabase()" aria-label="Vacuum database">
                                üßπ Vacuum Now
                            </button>
                        </div>

                        <div class="action-card">
                            <div class="action-info">
                                <h3>Test Connection</h3>
                                <p>Verify database connectivity and performance</p>
                                <ul>
                                    <li>Tests read/write access</li>
                                    <li>Measures response time</li>
                                    <li>Validates configuration</li>
                                </ul>
                            </div>
                            <button class="btn btn-secondary" id="test-btn" onclick="testConnection()" aria-label="Test database connection">
                                üîç Test Connection
                            </button>
                        </div>
                    </div>

                    <div id="operation-result" class="alert alert-result hidden" role="status" aria-live="polite"></div>
                </div>
            </section>

            <!-- Cache Management Section -->
            <section class="admin-card" aria-labelledby="cache-heading">
                <div class="card-header">
                    <h2 id="cache-heading">Cache Management</h2>
                    <p class="card-description">Configure and manage application caching (Redis/Valkey)</p>
                </div>
                <div class="card-body">
                    <div class="cache-status">
                        <div class="stat-item">
                            <div class="stat-label">Cache Status</div>
                            <div class="stat-value" id="cache-status">
                                <span class="loading">Loading...</span>
                            </div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Cache Type</div>
                            <div class="stat-value" id="cache-type">-</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Hit Rate</div>
                            <div class="stat-value" id="cache-hitrate">-</div>
                        </div>
                    </div>

                    <div class="alert alert-info my-3" role="status">
                        <strong>Cache Configuration:</strong> Cache is automatically enabled if Redis or Valkey is detected. Configure via environment variables:
                        <code>REDIS_HOST</code>, <code>REDIS_PORT</code>, <code>REDIS_PASSWORD</code>
                    </div>

                    <div class="button-group">
                        <button class="btn btn-warning" id="clear-cache-btn" onclick="clearCache()" aria-label="Clear all cached data">
                            üóëÔ∏è Clear All Cache
                        </button>
                        <button class="btn btn-secondary" onclick="refreshCacheStats()" aria-label="Refresh cache statistics">
                            üîÑ Refresh Cache Stats
                        </button>
                    </div>

                    <div id="cache-result" class="alert alert-result hidden" role="status" aria-live="polite"></div>
                </div>
            </section>

            <!-- Database Configuration Section -->
            <section class="admin-card" aria-labelledby="db-config-heading">
                <div class="card-header">
                    <h2 id="db-config-heading">Database Configuration</h2>
                    <p class="card-description">Configure database connection settings</p>
                </div>
                <div class="card-body">
                    <form id="db-config-form" class="settings-form">
    <input type="hidden" name="csrf_token" value="{{.csrf_token}}">
                        <div class="form-group">
                            <label for="db_driver">Driver</label>
                            <select
                                id="db_driver"
                                name="database.driver"
                                class="form-control"
                                aria-describedby="db_driver_help"
                            >
                                <option value="file">SQLite (file)</option>
                                <option value="sqlite">SQLite</option>
                                <option value="postgres">PostgreSQL</option>
                                <option value="mysql">MySQL</option>
                                <option value="mariadb">MariaDB</option>
                                <option value="mssql">Microsoft SQL Server</option>
                                <option value="mongodb">MongoDB</option>
                            </select>
                            <small id="db_driver_help" class="form-text">
                                Database type (default: file)
                            </small>
                        </div>

                        <div id="remote-db-fields" class="hidden">
                            <div class="form-group">
                                <label for="db_host">Host</label>
                                <input
                                    type="text"
                                    id="db_host"
                                    name="database.host"
                                    class="form-control"
                                    placeholder="localhost"
                                    aria-describedby="db_host_help"
                                >
                                <small id="db_host_help" class="form-text">
                                    Database server hostname or IP address
                                </small>
                            </div>

                            <div class="form-group">
                                <label for="db_port">Port</label>
                                <input
                                    type="number"
                                    id="db_port"
                                    name="database.port"
                                    class="form-control"
                                    min="1"
                                    max="65535"
                                    placeholder="5432"
                                    aria-describedby="db_port_help"
                                >
                                <small id="db_port_help" class="form-text">
                                    Database server port (1-65535)
                                </small>
                            </div>

                            <div class="form-group">
                                <label for="db_name">Database Name</label>
                                <input
                                    type="text"
                                    id="db_name"
                                    name="database.name"
                                    class="form-control"
                                    placeholder="weather"
                                    aria-describedby="db_name_help"
                                >
                                <small id="db_name_help" class="form-text">
                                    Name of the database to connect to
                                </small>
                            </div>

                            <div class="form-group">
                                <label for="db_username">Username</label>
                                <input
                                    type="text"
                                    id="db_username"
                                    name="database.username"
                                    class="form-control"
                                    placeholder="admin"
                                    aria-describedby="db_username_help"
                                >
                                <small id="db_username_help" class="form-text">
                                    Database username for authentication
                                </small>
                            </div>

                            <div class="form-group">
                                <label for="db_password">Password</label>
                                <div class="position-relative">
                                    <input
                                        type="password"
                                        id="db_password"
                                        name="database.password"
                                        class="form-control input-with-toggle"
                                        placeholder="Enter password"
                                        aria-describedby="db_password_help"
                                    >
                                    <button
                                        type="button"
                                        id="toggle-password"
                                        class="btn-toggle-password"
                                        onclick="togglePasswordVisibility()"
                                        aria-label="Toggle password visibility"
                                    >
                                        üëÅÔ∏è
                                    </button>
                                </div>
                                <small id="db_password_help" class="form-text">
                                    Database password for authentication
                                </small>
                            </div>

                            <div id="postgres-fields" class="hidden">
                                <div class="form-group">
                                    <label for="db_sslmode">SSL Mode</label>
                                    <select
                                        id="db_sslmode"
                                        name="database.sslmode"
                                        class="form-control"
                                        aria-describedby="db_sslmode_help"
                                    >
                                        <option value="disable">Disable</option>
                                        <option value="require">Require</option>
                                        <option value="verify-ca">Verify CA</option>
                                        <option value="verify-full">Verify Full</option>
                                    </select>
                                    <small id="db_sslmode_help" class="form-text">
                                        SSL connection mode for PostgreSQL
                                    </small>
                                </div>
                            </div>
                        </div>

                        <div class="button-group mt-3">
                            <button type="button" class="btn btn-secondary" id="test-db-connection-btn" onclick="testDatabaseConnectionConfig()">
                                üîç Test Connection
                            </button>
                        </div>

                        <div class="alert alert-warning my-3" role="status">
                            <strong>‚ö†Ô∏è Warning:</strong> Changes to database configuration require a server restart to take effect.
                        </div>

                        <div id="db-config-result" class="alert alert-result hidden" role="status" aria-live="polite"></div>

                        <div class="button-group">
                            <button type="button" class="btn btn-secondary" onclick="cancelDatabaseConfig()">
                                Cancel
                            </button>
                            <button type="submit" class="btn btn-primary" aria-label="Save database configuration">
                                üíæ Save Configuration
                            </button>
                        </div>
                    </form>
                </div>
            </section>

            <!-- Database Settings Section -->
            <section class="admin-card" aria-labelledby="db-settings-heading">
                <div class="card-header">
                    <h2 id="db-settings-heading">Database Settings</h2>
                    <p class="card-description">Configure database behavior</p>
                </div>
                <div class="card-body">
                    <form id="db-settings-form" class="settings-form">
    <input type="hidden" name="csrf_token" value="{{.csrf_token}}">
                        <div class="form-group">
                            <label for="db_connection_pool">Connection Pool Size</label>
                            <input
                                type="number"
                                id="db_connection_pool"
                                name="database.pool_size"
                                class="form-control"
                                min="1"
                                max="100"
                                placeholder="25"
                                aria-describedby="db_connection_pool_help"
                            >
                            <small id="db_connection_pool_help" class="form-text">
                                Maximum number of database connections (default: 25). Higher values support more concurrent requests.
                            </small>
                        </div>

                        <div class="form-group">
                            <label for="db_timeout">Query Timeout (seconds)</label>
                            <input
                                type="number"
                                id="db_timeout"
                                name="database.timeout"
                                class="form-control"
                                min="1"
                                max="300"
                                placeholder="30"
                                aria-describedby="db_timeout_help"
                            >
                            <small id="db_timeout_help" class="form-text">
                                Maximum time to wait for a query to complete (default: 30 seconds)
                            </small>
                        </div>

                        <div class="form-group">
                            <label class="toggle-label">
                                <input
                                    type="checkbox"
                                    id="db_auto_optimize"
                                    name="database.auto_optimize"
                                    class="toggle-input"
                                    aria-describedby="db_auto_optimize_help"
                                >
                                <span class="toggle-slider"></span>
                                Enable Auto-Optimization
                            </label>
                            <small id="db_auto_optimize_help" class="form-text">
                                Automatically optimize database weekly during low-traffic periods
                            </small>
                        </div>

                        <button type="submit" class="btn btn-primary" aria-label="Save database settings">
                            üíæ Save Settings
                        </button>
                    </form>
                </div>
            </section>
        </main>
    </div>

    <script>
    // Path variables - SPEC compliant (AI.md PART 13)
    const API_PATH = '{{.api_path}}';
    const ADMIN_API_PATH = '{{.admin_api_path}}';

    // Load stats and settings on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadDatabaseStats();
        loadCacheStats();
        loadSettings();
        loadDatabaseConfig();
        setupDatabaseDriverListener();
    });

    async function loadDatabaseStats() {
        try {
            const response = await fetch(ADMIN_API_PATH + '/server/stats');
            const data = await response.json();

            if (data.database) {
                document.getElementById('db-status').innerHTML = '<span class="badge badge-success">‚úÖ Connected</span>';
                document.getElementById('db-type').textContent = data.database.type || 'SQLite';
                document.getElementById('db-size').textContent = formatBytes(data.database.size || 0);
                document.getElementById('db-tables').textContent = data.database.tables || '0';
            } else {
                document.getElementById('db-status').innerHTML = '<span class="badge badge-danger">‚ùå Error</span>';
            }
        } catch (error) {
            console.error('Failed to load database stats:', error);
            document.getElementById('db-status').innerHTML = '<span class="badge badge-danger">‚ùå Error</span>';
        }
    }

    async function loadCacheStats() {
        try {
            const response = await fetch(ADMIN_API_PATH + '/server/stats');
            const data = await response.json();

            if (data.cache && data.cache.enabled) {
                document.getElementById('cache-status').innerHTML = '<span class="badge badge-success">‚úÖ Enabled</span>';
                document.getElementById('cache-type').textContent = data.cache.type || 'Redis';
                document.getElementById('cache-hitrate').textContent = (data.cache.hit_rate || 0) + '%';
            } else {
                document.getElementById('cache-status').innerHTML = '<span class="badge badge-secondary">‚ö™ Disabled</span>';
                document.getElementById('cache-type').textContent = 'None';
                document.getElementById('cache-hitrate').textContent = 'N/A';
            }
        } catch (error) {
            console.error('Failed to load cache stats:', error);
        }
    }

    async function loadSettings() {
        try {
            const response = await fetch(ADMIN_API_PATH + '/server/settings/all');
            const data = await response.json();

            if (data.settings) {
                for (const [key, setting] of Object.entries(data.settings)) {
                    const input = document.querySelector(`[name="${key}"]`);
                    if (input) {
                        if (input.type === 'checkbox') {
                            input.checked = setting.value === 'true';
                        } else {
                            input.value = setting.value || '';
                        }
                    }
                }
            }
        } catch (error) {
            console.error('Failed to load settings:', error);
        }
    }

    async function optimizeDatabase() {
        const btn = document.getElementById('optimize-btn');
        btn.disabled = true;
        btn.textContent = '‚è≥ Optimizing...';

        try {
            const response = await fetch(ADMIN_API_PATH + '/server/database/optimize', {
                method: 'POST'
            });

            const data = await response.json();

            if (response.ok) {
                showOperationResult('‚úÖ Database optimized successfully! Performance improved.', 'success');
                refreshStats();
            } else {
                throw new Error(data.error?.message || 'Optimization failed');
            }
        } catch (error) {
            showOperationResult('‚ùå ' + error.message, 'error');
        } finally {
            btn.disabled = false;
            btn.textContent = '‚ö° Optimize Now';
        }
    }

    async function vacuumDatabase() {
        const btn = document.getElementById('vacuum-btn');
        btn.disabled = true;
        btn.textContent = '‚è≥ Vacuuming...';

        try {
            const response = await fetch(ADMIN_API_PATH + '/server/database/vacuum', {
                method: 'POST'
            });

            const data = await response.json();

            if (response.ok) {
                showOperationResult('‚úÖ Database vacuumed successfully! Space reclaimed.', 'success');
                refreshStats();
            } else {
                throw new Error(data.error?.message || 'Vacuum failed');
            }
        } catch (error) {
            showOperationResult('‚ùå ' + error.message, 'error');
        } finally {
            btn.disabled = false;
            btn.textContent = 'üßπ Vacuum Now';
        }
    }

    async function testConnection() {
        const btn = document.getElementById('test-btn');
        btn.disabled = true;
        btn.textContent = '‚è≥ Testing...';

        try {
            const response = await fetch(ADMIN_API_PATH + '/server/database/test', {
                method: 'POST'
            });

            const data = await response.json();

            if (response.ok) {
                showOperationResult(`‚úÖ Connection test passed! Response time: ${data.response_time || 'N/A'}`, 'success');
            } else {
                throw new Error(data.error?.message || 'Connection test failed');
            }
        } catch (error) {
            showOperationResult('‚ùå ' + error.message, 'error');
        } finally {
            btn.disabled = false;
            btn.textContent = 'üîç Test Connection';
        }
    }

    async function clearCache() {
        if (!await showConfirm('Clear all cached data? This will temporarily slow down the application until cache rebuilds.', 'Clear Cache')) {
            return;
        }

        const btn = document.getElementById('clear-cache-btn');
        btn.disabled = true;
        btn.textContent = '‚è≥ Clearing...';

        try {
            const response = await fetch(ADMIN_API_PATH + '/server/cache/clear', {
                method: 'POST'
            });

            const data = await response.json();

            if (response.ok) {
                showCacheResult('‚úÖ Cache cleared successfully!', 'success');
                refreshCacheStats();
            } else {
                throw new Error(data.error?.message || 'Failed to clear cache');
            }
        } catch (error) {
            showCacheResult('‚ùå ' + error.message, 'error');
        } finally {
            btn.disabled = false;
            btn.textContent = 'üóëÔ∏è Clear All Cache';
        }
    }

    function refreshStats() {
        loadDatabaseStats();
    }

    function refreshCacheStats() {
        loadCacheStats();
    }

    // Settings form submission
    document.getElementById('db-settings-form').addEventListener('submit', async function(e) {
        e.preventDefault();

        const formData = new FormData(this);
        const settings = {};

        for (const [key, value] of formData.entries()) {
            settings[key] = value;
        }

        settings['database.auto_optimize'] = document.getElementById('db_auto_optimize').checked ? 'true' : 'false';

        try {
            const response = await fetch(ADMIN_API_PATH + '/server/settings/bulk', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ settings })
            });

            const data = await response.json();

            if (response.ok) {
                showNotification('Database settings saved successfully', 'success');
            } else {
                throw new Error(data.error?.message || 'Failed to save settings');
            }
        } catch (error) {
            showNotification(error.message, 'error');
        }
    });

    function showOperationResult(message, type) {
        const result = document.getElementById('operation-result');
        result.className = `alert alert-result alert-${type === 'success' ? 'success' : 'danger'}`;
        result.textContent = message;
        result.classList.remove('hidden');

        setTimeout(() => {
            result.classList.add('hidden');
        }, 5000);
    }

    function showCacheResult(message, type) {
        const result = document.getElementById('cache-result');
        result.className = `alert alert-result alert-${type === 'success' ? 'success' : 'danger'}`;
        result.textContent = message;
        result.classList.remove('hidden');

        setTimeout(() => {
            result.classList.add('hidden');
        }, 5000);
    }

    function showNotification(message, type) {
        const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
        const notification = document.createElement('div');
        notification.className = `alert ${alertClass} toast-notification`;
        notification.textContent = message;

        document.body.appendChild(notification);

        setTimeout(() => {
            notification.remove();
        }, 4000);
    }

    function formatBytes(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }

    // Database Configuration Functions
    async function loadDatabaseConfig() {
        try {
            const response = await fetch(ADMIN_API_PATH + '/server/settings/all');
            const data = await response.json();

            if (data.settings) {
                // Load database driver
                const driver = data.settings['database.driver'] || 'file';
                document.getElementById('db_driver').value = driver;

                // Load remote database fields
                document.getElementById('db_host').value = data.settings['database.host'] || '';
                document.getElementById('db_port').value = data.settings['database.port'] || '';
                document.getElementById('db_name').value = data.settings['database.name'] || '';
                document.getElementById('db_username').value = data.settings['database.username'] || '';
                document.getElementById('db_password').value = data.settings['database.password'] || '';
                document.getElementById('db_sslmode').value = data.settings['database.sslmode'] || 'disable';

                // Update field visibility based on driver
                updateDatabaseFieldVisibility(driver);
            }
        } catch (error) {
            console.error('Failed to load database configuration:', error);
        }
    }

    function setupDatabaseDriverListener() {
        const driverSelect = document.getElementById('db_driver');
        driverSelect.addEventListener('change', function() {
            updateDatabaseFieldVisibility(this.value);
        });
    }

    function updateDatabaseFieldVisibility(driver) {
        const remoteFields = document.getElementById('remote-db-fields');
        const postgresFields = document.getElementById('postgres-fields');

        // Show remote fields for all drivers except 'file' and 'sqlite'
        if (driver === 'file' || driver === 'sqlite') {
            remoteFields.classList.add('hidden');
            postgresFields.classList.add('hidden');
        } else {
            remoteFields.classList.remove('hidden');

            // Show SSL mode only for PostgreSQL
            if (driver === 'postgres' || driver === 'postgresql') {
                postgresFields.classList.remove('hidden');
            } else {
                postgresFields.classList.add('hidden');
            }
        }
    }

    function togglePasswordVisibility() {
        const passwordInput = document.getElementById('db_password');
        const toggleButton = document.getElementById('toggle-password');

        if (passwordInput.type === 'password') {
            passwordInput.type = 'text';
            toggleButton.textContent = 'üëÅÔ∏è‚Äçüó®Ô∏è';
        } else {
            passwordInput.type = 'password';
            toggleButton.textContent = 'üëÅÔ∏è';
        }
    }

    async function testDatabaseConnectionConfig() {
        const btn = document.getElementById('test-db-connection-btn');
        btn.disabled = true;
        btn.textContent = '‚è≥ Testing...';

        try {
            const driver = document.getElementById('db_driver').value;
            const config = {
                driver: driver
            };

            // Only include remote DB fields if driver is not file/sqlite
            if (driver !== 'file' && driver !== 'sqlite') {
                config.host = document.getElementById('db_host').value;
                config.port = parseInt(document.getElementById('db_port').value);
                config.name = document.getElementById('db_name').value;
                config.username = document.getElementById('db_username').value;
                config.password = document.getElementById('db_password').value;

                if (driver === 'postgres' || driver === 'postgresql') {
                    config.sslmode = document.getElementById('db_sslmode').value;
                }
            }

            const response = await fetch(ADMIN_API_PATH + '/server/database/test-config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(config)
            });

            const data = await response.json();

            if (response.ok && data.success) {
                showDatabaseConfigResult('‚úÖ Connection test passed! Database is accessible.', 'success');
            } else {
                throw new Error(data.error || 'Connection test failed');
            }
        } catch (error) {
            showDatabaseConfigResult('‚ùå ' + error.message, 'error');
        } finally {
            btn.disabled = false;
            btn.textContent = 'üîç Test Connection';
        }
    }

    function cancelDatabaseConfig() {
        // Reload the current configuration
        loadDatabaseConfig();
        showDatabaseConfigResult('Configuration changes cancelled', 'info');
    }

    // Database configuration form submission
    document.getElementById('db-config-form').addEventListener('submit', async function(e) {
        e.preventDefault();

        const driver = document.getElementById('db_driver').value;
        const settings = {
            'database.driver': driver
        };

        // Only include remote DB fields if driver is not file/sqlite
        if (driver !== 'file' && driver !== 'sqlite') {
            settings['database.host'] = document.getElementById('db_host').value;
            settings['database.port'] = document.getElementById('db_port').value;
            settings['database.name'] = document.getElementById('db_name').value;
            settings['database.username'] = document.getElementById('db_username').value;
            settings['database.password'] = document.getElementById('db_password').value;

            if (driver === 'postgres' || driver === 'postgresql') {
                settings['database.sslmode'] = document.getElementById('db_sslmode').value;
            }

            // Validate required fields for remote databases
            if (!settings['database.host']) {
                showDatabaseConfigResult('‚ùå Host is required for remote databases', 'error');
                return;
            }
            if (!settings['database.port']) {
                showDatabaseConfigResult('‚ùå Port is required for remote databases', 'error');
                return;
            }
            if (!settings['database.name']) {
                showDatabaseConfigResult('‚ùå Database name is required for remote databases', 'error');
                return;
            }
        }

        try {
            const response = await fetch(ADMIN_API_PATH + '/server/settings/database', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(settings)
            });

            const data = await response.json();

            if (response.ok) {
                showDatabaseConfigResult('‚úÖ Database configuration saved successfully! Please restart the server for changes to take effect.', 'success');
            } else {
                throw new Error(data.error || 'Failed to save database configuration');
            }
        } catch (error) {
            showDatabaseConfigResult('‚ùå ' + error.message, 'error');
        }
    });

    function showDatabaseConfigResult(message, type) {
        const result = document.getElementById('db-config-result');
        result.className = `alert alert-result alert-${type === 'success' ? 'success' : type === 'info' ? 'info' : 'danger'}`;
        result.textContent = message;
        result.classList.remove('hidden');

        setTimeout(() => {
            result.classList.add('hidden');
        }, 5000);
    }
    </script>
</body>
</html>
{{end}}
