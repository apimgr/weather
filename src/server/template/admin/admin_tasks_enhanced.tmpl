{{define "admin/admin-tasks-enhanced.tmpl"}}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.title}}</title>
    <link rel="stylesheet" href="/static/css/dracula.css">
</head>
<body>
    <div class="admin-page-header">
        <h1>‚öôÔ∏è Scheduled Tasks Management</h1>
        <div class="admin-page-breadcrumb">
            <a href="/admin">Admin</a> /
            <span>Scheduled Tasks</span>
        </div>
    </div>

    <div class="admin-page-container wide">
        <div class="admin-nav-links">
            <a href="/admin" class="admin-nav-link">‚Üê Dashboard</a>
            <a href="{{.admin_path}}/system" class="admin-nav-link">System Info</a>
        </div>

        <div class="admin-alert admin-alert-success" id="successAlert" role="alert"></div>
        <div class="admin-alert admin-alert-error" id="errorAlert" role="alert"></div>

        <!-- Statistics -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üìä</div>
                <div class="stat-value" id="totalTasks">0</div>
                <div class="stat-label">Total Tasks</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">‚úÖ</div>
                <div class="stat-value" id="enabledTasks">0</div>
                <div class="stat-label">Enabled</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">‚ñ∂Ô∏è</div>
                <div class="stat-value" id="runningTasks">0</div>
                <div class="stat-label">Running Now</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">‚úÖ</div>
                <div class="stat-value" id="successRate">0%</div>
                <div class="stat-label">Success Rate</div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" data-tab="timeline">Timeline</button>
            <button class="tab" data-tab="tasks">Task List</button>
            <button class="tab" data-tab="history">History</button>
            <button class="tab" data-tab="dependencies">Dependencies</button>
        </div>

        <!-- Timeline Tab -->
        <div class="tab-content active" id="timeline">
            <div class="card">
                <h2>24-Hour Task Timeline</h2>
                <div class="timeline">
                    <div class="timeline-track">
                        <div class="timeline-grid" id="timelineGrid"></div>
                        <div id="timelineTasks"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Task List Tab -->
        <div class="tab-content" id="tasks">
            <div class="card">
                <h2>All Tasks</h2>
                <div class="task-list" id="taskList">
                    <div class="text-center text-muted p-3">
                        Loading tasks...
                    </div>
                </div>
            </div>
        </div>

        <!-- History Tab -->
        <div class="tab-content" id="history">
            <div class="card">
                <h2>Execution History</h2>
                <table class="history-table" id="historyTable">
                    <thead>
                        <tr>
                            <th>Task</th>
                            <th>Status</th>
                            <th>Started</th>
                            <th>Duration</th>
                            <th>Result</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="5" class="text-center text-muted p-3">
                                Loading history...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Dependencies Tab -->
        <div class="tab-content" id="dependencies">
            <div class="card">
                <h2>Task Dependencies</h2>
                <div class="dependency-graph" id="dependencyGraph">
                    <svg width="100%" height="400" id="depGraphSvg">
                        <defs>
                            <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                                <polygon points="0 0, 10 3, 0 6" fill="#95a5a6" />
                            </marker>
                        </defs>
                    </svg>
                </div>
            </div>
        </div>
    </div>

    <script>
        let tasks = [];
        let currentTab = 'timeline';

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

                tab.classList.add('active');
                document.getElementById(tab.dataset.tab).classList.add('active');
                currentTab = tab.dataset.tab;

                if (currentTab === 'history') loadHistory();
                if (currentTab === 'dependencies') renderDependencyGraph();
            });
        });

        // Load tasks
        async function loadTasks() {
            try {
                const response = await fetch('/api/v1/admin/tasks');
                const data = await response.json();
                tasks = data.tasks || [];

                updateStats();
                renderTaskList();
                renderTimeline();
            } catch (error) {
                showError('Failed to load tasks: ' + error.message);
            }
        }

        // Update statistics
        function updateStats() {
            const enabled = tasks.filter(t => t.enabled).length;
            const running = tasks.filter(t => t.running).length;
            const total = tasks.length;

            document.getElementById('totalTasks').textContent = total;
            document.getElementById('enabledTasks').textContent = enabled;
            document.getElementById('runningTasks').textContent = running;

            // Calculate success rate from recent history
            const successRate = 95; // Placeholder
            document.getElementById('successRate').textContent = successRate + '%';
        }

        // Render task list
        function renderTaskList() {
            const container = document.getElementById('taskList');

            if (tasks.length === 0) {
                container.innerHTML = '<div class="text-center text-muted p-3">No tasks configured</div>';
                return;
            }

            container.innerHTML = tasks.map(task => `
                <div class="task-item">
                    <div class="task-status ${task.enabled ? 'enabled' : 'disabled'} ${task.running ? 'running' : ''}"></div>
                    <div class="task-info">
                        <div class="task-name">${task.name}</div>
                        <div class="task-schedule">Every ${formatInterval(task.interval)}</div>
                    </div>
                    <div class="task-stats">
                        <span>Last: ${task.lastRun || 'Never'}</span>
                        <span>Next: ${task.nextRun || '-'}</span>
                    </div>
                    <div class="task-actions">
                        <button class="btn btn-sm btn-primary" onclick="triggerTask('${task.name}')">‚ñ∂Ô∏è Run</button>
                        <button class="btn btn-sm ${task.enabled ? 'btn-danger' : 'btn-success'}"
                                onclick="toggleTask('${task.name}', ${task.enabled})">
                            ${task.enabled ? '‚è∏Ô∏è Disable' : '‚ñ∂Ô∏è Enable'}
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Render timeline
        function renderTimeline() {
            const grid = document.getElementById('timelineGrid');
            const tasksContainer = document.getElementById('timelineTasks');

            // Create 24-hour grid
            let gridHTML = '';
            for (let i = 0; i < 24; i++) {
                gridHTML += `<div class="timeline-hour"><span class="timeline-label">${i}:00</span></div>`;
            }
            grid.innerHTML = gridHTML;

            // Plot tasks on timeline
            tasksContainer.innerHTML = tasks.map((task, index) => {
                const hourPos = getHourPosition(task.interval);
                return `
                    <div class="timeline-task ${task.running ? 'running' : ''}"
                         style="left: ${hourPos}%; top: ${(index % 3) * 30 + 10}px; width: 8%;"
                         title="${task.name}">
                        ${task.name}
                    </div>
                `;
            }).join('');
        }

        // Get hour position from interval
        function getHourPosition(interval) {
            // Convert interval to hours and calculate position
            const hours = parseInterval(interval);
            return (hours / 24) * 100;
        }

        // Parse interval string to hours
        function parseInterval(interval) {
            if (interval.includes('h')) return parseInt(interval);
            if (interval.includes('m')) return parseInt(interval) / 60;
            if (interval.includes('s')) return parseInt(interval) / 3600;
            return 1;
        }

        // Format interval for display
        function formatInterval(interval) {
            return interval || '1 hour';
        }

        // Load execution history
        async function loadHistory() {
            try {
                const response = await fetch('/api/v1/admin/tasks/history');
                const data = await response.json();

                const tbody = document.getElementById('historyTable').querySelector('tbody');
                tbody.innerHTML = data.history.map(h => `
                    <tr>
                        <td>${h.task}</td>
                        <td><span class="badge badge-${h.status === 'success' ? 'success' : 'danger'}">${h.status}</span></td>
                        <td>${new Date(h.startedAt).toLocaleString()}</td>
                        <td>${h.duration}</td>
                        <td>${h.result || '-'}</td>
                    </tr>
                `).join('');
            } catch (error) {
                showError('Failed to load history: ' + error.message);
            }
        }

        // Render dependency graph
        function renderDependencyGraph() {
            // Simplified dependency visualization
            const graph = document.getElementById('dependencyGraph');
            graph.innerHTML = `
                <div class="text-center text-muted p-4">
                    <p>Task Dependency Graph</p>
                    <p class="mt-2 text-sm">
                        Most tasks run independently. Complex dependencies can be configured via API.
                    </p>
                </div>
            `;
        }

        // Trigger task
        async function triggerTask(name) {
            if (!await showConfirm(`Manually trigger task: ${name}?`, 'Trigger Task')) return;

            try {
                const response = await fetch(`/api/v1/admin/tasks/${name}/trigger`, { method: 'POST' });
                if (!response.ok) throw new Error('Failed to trigger task');

                showSuccess(`Task "${name}" triggered successfully!`);
                setTimeout(loadTasks, 1000);
            } catch (error) {
                showError('Failed to trigger task: ' + error.message);
            }
        }

        // Toggle task enabled state
        async function toggleTask(name, currentlyEnabled) {
            const action = currentlyEnabled ? 'disable' : 'enable';

            try {
                const response = await fetch(`/api/v1/admin/tasks/${name}/${action}`, { method: 'POST' });
                if (!response.ok) throw new Error(`Failed to ${action} task`);

                showSuccess(`Task "${name}" ${action}d successfully!`);
                loadTasks();
            } catch (error) {
                showError(`Failed to ${action} task: ` + error.message);
            }
        }

        // Show messages
        function showSuccess(msg) {
            const alert = document.getElementById('successAlert');
            alert.textContent = msg;
            alert.classList.add('show');
            setTimeout(() => alert.classList.remove('show'), 5000);
        }

        function showError(msg) {
            const alert = document.getElementById('errorAlert');
            alert.textContent = msg;
            alert.classList.add('show');
            setTimeout(() => alert.classList.remove('show'), 5000);
        }

        // Initial load
        loadTasks();

        // Auto-refresh every 10 seconds
        setInterval(loadTasks, 10000);
    </script>
</body>
</html>
{{end}}
