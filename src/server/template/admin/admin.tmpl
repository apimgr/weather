{{template "head" .}}

{{template "navbar" .}}

<div class="admin-container">
        <div class="admin_header">
            <h1>Admin Panel</h1>
            <p class="text-comment">Manage users, settings, and system configuration</p>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <h3>Total Users</h3>
                <div class="stat-value">{{ .totalUsers }}</div>
            </div>
            <div class="stat-card">
                <h3>Admin Users</h3>
                <div class="stat-value">{{ .adminCount }}</div>
            </div>
            <div class="stat-card">
                <h3>Total Locations</h3>
                <div class="stat-value">{{ .totalLocations }}</div>
            </div>
            <div class="stat-card">
                <h3>System Status</h3>
                <div class="stat-value admin-stat-value-online">‚úì Online</div>
            </div>
        </div>

        <div class="admin-tabs">
            <button class="tab active" data-tab="users">Users</button>
            <button class="tab" data-tab="settings">Settings</button>
            <button class="tab" data-tab="web">Web</button>
            <button class="tab" data-tab="security">Security</button>
            <button class="tab" data-tab="database">Database</button>
            <button class="tab" data-tab="ssl">SSL/TLS</button>
            <button class="tab" data-tab="backup">Backup</button>
            <button class="tab" data-tab="tokens">API Tokens</button>
            <button class="tab" data-tab="logs">Audit Logs</button>
            <button class="tab" data-tab="tasks">Scheduled Tasks</button>
        </div>

        <div id="users" class="tab-content active">
            <div class="admin-section">
                <div class="section-header">
                    <h2>User Management</h2>
                    <button class="btn btn-primary" onclick="showAddUserModal()">+ Add User</button>
                </div>
                <div id="users-list" class="overflow-auto">
                    <p class="admin-loading-text">Loading users...</p>
                </div>
            </div>
        </div>

        <div id="settings" class="tab-content">
            <div class="admin-section">
                <div class="section-header">
                    <h2>Server Settings</h2>
                    <button class="btn btn-success" onclick="applyAllSettings()" id="apply-settings-btn">‚úì Apply All & Reload</button>
                </div>
                <div id="settings-list" class="overflow-auto">
                    <p class="loading-text">Loading settings...</p>
                </div>
            </div>
        </div>

        <div id="web" class="tab-content">
            <div class="admin-section">
                <div class="section-header">
                    <h2>Web Settings</h2>
                    <button class="btn btn-success" onclick="saveWebSettings()">üíæ Save Changes</button>
                </div>

                <div class="settings-form">
                    <div class="form-group">
                        <label class="form-label">Site Title</label>
                        <input type="text" id="web-title" class="form-input" value="Weather Service">
                        <small class="text-comment">Shown in browser tab and navbar</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Site Tagline</label>
                        <input type="text" id="web-tagline" class="form-input" value="Production-grade weather API">
                        <small class="text-comment">Short description of your service</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Footer Text</label>
                        <textarea id="web-footer" class="form-input" rows="2">Production-grade forecasts, alerts, and you data</textarea>
                        <small class="text-comment">Text shown in page footer</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Theme</label>
                        <select id="web-theme" class="form-input">
                            <option value="dracula" selected>Dracula (Dark)</option>
                            <option value="light">Light</option>
                            <option value="auto">Auto (System)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Items Per Page</label>
                        <input type="number" id="web-page-size" class="form-input" value="50" min="10" max="500">
                        <small class="text-comment">Number of items shown in lists</small>
                    </div>

                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="web-analytics" checked>
                            Enable Analytics
                        </label>
                        <small class="text-comment">Track page views and usage (privacy-focused)</small>
                    </div>
                </div>
            </div>
        </div>

        <div id="security" class="tab-content">
            <div class="admin-section">
                <div class="section-header">
                    <h2>Security Settings</h2>
                    <button class="btn btn-success" onclick="saveSecuritySettings()">üíæ Save Changes</button>
                </div>

                <div class="settings-form">
                    <h3 class="admin-section-title">Rate Limiting</h3>

                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="sec-ratelimit-enabled" checked>
                            Enable Rate Limiting
                        </label>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Global Rate Limit</label>
                            <input type="number" id="sec-global-limit" class="form-input" value="100">
                            <small class="text-comment">Requests per second (all users)</small>
                        </div>

                        <div class="form-group">
                            <label class="form-label">API Rate Limit</label>
                            <input type="number" id="sec-api-limit" class="form-input" value="100">
                            <small class="text-comment">Requests per 15 minutes (per IP)</small>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Admin Rate Limit</label>
                            <input type="number" id="sec-admin-limit" class="form-input" value="30">
                            <small class="text-comment">Requests per 15 minutes (per IP)</small>
                        </div>
                    </div>

                    <hr class="admin-hr">

                    <h3 class="admin-section-title">Security Headers</h3>

                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="sec-hsts" checked>
                            Enable HSTS (HTTP Strict Transport Security)
                        </label>
                        <small class="text-comment">Force HTTPS connections</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Content Security Policy</label>
                        <textarea id="sec-csp" class="form-input" rows="3">default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'</textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Blocked IP Addresses</label>
                        <textarea id="sec-blocked-ips" class="form-input" rows="4" placeholder="One IP per line&#10;192.168.1.100&#10;10.0.0.50"></textarea>
                        <small class="text-comment">IPs blocked from accessing the service</small>
                    </div>

                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="sec-require-https" checked>
                            Require HTTPS (Redirect HTTP ‚Üí HTTPS)
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <div id="database" class="tab-content">
            <div class="admin-section">
                <div class="section-header">
                    <h2>Database & Cache</h2>
                    <button class="btn btn-primary" onclick="testDatabaseConnection()">üîå Test Connection</button>
                </div>

                <div class="stats-grid margin-bottom-2">
                    <div class="stat-card">
                        <h3>Database Type</h3>
                        <div class="stat-value admin-stat-value-medium">SQLite</div>
                    </div>
                    <div class="stat-card">
                        <h3>Database Size</h3>
                        <div class="stat-value admin-stat-value-medium">2.4 MB</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total Records</h3>
                        <div class="stat-value admin-stat-value-medium">1,247</div>
                    </div>
                    <div class="stat-card">
                        <h3>Cache Hit Rate</h3>
                        <div class="stat-value admin-stat-value-medium-success">94%</div>
                    </div>
                </div>

                <div class="settings-form">
                    <h3 class="admin-section-title">Cache Settings</h3>

                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="db-cache-enabled" checked>
                            Enable In-Memory Cache
                        </label>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Weather Cache TTL</label>
                            <input type="number" id="db-weather-ttl" class="form-input" value="1800">
                            <small class="text-comment">Seconds (30 minutes = 1800)</small>
                        </div>

                        <div class="form-group">
                            <label class="form-label">GeoIP Cache TTL</label>
                            <input type="number" id="db-geoip-ttl" class="form-input" value="86400">
                            <small class="text-comment">Seconds (24 hours = 86400)</small>
                        </div>
                    </div>

                    <hr class="admin-hr">

                    <h3 class="admin-section-title">Database Maintenance</h3>

                    <div class="form-group">
                        <button class="btn btn-warning" onclick="optimizeDatabase()">‚ö° Optimize Database</button>
                        <button class="btn btn-warning" onclick="clearCache()">üóëÔ∏è Clear All Cache</button>
                        <button class="btn btn-danger" onclick="vacuumDatabase()">üßπ Vacuum Database</button>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Auto-Cleanup</label>
                        <div class="checkbox-label">
                            <input type="checkbox" id="db-auto-cleanup" checked>
                            Automatically cleanup old logs and sessions
                        </div>
                        <small class="text-comment">Runs daily at 3am UTC</small>
                    </div>
                </div>
            </div>
        </div>

        <div id="ssl" class="tab-content">
            <div class="admin-section">
                <div class="section-header">
                    <h2>SSL/TLS Management</h2>
                    <button class="btn btn-primary" onclick="testSSLCertificate()">üîç Verify Certificate</button>
                </div>

                <div class="settings-form">
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="ssl-enabled">
                            Enable SSL/TLS
                        </label>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Certificate File Path</label>
                        <input type="text" id="ssl-cert" class="form-input" placeholder="/etc/apimgr/weather/ssl/certs/cert.pem">
                        <small class="text-comment">Path to SSL certificate (.pem or .crt)</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Private Key File Path</label>
                        <input type="text" id="ssl-key" class="form-input" placeholder="/etc/apimgr/weather/ssl/certs/key.pem">
                        <small class="text-comment">Path to private key file</small>
                    </div>

                    <hr class="admin-hr">

                    <h3 class="admin-section-title">Let's Encrypt (ACME)</h3>

                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="ssl-acme-enabled">
                            Enable Automatic SSL (Let's Encrypt)
                        </label>
                        <small class="text-comment">Automatically obtain and renew SSL certificates</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Domain Name</label>
                        <input type="text" id="ssl-domain" class="form-input" placeholder="weather.example.com">
                        <small class="text-comment">Your fully qualified domain name</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Contact Email</label>
                        <input type="email" id="ssl-email" class="form-input" placeholder="admin@example.com">
                        <small class="text-comment">For renewal notifications</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">ACME Provider</label>
                        <select id="ssl-provider" class="form-input">
                            <option value="letsencrypt">Let's Encrypt</option>
                            <option value="zerossl">ZeroSSL</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <button class="btn btn-success" onclick="obtainCertificate()">üîê Obtain Certificate</button>
                        <button class="btn btn-primary" onclick="renewCertificate()">üîÑ Renew Certificate</button>
                    </div>

                    <div class="info-box">
                        <strong>Note:</strong> Automatic SSL requires your domain to point to this server and port 80/443 to be accessible.
                    </div>
                </div>
            </div>
        </div>

        <div id="backup" class="tab-content">
            <div class="admin-section">
                <div class="section-header">
                    <h2>Backup & Restore</h2>
                    <button class="btn btn-primary" onclick="createBackup()">üíæ Create Backup Now</button>
                </div>

                <div class="stats-grid margin-bottom-2">
                    <div class="stat-card">
                        <h3>Last Backup</h3>
                        <div class="stat-value admin-stat-value-medium">2 hours ago</div>
                    </div>
                    <div class="stat-card">
                        <h3>Backup Size</h3>
                        <div class="stat-value admin-stat-value-medium">3.2 MB</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total Backups</h3>
                        <div class="stat-value admin-stat-value-medium">12</div>
                    </div>
                    <div class="stat-card">
                        <h3>Auto-Backup</h3>
                        <div class="stat-value admin-stat-value-medium-success">‚úì Enabled</div>
                    </div>
                </div>

                <div class="settings-form">
                    <h3 class="admin-section-title">Auto-Backup Settings</h3>

                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="backup-enabled" checked>
                            Enable Automatic Backups
                        </label>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Backup Interval</label>
                            <select id="backup-interval" class="form-input">
                                <option value="3600">Hourly</option>
                                <option value="21600" selected>Every 6 hours</option>
                                <option value="43200">Every 12 hours</option>
                                <option value="86400">Daily</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Retention Count</label>
                            <input type="number" id="backup-retention" class="form-input" value="7" min="1" max="30">
                            <small class="text-comment">Keep last N backups</small>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Backup Directory</label>
                        <input type="text" id="backup-path" class="form-input" value="/mnt/Backups/apimgr/weather">
                        <small class="text-comment">Where backups are stored</small>
                    </div>

                    <hr class="admin-hr">

                    <h3 class="admin-section-title">Available Backups</h3>

                    <div id="backup-list">
                        <p class="text-comment">Loading backups...</p>
                    </div>

                    <hr class="admin-hr">

                    <h3 class="admin-section-title">Restore from Backup</h3>

                    <div class="form-group">
                        <label class="form-label">Upload Backup File</label>
                        <input type="file" id="backup-upload" class="form-input" accept=".tar.gz,.tgz">
                        <button class="btn btn-warning margin-top-05" onclick="restoreBackup()">üì¶ Restore Backup</button>
                    </div>

                    <div class="warning-box">
                        <strong>‚ö†Ô∏è Warning:</strong> Restoring a backup will replace all current data. The server will restart after restore.
                    </div>
                </div>
            </div>
        </div>

        <div id="tokens" class="tab-content">
            <div class="admin-section">
                <div class="section-header">
                    <h2>API Token Management</h2>
                    <button class="btn btn-primary" onclick="showGenerateTokenModal()">+ Generate Token</button>
                </div>
                <div id="tokens-list" class="overflow-auto">
                    <p class="admin-loading-text">Loading tokens...</p>
                </div>
            </div>
        </div>

        <div id="logs" class="tab-content">
            <div class="admin-section">
                <div class="section-header">
                    <h2>Audit Logs</h2>
                    <button class="btn btn-danger" onclick="clearAuditLogs()">Clear Old Logs</button>
                </div>
                <div id="logs-list" class="overflow-auto">
                    <p class="admin-loading-text">Loading logs...</p>
                </div>
            </div>
        </div>

        <div id="tasks" class="tab-content">
            <div class="admin-section">
                <div class="section-header">
                    <h2>Scheduled Tasks</h2>
                </div>
                <div id="tasks-list" class="overflow-auto">
                    <p class="admin-loading-text">Loading scheduled tasks...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configurable paths per AI.md PART 17
        const API_PATH = '{{.api_path}}';
        const ADMIN_API_PATH = '{{.admin_api_path}}';
        const ADMIN_PATH = '{{.admin_path}}';

        // Tab switching
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');

        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => t.classList.remove('active'));
                tabContents.forEach(tc => tc.classList.remove('active'));

                tab.classList.add('active');
                const tabId = tab.getAttribute('data-tab');
                document.getElementById(tabId).classList.add('active');

                // Load data when tab is clicked
                if (tabId === 'users') loadUsers();
                if (tabId === 'settings') loadSettings();
                if (tabId === 'tokens') loadTokens();
                if (tabId === 'logs') loadLogs();
                if (tabId === 'tasks') loadScheduledTasks();
            });
        });

        // Load users on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadUsers();
        });

        // User Management
        async function loadUsers() {
            try {
                const response = await fetch(`${ADMIN_API_PATH}/users');
                const users = await response.json();

                const html = `
                    <table class="admin-table-full">
                        <thead>
                            <tr class="admin-table-head-row">
                                <th class="admin-table-head-cell">ID</th>
                                <th class="admin-table-head-cell">Email</th>
                                <th class="admin-table-head-cell">Role</th>
                                <th class="admin-table-head-cell">Created</th>
                                <th class="admin-table-head-cell-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${users.map(user => {
                                // Protect first admin (ID 1) from deletion
                                const isFirstAdmin = user.id === 1;
                                const actionButtons = isFirstAdmin
                                    ? `<button onclick="editAdminUser(${user.id}, '${user.email}')" class="btn-edit">Edit</button>`
                                    : `<button onclick="deleteUser(${user.id})" class="btn-delete">Delete</button>`;

                                return `
                                <tr class="admin-table-body-row">
                                    <td class="admin-table-body-cell">${user.id}${isFirstAdmin ? ' <span class="admin-user-primary">(Primary)</span>' : ''}</td>
                                    <td class="admin-table-body-cell">${user.email}</td>
                                    <td class="admin-table-body-cell"><span class="${user.role === 'admin' ? 'admin-role-badge-admin' : 'admin-role-badge'}">${user.role}</span></td>
                                    <td class="admin-table-body-cell">${new Date(user.created_at).toLocaleDateString()}</td>
                                    <td class="admin-table-body-cell-right">
                                        ${actionButtons}
                                    </td>
                                </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
                document.getElementById('users-list').innerHTML = html;
            } catch (error) {
                document.getElementById('users-list').innerHTML = '<p class="admin-error-text">Error loading users</p>';
            }
        }

        async function deleteUser(id) {
            const confirmed = await showConfirm('Are you sure you want to delete this user? This action cannot be undone.', 'Delete User');
            if (!confirmed) return;

            try {
                await fetch(`${ADMIN_API_PATH}/server/users/${id}`, { method: 'DELETE' });
                Toast.success('User deleted successfully');
                loadUsers();
            } catch (error) {
                Toast.error('Failed to delete user');
            }
        }

        async function editAdminUser(userId, currentEmail) {
            const modalId = 'edit-admin-modal-' + Date.now();

            Modal.create({
                id: modalId,
                title: 'Edit Primary Admin Account',
                body: `
                    <form id="editAdminForm">
    <input type="hidden" name="csrf_token" value="{{.csrf_token}}">
                        <div class="form-group">
                            <label for="editAdminEmail">Email Address</label>
                            <input type="email" id="editAdminEmail" class="form-input" required value="${currentEmail}" placeholder="admin@example.com">
                            <small class="text-comment">Update the email address for this account</small>
                        </div>
                        <div class="form-group">
                            <label for="editAdminPassword">New Password (optional)</label>
                            <input type="password" id="editAdminPassword" class="form-input" minlength="8" placeholder="Leave blank to keep current password">
                            <small class="text-comment">Minimum 8 characters (leave blank to keep current password)</small>
                        </div>
                        <div class="form-group">
                            <label for="editAdminPasswordConfirm">Confirm New Password</label>
                            <input type="password" id="editAdminPasswordConfirm" class="form-input" minlength="8" placeholder="Re-enter new password">
                            <small class="text-comment">Must match the new password above</small>
                        </div>
                        <div class="admin-settings-note">
                            <p class="admin-settings-note-text">
                                ‚ÑπÔ∏è <strong>Note:</strong> This is the primary admin account and cannot be deleted. You can update the email and/or password.
                            </p>
                        </div>
                    </form>
                `,
                footer: `
                    <button class="btn btn-secondary" onclick="Modal.close('${modalId}')">Cancel</button>
                    <button class="btn btn-primary" onclick="updateAdminUser(${userId}, '${modalId}')">Update Account</button>
                `,
                size: 'md'
            });
        }

        async function updateAdminUser(userId, modalId) {
            const email = document.getElementById('editAdminEmail').value;
            const password = document.getElementById('editAdminPassword').value;
            const passwordConfirm = document.getElementById('editAdminPasswordConfirm').value;

            if (!email) {
                Toast.error('Please enter an email address');
                return;
            }

            // Validate password if provided
            if (password || passwordConfirm) {
                if (password !== passwordConfirm) {
                    Toast.error('Passwords do not match');
                    return;
                }
                if (password.length < 8) {
                    Toast.error('Password must be at least 8 characters');
                    return;
                }
            }

            try {
                // Update email if changed
                const updateData = { email: email };
                const response = await fetch(`${ADMIN_API_PATH}/server/users/${userId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updateData)
                });

                if (!response.ok) {
                    throw new Error('Failed to update user');
                }

                // Update password if provided
                if (password) {
                    const pwResponse = await fetch(`${ADMIN_API_PATH}/server/users/${userId}/password`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ password: password })
                    });

                    if (!pwResponse.ok) {
                        throw new Error('Failed to update password');
                    }
                }

                Modal.close(modalId);
                Toast.success('Admin account updated successfully');
                loadUsers();
            } catch (error) {
                Toast.error('Failed to update admin account: ' + error.message);
            }
        }

        function showAddUserModal() {
            const modalId = 'add-user-modal-' + Date.now();

            Modal.create({
                id: modalId,
                title: 'Add New User',
                body: `
                    <form id="addUserForm">
    <input type="hidden" name="csrf_token" value="{{.csrf_token}}">
                        <div class="form-group">
                            <label for="newUsername">Username</label>
                            <input type="text" id="newUsername" class="form-input" required placeholder="username" pattern="[a-zA-Z0-9_]+" minlength="3" maxlength="50">
                            <small class="text-comment">3-50 characters, letters, numbers, and underscores only</small>
                        </div>
                        <div class="form-group">
                            <label for="newUserEmail">Email Address</label>
                            <input type="email" id="newUserEmail" class="form-input" required placeholder="user@example.com">
                        </div>
                        <div class="form-group">
                            <label for="newUserPassword">Password</label>
                            <input type="password" id="newUserPassword" class="form-input" required minlength="8" placeholder="Minimum 8 characters">
                            <small class="text-comment">Minimum 8 characters</small>
                        </div>
                        <div class="form-group">
                            <label for="newUserRole">Role</label>
                            <select id="newUserRole" class="form-input">
                                <option value="user">User</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                    </form>
                `,
                footer: `
                    <button class="btn btn-secondary" onclick="Modal.close('${modalId}')">Cancel</button>
                    <button class="btn btn-primary" onclick="createUserFromModal('${modalId}')">Create User</button>
                `,
                size: 'md'
            });
        }

        async function createUserFromModal(modalId) {
            const username = document.getElementById('newUsername').value;
            const email = document.getElementById('newUserEmail').value;
            const password = document.getElementById('newUserPassword').value;
            const role = document.getElementById('newUserRole').value;

            if (!username || !email || !password) {
                Toast.error('Please fill in all fields');
                return;
            }

            if (password.length < 8) {
                Toast.error('Password must be at least 8 characters');
                return;
            }

            try {
                const response = await fetch(`${ADMIN_API_PATH}/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, email, password, role })
                });

                if (!response.ok) {
                    throw new Error('Failed to create user');
                }

                Modal.close(modalId);
                Toast.success('User created successfully');
                loadUsers();
            } catch (error) {
                Toast.error('Failed to create user: ' + error.message);
            }
        }

        // Settings Management with inline editing
        async function loadSettings() {
            try {
                const response = await fetch(`${ADMIN_API_PATH}/settings');
                const settings = await response.json();

                // Group settings by category
                const grouped = {};
                settings.forEach(setting => {
                    const category = setting.key.split('.')[0];
                    if (!grouped[category]) grouped[category] = [];
                    grouped[category].push(setting);
                });

                // Category display names
                const categoryNames = {
                    'server': 'üåê Server',
                    'auth': 'üîê Authentication',
                    'rate_limit': '‚è±Ô∏è Rate Limiting',
                    'smtp': 'üìß Email (SMTP)',
                    'notifications': 'üîî Notifications',
                    'weather': 'üå§Ô∏è Weather',
                    'alerts': '‚ö†Ô∏è Alerts',
                    'backup': 'üíæ Backup',
                    'log': 'üìù Logging',
                    'audit': 'üìã Audit',
                    'security': 'üîí Security',
                    'features': '‚ú® Features'
                };

                // Format setting key into readable label
                function formatSettingLabel(key) {
                    const labelMap = {
                        'smtp.test_recipient': 'Test Email Recipient',
                        'smtp.from_address': 'From Email Address',
                        'smtp.from_name': 'From Name',
                        'smtp.use_tls': 'Use TLS/SSL',
                        'smtp.password': 'SMTP Password',
                        'auth.session_timeout': 'Session Timeout (seconds)',
                        'rate_limit.anonymous': 'Anonymous Rate Limit',
                        'rate_limit.window': 'Rate Limit Window (seconds)',
                        'log.format': 'Log Format',
                        'log.level': 'Log Level',
                        'backup.enabled': 'Enable Backups',
                        'backup.interval': 'Backup Interval (seconds)',
                        'alerts.enabled': 'Enable Weather Alerts',
                        'alerts.check_interval': 'Alert Check Interval (seconds)',
                        'weather.refresh_interval': 'Weather Cache Refresh (seconds)',
                        'notifications.enabled': 'Enable Notifications',
                        'notifications.retry_max': 'Max Retry Attempts',
                        'notifications.queue_workers': 'Queue Workers',
                        'notifications.retry_backoff': 'Retry Backoff Strategy'
                    };

                    // Check if we have a custom label
                    if (labelMap[key]) {
                        return labelMap[key];
                    }

                    // Otherwise, transform the key
                    const parts = key.split('.');
                    const lastPart = parts[parts.length - 1];
                    return lastPart
                        .replace(/_/g, ' ')
                        .split(' ')
                        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                        .join(' ');
                }

                let html = '';
                for (const [category, categorySettings] of Object.entries(grouped)) {
                    const displayName = categoryNames[category] || category;
                    html += `
                        <div class="settings-category">
                            <h3 class="settings-category-title">${displayName}</h3>
                            <div class="settings-grid">
                                ${categorySettings.map(setting => {
                                    const name = formatSettingLabel(setting.key);
                                    const isBool = setting.value === 'true' || setting.value === 'false';
                                    const isNumber = !isNaN(setting.value) && setting.value !== '' && setting.value !== null;
                                    const isPassword = setting.key.includes('password');

                                    // Enum fields with specific values
                                    const enumFields = {
                                        'log.level': ['info', 'debug', 'warn', 'error'],
                                        'log.format': ['apache', 'json'],
                                        'notifications.retry_backoff': ['linear', 'exponential']
                                    };

                                    let inputHtml = '';

                                    if (isBool) {
                                        // Use custom checkbox for boolean fields
                                        const checked = setting.value === 'true' ? 'checked' : '';
                                        inputHtml = `
                                            <label class="custom-checkbox">
                                                <input type="checkbox" data-key="${setting.key}" ${checked}
                                                       onchange="markSettingChanged('${setting.key}')">
                                                <span class="checkbox-checkmark"></span>
                                                <span class="checkbox-label">${checked ? 'Enabled' : 'Disabled'}</span>
                                            </label>
                                        `;
                                    } else if (enumFields[setting.key]) {
                                        // Use dropdown for enum fields
                                        const options = enumFields[setting.key].map(opt =>
                                            `<option value="${opt}" ${setting.value === opt ? 'selected' : ''}>${opt.charAt(0).toUpperCase() + opt.slice(1)}</option>`
                                        ).join('');
                                        inputHtml = `
                                            <select class="form-input" data-key="${setting.key}" onchange="markSettingChanged('${setting.key}')">
                                                ${options}
                                            </select>
                                        `;
                                    } else if (isPassword) {
                                        // Use password input for password fields
                                        inputHtml = `
                                            <input type="password" class="form-input" data-key="${setting.key}"
                                                   value="${setting.value}" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onchange="markSettingChanged('${setting.key}')">
                                        `;
                                    } else if (isNumber) {
                                        // Use number input for numeric fields
                                        inputHtml = `
                                            <input type="number" class="form-input" data-key="${setting.key}"
                                                   value="${setting.value}" min="0" onchange="markSettingChanged('${setting.key}')">
                                        `;
                                    } else {
                                        // Default to text input
                                        inputHtml = `
                                            <input type="text" class="form-input" data-key="${setting.key}"
                                                   value="${setting.value}" onchange="markSettingChanged('${setting.key}')">
                                        `;
                                    }

                                    return `
                                        <div class="setting-item">
                                            <div class="setting-info">
                                                <div class="setting-name">${name}</div>
                                                <div class="setting-key">${setting.key}</div>
                                                ${setting.description ? `<div class="setting-description">${setting.description}</div>` : ''}
                                            </div>
                                            <div class="setting-value">
                                                ${inputHtml}
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }

                document.getElementById('settings-list').innerHTML = html;
            } catch (error) {
                console.error('Error loading settings:', error);
                document.getElementById('settings-list').innerHTML = '<p class="text-error text-center">Error loading settings: ' + error.message + '</p>';
            }
        }

        const changedSettings = new Set();

        function markSettingChanged(key) {
            changedSettings.add(key);
            const applyBtn = document.getElementById('apply-settings-btn');
            if (changedSettings.size > 0) {
                applyBtn.textContent = `‚úì Apply ${changedSettings.size} Change(s) & Reload`;
                applyBtn.classList.add('btn-warning');
            }
        }

        async function applyAllSettings() {
            if (changedSettings.size === 0) {
                await showAlert('No changes to apply', 'Info');
                return;
            }

            const confirmApply = await showConfirm(
                `Apply ${changedSettings.size} setting(s) and reload server configuration?`,
                'Apply Settings'
            );
            if (!confirmApply) return;

            const applyBtn = document.getElementById('apply-settings-btn');
            applyBtn.disabled = true;
            applyBtn.textContent = '‚è≥ Applying...';

            try {
                const updates = {};
                const inputs = document.querySelectorAll('[data-key]');
                inputs.forEach(input => {
                    if (changedSettings.has(input.dataset.key)) {
                        updates[input.dataset.key] = input.value;
                    }
                });

                await fetch(`${ADMIN_API_PATH}/settings/bulk', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ settings: updates })
                });

                await fetch(`${ADMIN_API_PATH}/reload', { method: 'POST' });

                Modal.create({
                    title: '‚úÖ Settings Applied',
                    body: `<p class="modal-body-text-center">
                        ${changedSettings.size} setting(s) applied successfully.<br>
                        Server configuration reloaded.
                    </p>`,
                    size: 'sm',
                    autoClose: 3,
                    closeable: true
                });

                changedSettings.clear();
                applyBtn.textContent = '‚úì Apply All & Reload';
                applyBtn.classList.remove('btn-warning');
                applyBtn.disabled = false;

                setTimeout(() => loadSettings(), 500);

            } catch (error) {
                applyBtn.disabled = false;
                applyBtn.textContent = '‚úì Apply All & Reload';
                await showAlert('Failed to apply settings: ' + error.message, 'Error');
            }
        }

        // Token Management
        async function loadTokens() {
            try {
                const response = await fetch(`${ADMIN_API_PATH}/tokens');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const tokens = await response.json();

                // Handle empty array
                if (!Array.isArray(tokens) || tokens.length === 0) {
                    document.getElementById('tokens-list').innerHTML = '<p class="admin-no-data-text">No API tokens found. Generate one to get started.</p>';
                    return;
                }

                const html = `
                    <table class="admin-table-full">
                        <thead>
                            <tr class="admin-table-head-row">
                                <th class="admin-table-head-cell">ID</th>
                                <th class="admin-table-head-cell">User</th>
                                <th class="admin-table-head-cell">Name</th>
                                <th class="admin-table-head-cell">Created</th>
                                <th class="admin-table-head-cell">Last Used</th>
                                <th class="admin-table-head-cell-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tokens.map(token => `
                                <tr class="admin-table-body-row">
                                    <td class="admin-table-body-cell">${token.id}</td>
                                    <td class="admin-table-body-cell">${token.user_email || 'N/A'}</td>
                                    <td class="admin-table-body-cell">${token.name}</td>
                                    <td class="admin-table-body-cell">${new Date(token.created_at).toLocaleDateString()}</td>
                                    <td class="admin-table-body-cell">${token.last_used_at ? new Date(token.last_used_at).toLocaleDateString() : 'Never'}</td>
                                    <td class="admin-table-body-cell-right">
                                        <button onclick="revokeToken(${token.id})" class="admin-token-button">Revoke</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                document.getElementById('tokens-list').innerHTML = html;
            } catch (error) {
                console.error('Error loading tokens:', error);
                document.getElementById('tokens-list').innerHTML = '<p class="admin-error-text">Error loading tokens: ' + error.message + '</p>';
            }
        }

        async function revokeToken(id) {
            const confirmed = await showConfirm('Are you sure you want to revoke this token? Applications using this token will no longer have access.', 'Revoke Token');
            if (!confirmed) return;

            try {
                await fetch(`${ADMIN_API_PATH}/server/security/tokens/${id}`, { method: 'DELETE' });
                Toast.success('Token revoked successfully');
                loadTokens();
            } catch (error) {
                Toast.error('Failed to revoke token');
            }
        }

        async function showGenerateTokenModal() {
            // Load users first
            const usersResponse = await fetch(`${ADMIN_API_PATH}/users');
            const users = await usersResponse.json();

            const userOptions = users.map(u =>
                `<option value="${u.id}">${u.email}</option>`
            ).join('');

            const modalId = 'generate-token-modal-' + Date.now();

            Modal.create({
                id: modalId,
                title: 'Generate API Token',
                body: `
                    <form id="generateTokenForm">
    <input type="hidden" name="csrf_token" value="{{.csrf_token}}">
                        <div class="form-group">
                            <label for="tokenUser">Select User</label>
                            <select id="tokenUser" class="form-input" required>
                                <option value="">-- Select User --</option>
                                ${userOptions}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="tokenName">Token Name</label>
                            <input type="text" id="tokenName" class="form-input" required placeholder="e.g., Production API Key">
                            <small class="text-comment">A descriptive name to identify this token</small>
                        </div>
                    </form>
                `,
                footer: `
                    <button class="btn btn-secondary" onclick="Modal.close('${modalId}')">Cancel</button>
                    <button class="btn btn-primary" onclick="generateTokenFromModal('${modalId}')">Generate Token</button>
                `,
                size: 'md'
            });
        }

        async function generateTokenFromModal(modalId) {
            const userId = document.getElementById('tokenUser').value;
            const tokenName = document.getElementById('tokenName').value;

            if (!userId || !tokenName) {
                Toast.error('Please fill in all fields');
                return;
            }

            try {
                const response = await fetch(`${ADMIN_API_PATH}/tokens', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: parseInt(userId), name: tokenName })
                });

                if (!response.ok) {
                    throw new Error('Failed to generate token');
                }

                const result = await response.json();
                Modal.close(modalId);

                // Show token in a new modal
                showTokenModal(result.token);
                loadTokens();
            } catch (error) {
                Toast.error('Failed to generate token: ' + error.message);
            }
        }

        function showTokenModal(token) {
            const modalId = 'token-display-modal-' + Date.now();

            Modal.create({
                id: modalId,
                title: '‚úÖ Token Generated Successfully',
                body: `
                    <div class="margin-bottom-1">
                        <p class="text-orange margin-bottom-1">
                            ‚ö†Ô∏è <strong>Important:</strong> Copy this token now. For security reasons, it will not be shown again!
                        </p>
                        <div class="admin-settings-note">
                            <code class="font-monospace word-break-all text-green font-size-09">${token}</code>
                        </div>
                    </div>
                `,
                footer: `
                    <button class="btn btn-primary" onclick="copyToken('${token}', '${modalId}')">üìã Copy to Clipboard</button>
                    <button class="btn btn-secondary" onclick="Modal.close('${modalId}')">Close</button>
                `,
                size: 'lg'
            });
        }

        async function copyToken(token, modalId) {
            try {
                await navigator.clipboard.writeText(token);
                Toast.success('Token copied to clipboard!');
            } catch (error) {
                // Fallback for older browsers
                const textarea = document.createElement('textarea');
                textarea.value = token;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                Toast.success('Token copied to clipboard!');
            }
        }

        // Logs Management
        async function loadLogs() {
            try {
                const response = await fetch(`${ADMIN_API_PATH}/logs?limit=50');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const logs = await response.json();

                if (!Array.isArray(logs) || logs.length === 0) {
                    document.getElementById('logs-list').innerHTML = '<p class="admin-loading-text">No audit logs found</p>';
                    return;
                }

                const html = `
                    <table class="admin-logs-table">
                        <thead>
                            <tr class="admin-table-head-row">
                                <th class="admin-table-head-cell">Time</th>
                                <th class="admin-table-head-cell">User</th>
                                <th class="admin-table-head-cell">Action</th>
                                <th class="admin-table-head-cell">Resource</th>
                                <th class="admin-table-head-cell">IP</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${logs.map(log => `
                                <tr class="admin-table-body-row">
                                    <td class="admin-logs-cell-mono">${new Date(log.created_at).toLocaleString()}</td>
                                    <td class="admin-logs-cell">${log.user_email || 'Anonymous'}</td>
                                    <td class="admin-logs-cell-cyan">${log.action}</td>
                                    <td class="admin-logs-cell-comment">${log.resource || '-'}</td>
                                    <td class="admin-logs-cell-mono">${log.ip_address || '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                document.getElementById('logs-list').innerHTML = html;
            } catch (error) {
                console.error('Error loading logs:', error);
                document.getElementById('logs-list').innerHTML = '<p class="admin-error-text">Error loading logs: ' + error.message + '</p>';
            }
        }

        async function clearAuditLogs() {
            const modalId = 'clear-logs-modal-' + Date.now();

            Modal.create({
                id: modalId,
                title: 'Clear Audit Logs',
                body: `
                    <form id="clearLogsForm">
    <input type="hidden" name="csrf_token" value="{{.csrf_token}}">
                        <div class="form-group">
                            <label for="logDays">Delete logs older than (days)</label>
                            <input type="number" id="logDays" class="form-input" value="30" min="1" required>
                            <small class="text-comment">Logs older than this many days will be permanently deleted</small>
                        </div>
                        <div class="admin-warning-box">
                            <p class="text-orange margin-0">
                                ‚ö†Ô∏è <strong>Warning:</strong> This action cannot be undone. Deleted logs cannot be recovered.
                            </p>
                        </div>
                    </form>
                `,
                footer: `
                    <button class="btn btn-secondary" onclick="Modal.close('${modalId}')">Cancel</button>
                    <button class="btn btn-danger" onclick="confirmClearLogs('${modalId}')">Delete Logs</button>
                `,
                size: 'md'
            });
        }

        async function confirmClearLogs(modalId) {
            const days = document.getElementById('logDays').value;

            if (!days || days < 1) {
                Toast.error('Please enter a valid number of days');
                return;
            }

            try {
                const response = await fetch(`${ADMIN_API_PATH}/server/logs?days=${days}`, { method: 'DELETE' });

                if (!response.ok) {
                    throw new Error('Failed to clear logs');
                }

                Modal.close(modalId);
                Toast.success(`Audit logs older than ${days} days have been deleted`);
                loadLogs();
            } catch (error) {
                Toast.error('Failed to clear logs: ' + error.message);
            }
        }

        // Helper function to format relative time (for next_run)
        function formatRelativeTime(dateStr) {
            if (!dateStr) return 'N/A';
            const now = new Date();
            const target = new Date(dateStr);
            const diff = target - now;

            if (diff < 0) return 'Overdue';

            const mins = Math.floor(diff / 60000);
            const hours = Math.floor(mins / 60);
            const days = Math.floor(hours / 24);

            if (days > 0) return `in ${days}d ${hours % 24}h`;
            if (hours > 0) return `in ${hours}h ${mins % 60}m`;
            return `in ${mins}m`;
        }

        // Helper function to format interval seconds to readable format
        function formatInterval(seconds) {
            if (!seconds || seconds === 0) return 'N/A';

            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            const weeks = Math.floor(days / 7);

            if (weeks > 0) return `${weeks} week${weeks > 1 ? 's' : ''}`;
            if (days > 0) return `${days} day${days > 1 ? 's' : ''}`;
            if (hours > 0) return `${hours} hour${hours > 1 ? 's' : ''}`;
            if (minutes > 0) return `${minutes} minute${minutes > 1 ? 's' : ''}`;
            return `${seconds} second${seconds > 1 ? 's' : ''}`;
        }

        // Scheduled Tasks Management
        // Complete scheduler management (TEMPLATE.md lines 1193-1214)
        async function loadScheduledTasks() {
            try {
                const response = await fetch(`${ADMIN_API_PATH}/tasks');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const data = await response.json();
                const tasks = data.tasks || [];

                if (!Array.isArray(tasks) || tasks.length === 0) {
                    document.getElementById('tasks-list').innerHTML = '<p class="admin-loading-text">No scheduled tasks found</p>';
                    return;
                }

                const html = `
                    <table class="admin-table-full">
                        <thead>
                            <tr class="admin-table-head-row">
                                <th class="admin-table-head-cell">Task Name</th>
                                <th class="admin-table-head-cell">Interval</th>
                                <th class="admin-table-head-cell">Enabled</th>
                                <th class="admin-table-head-cell">Status</th>
                                <th class="admin-table-head-cell">Last Run</th>
                                <th class="admin-table-head-cell">Next Run</th>
                                <th class="admin-table-head-cell">Stats</th>
                                <th class="admin-table-head-cell">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tasks.map(task => {
                                const lastRunInfo = task.last_run ?
                                    `${new Date(task.last_run.start_time).toLocaleString()}<br>` +
                                    `<small class="${task.last_run.status === 'success' ? 'status-success' : 'status-error'}">` +
                                    `${task.last_run.status === 'success' ? '‚úì' : '‚úó'} ${task.last_run.duration_ms}ms</small>` :
                                    'Never';
                                const nextRun = task.next_run ? new Date(task.next_run).toLocaleString() : 'N/A';
                                const countdown = task.next_run ? formatRelativeTime(task.next_run) : '';

                                return `
                                <tr class="admin-table-body-row">
                                    <td class="admin-task-name">${task.name}</td>
                                    <td class="admin-table-body-cell">${task.interval}</td>
                                    <td class="admin-table-body-cell">
                                        <span class="${task.enabled ? 'status-enabled' : 'status-disabled'}">
                                            ${task.enabled ? '‚úì Enabled' : '‚óã Disabled'}
                                        </span>
                                    </td>
                                    <td class="admin-table-body-cell">
                                        <span class="${task.running ? 'admin-task-status-running' : 'admin-task-status-idle'}">
                                            ${task.running ? 'Running' : 'Idle'}
                                        </span>
                                    </td>
                                    <td class="admin-table-body-cell admin-task-next-run">${lastRunInfo}</td>
                                    <td class="admin-table-body-cell">
                                        <div class="admin-task-next-run">${nextRun}</div>
                                        ${countdown ? `<div class="admin-task-countdown">${countdown}</div>` : ''}
                                    </td>
                                    <td class="admin-table-body-cell">
                                        <small>${task.success_count}‚úì / ${task.error_count}‚úó</small><br>
                                        <small>${task.run_count} total runs</small>
                                    </td>
                                    <td class="admin-table-body-cell">
                                        <button onclick="triggerTask('${task.name}')" class="btn-primary btn-task-action">
                                            ‚ñ∂ Run Now
                                        </button>
                                        ${task.enabled ?
                                            `<button onclick="disableTask('${task.name}')" class="btn-danger btn-task-action">‚è∏ Disable</button>` :
                                            `<button onclick="enableTask('${task.name}')" class="btn-success btn-task-action">‚ñ∂ Enable</button>`
                                        }
                                        <button onclick="viewTaskHistory('${task.name}')" class="btn-secondary btn-task-action">
                                            üìä History
                                        </button>
                                    </td>
                                </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
                document.getElementById('tasks-list').innerHTML = html;
            } catch (error) {
                console.error('Error loading scheduled tasks:', error);
                document.getElementById('tasks-list').innerHTML = '<p class="admin-error-text">Error loading scheduled tasks: ' + error.message + '</p>';
            }
        }

        // Enable a task
        async function enableTask(taskName) {
            try {
                const response = await fetch(`${ADMIN_API_PATH}/server/scheduler/${taskName}/enable`, { method: 'POST' });
                if (!response.ok) throw new Error(await response.text());
                await loadScheduledTasks();
                Toast.success(`Task "${taskName}" enabled successfully`);
            } catch (error) {
                Toast.error('Error enabling task: ' + error.message);
            }
        }

        // Disable a task
        async function disableTask(taskName) {
            try {
                const response = await fetch(`${ADMIN_API_PATH}/server/scheduler/${taskName}/disable`, { method: 'POST' });
                if (!response.ok) throw new Error(await response.text());
                await loadScheduledTasks();
                Toast.success(`Task "${taskName}" disabled successfully`);
            } catch (error) {
                Toast.error('Error disabling task: ' + error.message);
            }
        }

        // Trigger a task manually
        async function triggerTask(taskName) {
            try {
                const response = await fetch(`${ADMIN_API_PATH}/server/scheduler/${taskName}/run`, { method: 'POST' });
                if (!response.ok) throw new Error(await response.text());
                Toast.success(`Task "${taskName}" triggered successfully`);
                setTimeout(() => loadScheduledTasks(), 2000); // Reload after 2s
            } catch (error) {
                Toast.error('Error triggering task: ' + error.message);
            }
        }

        // View task history
        async function viewTaskHistory(taskName) {
            try {
                const response = await fetch(`${ADMIN_API_PATH}/server/scheduler/${taskName}?limit=20`);
                if (!response.ok) throw new Error(await response.text());
                const data = await response.json();
                const history = data.history || [];

                if (history.length === 0) {
                    Toast.info(`No execution history found for task "${taskName}"`);
                    return;
                }

                const historyHTML = `
                    <div class="task-history-scroll">
                        <table class="admin-table-full">
                            <thead>
                                <tr class="admin-table-head-row">
                                    <th>Start Time</th>
                                    <th>Duration</th>
                                    <th>Status</th>
                                    <th>Error</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${history.map(run => `
                                    <tr class="admin-table-body-row">
                                        <td>${new Date(run.start_time).toLocaleString()}</td>
                                        <td>${run.duration_ms}ms</td>
                                        <td class="${run.status === 'success' ? 'status-success' : 'status-error'}">
                                            ${run.status === 'success' ? '‚úì Success' : '‚úó Error'}
                                        </td>
                                        <td>${run.error || '-'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;

                Modal.create({
                    title: `Task History: ${taskName}`,
                    body: historyHTML,
                    size: 'lg'
                });
            } catch (error) {
                Toast.error('Error loading task history: ' + error.message);
            }
        }

        // Web Settings Handlers
        async function saveWebSettings() {
            const settings = {
                title: document.getElementById('web-title').value,
                tagline: document.getElementById('web-tagline').value,
                footer: document.getElementById('web-footer').value,
                theme: document.getElementById('web-theme').value,
                page_size: parseInt(document.getElementById('web-page-size').value),
                analytics: document.getElementById('web-analytics').checked
            };

            try {
                const response = await fetch(`${ADMIN_API_PATH}/settings/web', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });

                if (response.ok) {
                    Toast.success('Web settings saved successfully!');
                } else {
                    throw new Error('Failed to save settings');
                }
            } catch (error) {
                Toast.error('Error saving web settings: ' + error.message);
            }
        }

        // Security Settings Handlers
        async function saveSecuritySettings() {
            const settings = {
                rate_limit_enabled: document.getElementById('sec-ratelimit-enabled').checked,
                global_limit: parseInt(document.getElementById('sec-global-limit').value),
                api_limit: parseInt(document.getElementById('sec-api-limit').value),
                admin_limit: parseInt(document.getElementById('sec-admin-limit').value),
                hsts_enabled: document.getElementById('sec-hsts').checked,
                csp: document.getElementById('sec-csp').value,
                blocked_ips: document.getElementById('sec-blocked-ips').value.split('\n').filter(ip => ip.trim()),
                require_https: document.getElementById('sec-require-https').checked
            };

            try {
                const response = await fetch(`${ADMIN_API_PATH}/settings/security', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });

                if (response.ok) {
                    Toast.success('Security settings saved successfully!');
                } else {
                    throw new Error('Failed to save settings');
                }
            } catch (error) {
                Toast.error('Error saving security settings: ' + error.message);
            }
        }

        // Database Handlers
        async function testDatabaseConnection() {
            try {
                const response = await fetch(`${ADMIN_API_PATH}/database/test');
                const result = await response.json();

                if (result.success) {
                    Toast.success('Database connection successful!');
                } else {
                    Toast.error('Database connection failed: ' + result.error);
                }
            } catch (error) {
                Toast.error('Error testing database: ' + error.message);
            }
        }

        async function optimizeDatabase() {
            if (!await showConfirm('Optimize database? This may take a few moments.')) return;

            try {
                const response = await fetch(`${ADMIN_API_PATH}/database/optimize', { method: 'POST' });
                const result = await response.json();

                if (result.success) {
                    Toast.success('Database optimized successfully!');
                } else {
                    Toast.error('Optimization failed: ' + result.error);
                }
            } catch (error) {
                Toast.error('Error optimizing database: ' + error.message);
            }
        }

        async function clearCache() {
            if (!await showConfirm('Clear all cache? This will temporarily slow down requests.')) return;

            try {
                const response = await fetch(`${ADMIN_API_PATH}/cache/clear', { method: 'POST' });
                const result = await response.json();

                if (result.success) {
                    Toast.success('Cache cleared successfully!');
                } else {
                    Toast.error('Failed to clear cache: ' + result.error);
                }
            } catch (error) {
                Toast.error('Error clearing cache: ' + error.message);
            }
        }

        async function vacuumDatabase() {
            if (!await showConfirm('Vacuum database? This will compact the database file and may take several minutes.')) return;

            try {
                const response = await fetch(`${ADMIN_API_PATH}/database/vacuum', { method: 'POST' });
                const result = await response.json();

                if (result.success) {
                    Toast.success('Database vacuumed successfully!');
                } else {
                    Toast.error('Vacuum failed: ' + result.error);
                }
            } catch (error) {
                Toast.error('Error vacuuming database: ' + error.message);
            }
        }

        // SSL/TLS Handlers
        async function testSSLCertificate() {
            try {
                const response = await fetch(`${ADMIN_API_PATH}/ssl/verify');
                const result = await response.json();

                if (result.valid) {
                    Toast.success(`Certificate valid! Expires: ${new Date(result.expires).toLocaleDateString()}`);
                } else {
                    Toast.error('Certificate invalid or expired');
                }
            } catch (error) {
                Toast.error('Error verifying certificate: ' + error.message);
            }
        }

        async function obtainCertificate() {
            const domain = document.getElementById('ssl-domain').value;
            const email = document.getElementById('ssl-email').value;

            if (!domain || !email) {
                Toast.error('Please enter domain and email');
                return;
            }

            if (!await showConfirm(`Obtain SSL certificate for ${domain}? This requires port 80/443 to be accessible.`)) return;

            try {
                const response = await fetch(`${ADMIN_API_PATH}/ssl/obtain', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ domain, email, provider: document.getElementById('ssl-provider').value })
                });

                const result = await response.json();

                if (result.success) {
                    Toast.success('Certificate obtained successfully!');
                } else {
                    Toast.error('Failed to obtain certificate: ' + result.error);
                }
            } catch (error) {
                Toast.error('Error obtaining certificate: ' + error.message);
            }
        }

        async function renewCertificate() {
            if (!await showConfirm('Renew SSL certificate?')) return;

            try {
                const response = await fetch(`${ADMIN_API_PATH}/ssl/renew', { method: 'POST' });
                const result = await response.json();

                if (result.success) {
                    Toast.success('Certificate renewed successfully!');
                } else {
                    Toast.error('Renewal failed: ' + result.error);
                }
            } catch (error) {
                Toast.error('Error renewing certificate: ' + error.message);
            }
        }

        // Backup Handlers
        async function createBackup() {
            if (!await showConfirm('Create backup now? This may take a few moments.')) return;

            try {
                const response = await fetch(`${ADMIN_API_PATH}/server/backup`, { method: 'POST' });
                const result = await response.json();

                if (result.success) {
                    Toast.success(`Backup created: ${result.filename}`);
                    loadBackupList(); // Refresh backup list
                } else {
                    Toast.error('Backup failed: ' + result.error);
                }
            } catch (error) {
                Toast.error('Error creating backup: ' + error.message);
            }
        }

        async function restoreBackup() {
            const fileInput = document.getElementById('backup-upload');

            if (!fileInput.files.length) {
                Toast.error('Please select a backup file');
                return;
            }

            if (!await showConfirm('‚ö†Ô∏è WARNING: This will replace all current data and restart the server. Continue?', 'Restore Backup')) return;

            const formData = new FormData();
            formData.append('backup', fileInput.files[0]);

            try {
                const response = await fetch(`${ADMIN_API_PATH}/backup/restore', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    Toast.success('Backup restored! Server restarting...');
                    setTimeout(() => window.location.reload(), 3000);
                } else {
                    Toast.error('Restore failed: ' + result.error);
                }
            } catch (error) {
                Toast.error('Error restoring backup: ' + error.message);
            }
        }

        async function loadBackupList() {
            try {
                const response = await fetch(`${ADMIN_API_PATH}/server/backup`);
                const backups = await response.json();

                const html = backups.length ? `
                    <table class="admin-table-full">
                        <thead>
                            <tr class="admin-table-head-row">
                                <th class="admin-table-head-cell">Filename</th>
                                <th class="admin-table-head-cell">Size</th>
                                <th class="admin-table-head-cell">Date</th>
                                <th class="admin-table-head-cell-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${backups.map(backup => `
                                <tr class="admin-table-body-row">
                                    <td class="admin-table-body-cell admin-logs-cell-mono">${backup.filename}</td>
                                    <td class="admin-table-body-cell">${formatBytes(backup.size)}</td>
                                    <td class="admin-table-body-cell">${new Date(backup.created).toLocaleString()}</td>
                                    <td class="admin-table-body-cell-right">
                                        <a href="${ADMIN_API_PATH}/server/backup/${backup.filename}/download" class="btn btn-sm btn-primary">Download</a>
                                        <button onclick="deleteBackup('${backup.filename}')" class="btn btn-sm btn-danger">Delete</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                ` : '<p class="text-comment admin-loading-text">No backups available</p>';

                document.getElementById('backup-list').innerHTML = html;
            } catch (error) {
                console.error('Error loading backups:', error);
                document.getElementById('backup-list').innerHTML = '<p class="admin-error-text">Error loading backups</p>';
            }
        }

        async function deleteBackup(filename) {
            if (!await showConfirm(`Delete backup ${filename}?`, 'Delete Backup')) return;

            try {
                const response = await fetch(`${ADMIN_API_PATH}/server/backup/${filename}`, { method: 'DELETE' });
                const result = await response.json();

                if (result.success) {
                    Toast.success('Backup deleted');
                    loadBackupList();
                } else {
                    Toast.error('Failed to delete backup: ' + result.error);
                }
            } catch (error) {
                Toast.error('Error deleting backup: ' + error.message);
            }
        }

        // Utility function for formatting bytes
        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        // Initialize notification polling
        if (typeof Notifications !== 'undefined') {
            Notifications.startPolling(30000); // Poll every 30 seconds
        }
    </script>
    </div>

    {{template "footer" .}}
</body>
</html>
