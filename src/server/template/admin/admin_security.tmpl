{{define "admin/admin-security.tmpl"}}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.title}}</title>
    <link rel="stylesheet" href="/static/css/dracula.css">
</head>
<body>
    {{template "components/admin-header.tmpl" .}}

    <div class="admin-container">
        {{template "components/admin-sidebar.tmpl" .}}

        <main class="admin-content" role="main">
            <div class="content-header">
                <h1>ðŸ”’ Security Settings</h1>
                <p class="subtitle">Configure security headers, CORS, rate limiting, and access controls</p>
            </div>

            <!-- Security Headers Section -->
            <section class="admin-card" aria-labelledby="headers-heading">
                <div class="card-header">
                    <h2 id="headers-heading">Security Headers</h2>
                    <p class="card-description">HTTP security headers protect against common web vulnerabilities</p>
                </div>
                <div class="card-body">
                    <form id="headers-form" class="settings-form">
    <input type="hidden" name="csrf_token" value="{{.csrf_token}}">
                        <div class="alert alert-info" role="status">
                            <strong>Security headers</strong> are automatically applied to all responses. These settings control their values.
                        </div>

                        <div class="form-group">
                            <label for="csp">Content-Security-Policy (CSP)</label>
                            <textarea
                                id="csp"
                                name="security.csp"
                                class="form-control code-editor"
                                rows="4"
                                aria-describedby="csp_help"
                                spellcheck="false"
                            >default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:;</textarea>
                            <small id="csp_help" class="form-text">
                                Prevents XSS attacks by controlling which resources can be loaded
                            </small>
                        </div>

                        <div class="form-group">
                            <label for="hsts">Strict-Transport-Security (HSTS)</label>
                            <input
                                type="text"
                                id="hsts"
                                name="security.hsts"
                                class="form-control"
                                placeholder="max-age=31536000; includeSubDomains"
                                aria-describedby="hsts_help"
                            >
                            <small id="hsts_help" class="form-text">
                                Forces HTTPS connections. Only applies when HTTPS is enabled.
                            </small>
                        </div>

                        <div class="form-group">
                            <label for="x_frame_options">X-Frame-Options</label>
                            <select id="x_frame_options" name="security.x_frame_options" class="form-control" aria-describedby="x_frame_help">
                                <option value="DENY">DENY (Prevents all framing)</option>
                                <option value="SAMEORIGIN">SAMEORIGIN (Allows same-origin framing)</option>
                                <option value="ALLOW-FROM">ALLOW-FROM (Specify allowed origins)</option>
                            </select>
                            <small id="x_frame_help" class="form-text">
                                Prevents clickjacking attacks by controlling iframe embedding
                            </small>
                        </div>

                        <div class="form-group">
                            <label for="x_content_type">X-Content-Type-Options</label>
                            <select id="x_content_type" name="security.x_content_type" class="form-control" aria-describedby="x_content_type_help">
                                <option value="nosniff">nosniff (Recommended)</option>
                                <option value="">Disabled</option>
                            </select>
                            <small id="x_content_type_help" class="form-text">
                                Prevents MIME type sniffing vulnerabilities
                            </small>
                        </div>

                        <div class="form-group">
                            <label for="referrer_policy">Referrer-Policy</label>
                            <select id="referrer_policy" name="security.referrer_policy" class="form-control" aria-describedby="referrer_policy_help">
                                <option value="strict-origin-when-cross-origin">strict-origin-when-cross-origin (Recommended)</option>
                                <option value="no-referrer">no-referrer (Most private)</option>
                                <option value="no-referrer-when-downgrade">no-referrer-when-downgrade</option>
                                <option value="same-origin">same-origin</option>
                                <option value="origin">origin</option>
                            </select>
                            <small id="referrer_policy_help" class="form-text">
                                Controls how much referrer information is sent with requests
                            </small>
                        </div>

                        <div class="form-group">
                            <label for="permissions_policy">Permissions-Policy</label>
                            <textarea
                                id="permissions_policy"
                                name="security.permissions_policy"
                                class="form-control code-editor"
                                rows="3"
                                aria-describedby="permissions_policy_help"
                                spellcheck="false"
                            >geolocation=(), microphone=(), camera=()</textarea>
                            <small id="permissions_policy_help" class="form-text">
                                Controls which browser features can be used (formerly Feature-Policy)
                            </small>
                        </div>

                        <button type="submit" class="btn btn-primary" aria-label="Save security headers">
                            ðŸ’¾ Save Headers
                        </button>
                    </form>
                </div>
            </section>

            <!-- CORS Settings Section -->
            <section class="admin-card" aria-labelledby="cors-heading">
                <div class="card-header">
                    <h2 id="cors-heading">CORS (Cross-Origin Resource Sharing)</h2>
                    <p class="card-description">Control which external domains can access your API</p>
                </div>
                <div class="card-body">
                    <form id="cors-form" class="settings-form">
    <input type="hidden" name="csrf_token" value="{{.csrf_token}}">
                        <div class="form-group">
                            <label class="toggle-label">
                                <input
                                    type="checkbox"
                                    id="cors_enabled"
                                    name="security.cors_enabled"
                                    class="toggle-input"
                                    aria-describedby="cors_enabled_help"
                                >
                                <span class="toggle-slider"></span>
                                Enable CORS
                            </label>
                            <small id="cors_enabled_help" class="form-text">
                                Allow external websites to make API requests to this server
                            </small>
                        </div>

                        <div id="cors-fields" class="cors-fields">
                            <div class="form-group">
                                <label for="cors_origins">Allowed Origins</label>
                                <textarea
                                    id="cors_origins"
                                    name="security.cors_origins"
                                    class="form-control"
                                    rows="3"
                                    placeholder="https://example.com&#10;https://app.example.com&#10;*"
                                    aria-describedby="cors_origins_help"
                                ></textarea>
                                <small id="cors_origins_help" class="form-text">
                                    One origin per line. Use <code>*</code> to allow all origins (not recommended for production).
                                </small>
                            </div>

                            <div class="form-group">
                                <label for="cors_methods">Allowed Methods</label>
                                <input
                                    type="text"
                                    id="cors_methods"
                                    name="security.cors_methods"
                                    class="form-control"
                                    placeholder="GET, POST, PUT, DELETE, OPTIONS"
                                    aria-describedby="cors_methods_help"
                                >
                                <small id="cors_methods_help" class="form-text">
                                    Comma-separated list of HTTP methods
                                </small>
                            </div>

                            <div class="form-group">
                                <label for="cors_headers">Allowed Headers</label>
                                <input
                                    type="text"
                                    id="cors_headers"
                                    name="security.cors_headers"
                                    class="form-control"
                                    placeholder="Content-Type, Authorization, X-Requested-With"
                                    aria-describedby="cors_headers_help"
                                >
                                <small id="cors_headers_help" class="form-text">
                                    Comma-separated list of allowed request headers
                                </small>
                            </div>

                            <div class="form-group">
                                <label class="toggle-label">
                                    <input
                                        type="checkbox"
                                        id="cors_credentials"
                                        name="security.cors_credentials"
                                        class="toggle-input"
                                        aria-describedby="cors_credentials_help"
                                    >
                                    <span class="toggle-slider"></span>
                                    Allow Credentials
                                </label>
                                <small id="cors_credentials_help" class="form-text">
                                    Allow cookies and authentication headers in cross-origin requests
                                </small>
                            </div>

                            <div class="form-group">
                                <label for="cors_max_age">Preflight Cache Duration (seconds)</label>
                                <input
                                    type="number"
                                    id="cors_max_age"
                                    name="security.cors_max_age"
                                    class="form-control"
                                    placeholder="3600"
                                    min="0"
                                    max="86400"
                                    aria-describedby="cors_max_age_help"
                                >
                                <small id="cors_max_age_help" class="form-text">
                                    How long browsers can cache preflight responses (default: 3600)
                                </small>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary" aria-label="Save CORS settings">
                            ðŸ’¾ Save CORS Settings
                        </button>
                    </form>
                </div>
            </section>

            <!-- Rate Limiting Section -->
            <section class="admin-card" aria-labelledby="ratelimit-heading">
                <div class="card-header">
                    <h2 id="ratelimit-heading">Rate Limiting</h2>
                    <p class="card-description">Prevent abuse by limiting request rates</p>
                </div>
                <div class="card-body">
                    <form id="ratelimit-form" class="settings-form">
    <input type="hidden" name="csrf_token" value="{{.csrf_token}}">
                        <div class="form-group">
                            <label class="toggle-label">
                                <input
                                    type="checkbox"
                                    id="ratelimit_enabled"
                                    name="rate_limit.enabled"
                                    class="toggle-input"
                                    aria-describedby="ratelimit_enabled_help"
                                >
                                <span class="toggle-slider"></span>
                                Enable Rate Limiting
                            </label>
                            <small id="ratelimit_enabled_help" class="form-text">
                                Protect your server from abuse and DDoS attacks
                            </small>
                        </div>

                        <div id="ratelimit-fields" class="ratelimit-fields">
                            <div class="form-group">
                                <label for="ratelimit_global">Global Rate Limit (requests/second)</label>
                                <input
                                    type="number"
                                    id="ratelimit_global"
                                    name="rate_limit.global"
                                    class="form-control"
                                    placeholder="100"
                                    min="1"
                                    max="10000"
                                    aria-describedby="ratelimit_global_help"
                                >
                                <small id="ratelimit_global_help" class="form-text">
                                    Maximum requests per second for all users combined
                                </small>
                            </div>

                            <div class="form-group">
                                <label for="ratelimit_per_ip">Per-IP Rate Limit (requests/minute)</label>
                                <input
                                    type="number"
                                    id="ratelimit_per_ip"
                                    name="rate_limit.per_ip"
                                    class="form-control"
                                    placeholder="60"
                                    min="1"
                                    max="1000"
                                    aria-describedby="ratelimit_per_ip_help"
                                >
                                <small id="ratelimit_per_ip_help" class="form-text">
                                    Maximum requests per minute from a single IP address
                                </small>
                            </div>

                            <div class="form-group">
                                <label for="ratelimit_api">API Rate Limit (requests/minute)</label>
                                <input
                                    type="number"
                                    id="ratelimit_api"
                                    name="rate_limit.api"
                                    class="form-control"
                                    placeholder="120"
                                    min="1"
                                    max="10000"
                                    aria-describedby="ratelimit_api_help"
                                >
                                <small id="ratelimit_api_help" class="form-text">
                                    Rate limit for authenticated API requests
                                </small>
                            </div>

                            <div class="form-group">
                                <label for="ratelimit_admin">Admin Rate Limit (requests/minute)</label>
                                <input
                                    type="number"
                                    id="ratelimit_admin"
                                    name="rate_limit.admin"
                                    class="form-control"
                                    placeholder="300"
                                    min="1"
                                    max="10000"
                                    aria-describedby="ratelimit_admin_help"
                                >
                                <small id="ratelimit_admin_help" class="form-text">
                                    Higher limit for admin users (more permissive)
                                </small>
                            </div>

                            <div class="alert alert-warning" role="alert">
                                <strong>Note:</strong> Rate limiting changes take effect immediately. Be careful not to lock yourself out!
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary" aria-label="Save rate limiting settings">
                            ðŸ’¾ Save Rate Limits
                        </button>
                    </form>
                </div>
            </section>

            <!-- Authentication Settings Section -->
            <section class="admin-card" aria-labelledby="auth-heading">
                <div class="card-header">
                    <h2 id="auth-heading">Authentication & Sessions</h2>
                    <p class="card-description">Configure login security and session management</p>
                </div>
                <div class="card-body">
                    <form id="auth-form" class="settings-form">
    <input type="hidden" name="csrf_token" value="{{.csrf_token}}">
                        <div class="form-group">
                            <label for="session_timeout">Session Timeout (seconds)</label>
                            <input
                                type="number"
                                id="session_timeout"
                                name="security.session_timeout"
                                class="form-control"
                                placeholder="2592000"
                                min="300"
                                max="31536000"
                                aria-describedby="session_timeout_help"
                            >
                            <small id="session_timeout_help" class="form-text">
                                How long users stay logged in (default: 2592000 = 30 days)
                            </small>
                        </div>

                        <div class="form-group">
                            <label for="max_login_attempts">Max Login Attempts</label>
                            <input
                                type="number"
                                id="max_login_attempts"
                                name="security.max_login_attempts"
                                class="form-control"
                                placeholder="5"
                                min="1"
                                max="20"
                                aria-describedby="max_login_attempts_help"
                            >
                            <small id="max_login_attempts_help" class="form-text">
                                Maximum failed login attempts before account lockout
                            </small>
                        </div>

                        <div class="form-group">
                            <label for="lockout_duration">Lockout Duration (minutes)</label>
                            <input
                                type="number"
                                id="lockout_duration"
                                name="security.lockout_duration"
                                class="form-control"
                                placeholder="30"
                                min="1"
                                max="1440"
                                aria-describedby="lockout_duration_help"
                            >
                            <small id="lockout_duration_help" class="form-text">
                                How long to lock account after max failed attempts
                            </small>
                        </div>

                        <div class="form-group">
                            <label for="password_min_length">Minimum Password Length</label>
                            <input
                                type="number"
                                id="password_min_length"
                                name="security.password_min_length"
                                class="form-control"
                                placeholder="8"
                                min="6"
                                max="64"
                                aria-describedby="password_min_length_help"
                            >
                            <small id="password_min_length_help" class="form-text">
                                Minimum characters required for passwords (recommended: 8+)
                            </small>
                        </div>

                        <button type="submit" class="btn btn-primary" aria-label="Save authentication settings">
                            ðŸ’¾ Save Auth Settings
                        </button>
                    </form>
                </div>
            </section>
        </main>
    </div>

    <script>
    // Path variables - SPEC compliant (AI.md PART 13)
    const API_PATH = '{{.api_path}}';
    const ADMIN_API_PATH = '{{.admin_api_path}}';

    // Load settings on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadSettings();
        toggleCORSFields();
        toggleRateLimitFields();
    });

    // Toggle CORS fields
    document.getElementById('cors_enabled').addEventListener('change', toggleCORSFields);

    function toggleCORSFields() {
        const enabled = document.getElementById('cors_enabled').checked;
        const fields = document.getElementById('cors-fields');
        fields.style.opacity = enabled ? '1' : '0.5';
        fields.style.pointerEvents = enabled ? 'auto' : 'none';
    }

    // Toggle rate limit fields
    document.getElementById('ratelimit_enabled').addEventListener('change', toggleRateLimitFields);

    function toggleRateLimitFields() {
        const enabled = document.getElementById('ratelimit_enabled').checked;
        const fields = document.getElementById('ratelimit-fields');
        fields.style.opacity = enabled ? '1' : '0.5';
        fields.style.pointerEvents = enabled ? 'auto' : 'none';
    }

    async function loadSettings() {
        try {
            const response = await fetch(ADMIN_API_PATH + '/server/settings/all');
            const data = await response.json();

            if (data.settings) {
                for (const [key, setting] of Object.entries(data.settings)) {
                    const input = document.querySelector(`[name="${key}"]`);
                    if (input) {
                        if (input.type === 'checkbox') {
                            input.checked = setting.value === 'true';
                        } else {
                            input.value = setting.value || '';
                        }
                    }
                }
                toggleCORSFields();
                toggleRateLimitFields();
            }
        } catch (error) {
            console.error('Failed to load settings:', error);
            showNotification('Failed to load settings', 'error');
        }
    }

    // Form submissions
    document.getElementById('headers-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        await saveFormSettings(this, 'Security headers saved successfully');
    });

    document.getElementById('cors-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        await saveFormSettings(this, 'CORS settings saved successfully');
    });

    document.getElementById('ratelimit-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        await saveFormSettings(this, 'Rate limiting settings saved successfully');
    });

    document.getElementById('auth-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        await saveFormSettings(this, 'Authentication settings saved successfully');
    });

    async function saveFormSettings(form, successMessage) {
        const formData = new FormData(form);
        const settings = {};

        for (const [key, value] of formData.entries()) {
            settings[key] = value;
        }

        // Handle checkboxes
        const checkboxes = form.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(cb => {
            settings[cb.name] = cb.checked ? 'true' : 'false';
        });

        try {
            const response = await fetch(ADMIN_API_PATH + '/server/settings/bulk', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ settings })
            });

            const data = await response.json();

            if (response.ok) {
                showNotification(successMessage, 'success');
            } else {
                throw new Error(data.error?.message || 'Failed to save settings');
            }
        } catch (error) {
            console.error('Save error:', error);
            showNotification(error.message, 'error');
        }
    }

    function showNotification(message, type) {
        const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
        const notification = document.createElement('div');
        notification.className = `alert ${alertClass}`;
        notification.style.position = 'fixed';
        notification.style.top = '20px';
        notification.style.right = '20px';
        notification.style.zIndex = '9999';
        notification.style.minWidth = '300px';
        notification.textContent = message;

        document.body.appendChild(notification);

        setTimeout(() => {
            notification.remove();
        }, 4000);
    }
    </script>

</body>
</html>
{{end}}
