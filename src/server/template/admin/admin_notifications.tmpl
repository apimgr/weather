{{template "head" .}}
{{template "navbar" .}}
<main class="container p-4">
<div class="admin-header"><h1>üîî Notification Settings</h1></div>

<!-- Admin Personal Notification Preferences -->
<section class="card mb-4">
    <h2 class="section-title">üë§ Your Notification Preferences</h2>
    <p class="text-comment mb-3">
        Customize how you receive notifications as an administrator. These settings apply only to your account.
    </p>

    <form id="adminNotificationPreferencesForm">
    <input type="hidden" name="csrf_token" value="{{.csrf_token}}">
        <!-- Display Mode Toggles -->
        <div class="mb-4">
            <h3 class="subsection-title">Display Modes</h3>

            <div class="mb-2">
                <label class="checkbox-row">
                    <input type="checkbox" id="adminEnableToast" checked>
                    <span>Enable Toast Notifications</span>
                </label>
                <small class="text-comment checkbox-hint">Show temporary popups in the top-right corner (auto-dismiss)</small>
            </div>

            <div class="mb-2">
                <label class="checkbox-row">
                    <input type="checkbox" id="adminEnableBanner" checked>
                    <span>Enable Banner Notifications</span>
                </label>
                <small class="text-comment checkbox-hint">Show persistent banners at the top of the page (manual dismiss)</small>
            </div>

            <div class="mb-2">
                <label class="checkbox-row">
                    <input type="checkbox" id="adminEnableCenter" checked>
                    <span>Enable Notification Center</span>
                </label>
                <small class="text-comment checkbox-hint">Store notifications in the notification center (bell icon)</small>
            </div>

            <div class="mb-2">
                <label class="checkbox-row">
                    <input type="checkbox" id="adminEnableSound">
                    <span>Enable Notification Sound</span>
                </label>
                <small class="text-comment checkbox-hint">Play a sound when receiving notifications</small>
            </div>
        </div>

        <!-- Toast Duration Settings -->
        <div class="mb-3">
            <h3 class="subsection-title">Toast Auto-Dismiss Duration</h3>

            <div class="settings-grid">
                <div>
                    <label for="adminToastDurationSuccess" class="settings-label">Success Notifications</label>
                    <div class="slider-row">
                        <input type="range" id="adminToastDurationSuccess" min="1" max="60" value="5"
                               class="flex-grow" oninput="updateAdminDurationLabel('success', this.value)">
                        <span id="adminDurationLabelSuccess" class="slider-label slider-label-success">5s</span>
                    </div>
                    <small class="text-comment d-block mt-1">How long success toasts remain visible (1-60 seconds)</small>
                </div>

                <div>
                    <label for="adminToastDurationInfo" class="settings-label">Info Notifications</label>
                    <div class="slider-row">
                        <input type="range" id="adminToastDurationInfo" min="1" max="60" value="5"
                               class="flex-grow" oninput="updateAdminDurationLabel('info', this.value)">
                        <span id="adminDurationLabelInfo" class="slider-label slider-label-info">5s</span>
                    </div>
                    <small class="text-comment d-block mt-1">How long info toasts remain visible (1-60 seconds)</small>
                </div>

                <div>
                    <label for="adminToastDurationWarning" class="settings-label">Warning Notifications</label>
                    <div class="slider-row">
                        <input type="range" id="adminToastDurationWarning" min="1" max="60" value="10"
                               class="flex-grow" oninput="updateAdminDurationLabel('warning', this.value)">
                        <span id="adminDurationLabelWarning" class="slider-label slider-label-warning">10s</span>
                    </div>
                    <small class="text-comment d-block mt-1">How long warning toasts remain visible (1-60 seconds)</small>
                </div>
            </div>

            <div class="note-box">
                <p>
                    <strong>Note:</strong> Error and security notifications always require manual dismissal for safety.
                </p>
            </div>
        </div>

        <button type="submit" class="btn btn-primary mr-md">üíæ Save Preferences</button>
        <button type="button" class="btn btn-secondary" onclick="loadAdminNotificationPreferences()">‚Üª Reset</button>
    </form>
</section>

<!-- System-wide Notification Settings -->
<form id="notificationSettingsForm">
    <input type="hidden" name="csrf_token" value="{{.csrf_token}}">
<section class="card mb-4"><h2>üìß Email Events</h2>
<p class="text-comment mb-2">Configure which system events trigger email notifications to administrators.</p>
<label><input type="checkbox" name="email_startup"> Server Startup</label>
<label><input type="checkbox" name="email_shutdown"> Server Shutdown</label>
<label><input type="checkbox" name="email_backup_complete"> Backup Complete</label>
<label><input type="checkbox" name="email_backup_failed"> Backup Failed</label>
<label><input type="checkbox" name="email_cert_renewal"> SSL Certificate Renewal</label>
</section>
<section class="card mb-4"><h2>ü™ù Webhook</h2>
<p class="text-comment mb-2">Send system events to external webhooks for integration with other services.</p>
<label><input type="checkbox" name="webhook_enabled"> Enable Webhook</label>
<label>URL: <input type="url" name="webhook_url"></label>
<label>Events: <input type="text" name="webhook_events" placeholder="startup,shutdown,backup"></label>
</section>
<section class="card mb-4"><h2>‚öôÔ∏è System Settings</h2>
<p class="text-comment mb-2">Global settings for the notification system (applies to all users).</p>
<label>Max Stored Notifications: <input type="number" name="webui_max_stored" value="100" min="10" max="1000"></label>
<small class="text-comment">Maximum number of notifications to keep per user (default: 100)</small>
<label>Retention Period (days): <input type="number" name="webui_retention_days" value="30" min="1" max="365"></label>
<small class="text-comment">How long to keep notifications before automatic cleanup (default: 30 days)</small>
</section>
<button type="submit" class="btn btn-primary">üíæ Save System Settings</button>
</form>
</main>

<script>
// Path variables - SPEC compliant (AI.md PART 13)
const API_PATH = '{{.api_path}}';
const ADMIN_API_PATH = '{{.admin_api_path}}';

// Update admin duration label as slider moves
function updateAdminDurationLabel(type, value) {
    document.getElementById(`adminDurationLabel${type.charAt(0).toUpperCase() + type.slice(1)}`).textContent = value + 's';
}

// Load admin notification preferences on page load
async function loadAdminNotificationPreferences() {
    try {
        const response = await fetch(ADMIN_API_PATH + '/notifications/preferences');

        if (!response.ok) {
            throw new Error('Failed to load preferences');
        }

        const prefs = await response.json();

        // Set checkbox values
        document.getElementById('adminEnableToast').checked = prefs.enable_toast !== false;
        document.getElementById('adminEnableBanner').checked = prefs.enable_banner !== false;
        document.getElementById('adminEnableCenter').checked = prefs.enable_center !== false;
        document.getElementById('adminEnableSound').checked = prefs.enable_sound === true;

        // Set toast duration values
        const successDuration = prefs.toast_duration_success || 5;
        const infoDuration = prefs.toast_duration_info || 5;
        const warningDuration = prefs.toast_duration_warning || 10;

        document.getElementById('adminToastDurationSuccess').value = successDuration;
        document.getElementById('adminToastDurationInfo').value = infoDuration;
        document.getElementById('adminToastDurationWarning').value = warningDuration;

        updateAdminDurationLabel('success', successDuration);
        updateAdminDurationLabel('info', infoDuration);
        updateAdminDurationLabel('warning', warningDuration);
    } catch (error) {
        console.error('Failed to load admin notification preferences:', error);
        // Use defaults if loading fails
    }
}

// Save admin notification preferences
document.getElementById('adminNotificationPreferencesForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const preferences = {
        enable_toast: document.getElementById('adminEnableToast').checked,
        enable_banner: document.getElementById('adminEnableBanner').checked,
        enable_center: document.getElementById('adminEnableCenter').checked,
        enable_sound: document.getElementById('adminEnableSound').checked,
        toast_duration_success: parseInt(document.getElementById('adminToastDurationSuccess').value),
        toast_duration_info: parseInt(document.getElementById('adminToastDurationInfo').value),
        toast_duration_warning: parseInt(document.getElementById('adminToastDurationWarning').value)
    };

    try {
        const response = await fetch(ADMIN_API_PATH + '/notifications/preferences', {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(preferences)
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Failed to update preferences');
        }

        // Show success notification using the notification manager
        if (typeof notificationManager !== 'undefined') {
            notificationManager.preferences = preferences;
            notificationManager.showToast({
                type: 'success',
                title: 'Preferences Saved',
                message: 'Your notification preferences have been updated successfully.',
                display: 'toast'
            });
        } else {
            Toast.show('Notification preferences updated successfully!', 'success');
        }
    } catch (error) {
        if (typeof notificationManager !== 'undefined') {
            notificationManager.showToast({
                type: 'error',
                title: 'Save Failed',
                message: 'Failed to update preferences: ' + error.message,
                display: 'toast'
            });
        } else {
            Toast.show('Failed to update preferences: ' + error.message, 'error');
        }
    }
});

// Load admin preferences when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadAdminNotificationPreferences();
});
</script>

{{template "footer" .}}
