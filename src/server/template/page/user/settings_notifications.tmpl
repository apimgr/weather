{{template "head" .}}

{{template "navbar" .}}

<div class="profile-container">
    <div class="page-header">
        <h1 class="profile-page-header-title">Notification Settings</h1>
        <p class="text-comment">Configure how you receive notifications</p>
    </div>

    <!-- Settings Navigation -->
    <div class="settings-nav">
        <a href="/users/settings" class="settings-nav-item">Account</a>
        <a href="/users/settings/privacy" class="settings-nav-item">Privacy</a>
        <a href="/users/settings/notifications" class="settings-nav-item active">Notifications</a>
        <a href="/users/settings/appearance" class="settings-nav-item">Appearance</a>
        <a href="/users/security" class="settings-nav-item">Security</a>
        <a href="/users/tokens" class="settings-nav-item">API Tokens</a>
    </div>

    <!-- Notification Settings Form -->
    <div class="card profile-card">
        <div class="card-header">
            <h2 class="profile-card-header-title">Email Notifications</h2>
        </div>
        <div class="card-body">
            <form id="notificationSettingsForm">
                <input type="hidden" name="csrf_token" value="{{.csrf_token}}">

                <div class="toggle-group">
                    <label class="toggle-item disabled">
                        <input type="checkbox" checked disabled>
                        <div class="toggle-content">
                            <strong>Security alerts (required)</strong>
                            <span class="badge badge-locked">Locked</span>
                            <p class="text-comment">Password changes, new logins, 2FA changes. This setting cannot be disabled for your security.</p>
                        </div>
                    </label>

                    <label class="toggle-item">
                        <input type="checkbox" id="emailMentions" checked>
                        <div class="toggle-content">
                            <strong>Mentions and replies</strong>
                            <p class="text-comment">When someone mentions you or replies to you.</p>
                        </div>
                    </label>

                    <label class="toggle-item">
                        <input type="checkbox" id="emailUpdates">
                        <div class="toggle-content">
                            <strong>Product updates</strong>
                            <p class="text-comment">News about new features and improvements.</p>
                        </div>
                    </label>
                </div>

                <div class="form-group margin-y-md">
                    <label for="emailDigest" class="form-label">Activity Digest</label>
                    <select id="emailDigest" class="form-input">
                        <option value="never">Never</option>
                        <option value="daily">Daily</option>
                        <option value="weekly" selected>Weekly</option>
                    </select>
                    <small class="text-comment">Receive a summary of activity on your account</small>
                </div>

                <hr class="settings-divider">

                <h3 class="section-title">Push Notifications</h3>

                <div class="toggle-group">
                    <label class="toggle-item">
                        <input type="checkbox" id="pushEnabled">
                        <div class="toggle-content">
                            <strong>Enable push notifications</strong>
                            <p class="text-comment">Receive notifications in your browser even when you're not on this site.</p>
                            <p class="text-comment text-sm">(Requires browser permission)</p>
                        </div>
                    </label>

                    <label class="toggle-item" id="pushMentionsWrapper">
                        <input type="checkbox" id="pushMentions" checked disabled>
                        <div class="toggle-content">
                            <strong>Push for mentions</strong>
                            <p class="text-comment">Receive push notifications when someone mentions you.</p>
                        </div>
                    </label>
                </div>

                <div class="profile-form-actions">
                    <button type="submit" class="btn btn-primary">Save Preferences</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.settings-nav {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
    padding: 1rem;
    background: var(--bg-dark);
    border-radius: 8px;
    border: 1px solid var(--border);
}
.settings-nav-item {
    padding: 0.5rem 1rem;
    border-radius: 4px;
    color: var(--text);
    text-decoration: none;
    transition: background 0.2s;
}
.settings-nav-item:hover {
    background: var(--bg);
}
.settings-nav-item.active {
    background: var(--accent);
    color: var(--bg);
}
.settings-divider {
    border: none;
    border-top: 1px solid var(--border);
    margin: 1.5rem 0;
}
.section-title {
    font-size: 1rem;
    margin-bottom: 1rem;
    color: var(--text);
}
.toggle-group {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}
.toggle-item {
    display: flex;
    align-items: flex-start;
    gap: 1rem;
    cursor: pointer;
}
.toggle-item.disabled {
    opacity: 0.7;
    cursor: not-allowed;
}
.toggle-item input[type="checkbox"] {
    width: 20px;
    height: 20px;
    accent-color: var(--accent);
    margin-top: 2px;
}
.toggle-content {
    flex: 1;
}
.toggle-content strong {
    display: inline-block;
    margin-bottom: 0.25rem;
}
.toggle-content p {
    margin: 0;
    font-size: 0.9rem;
}
.badge-locked {
    background: var(--bg-dark);
    color: var(--text-comment);
    font-size: 0.7rem;
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    margin-left: 0.5rem;
    vertical-align: middle;
}
.text-sm {
    font-size: 0.85rem;
}
.margin-y-md {
    margin-top: 1rem;
    margin-bottom: 1rem;
}
</style>

<script>
// Path variables - SPEC compliant (AI.md PART 13)
const API_PATH = '{{.api_path}}';

// Toggle push mentions based on push enabled
document.getElementById('pushEnabled').addEventListener('change', function() {
    const pushMentions = document.getElementById('pushMentions');
    pushMentions.disabled = !this.checked;
    if (!this.checked) {
        pushMentions.checked = false;
    }
});

// Request browser notification permission when enabling push
document.getElementById('pushEnabled').addEventListener('change', async function() {
    if (this.checked && 'Notification' in window) {
        if (Notification.permission === 'default') {
            const permission = await Notification.requestPermission();
            if (permission !== 'granted') {
                this.checked = false;
                Toast.error('Browser notification permission denied');
            }
        } else if (Notification.permission === 'denied') {
            this.checked = false;
            Toast.error('Browser notifications are blocked. Please enable them in your browser settings.');
        }
    }
});

// Save settings
document.getElementById('notificationSettingsForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const data = {
        notifications: {
            email_security: true, // Always true
            email_mentions: document.getElementById('emailMentions').checked,
            email_updates: document.getElementById('emailUpdates').checked,
            email_digest: document.getElementById('emailDigest').value,
            push_enabled: document.getElementById('pushEnabled').checked,
            push_mentions: document.getElementById('pushMentions').checked
        }
    };

    try {
        const response = await fetch(API_PATH + '/users/settings', {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Failed to save settings');
        }

        Toast.success('Notification preferences saved!');
    } catch (error) {
        Toast.error('Failed to save settings: ' + error.message);
    }
});
</script>

{{template "footer" .}}
</body>
</html>
