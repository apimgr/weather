{{template "head" .}}

{{template "navbar" .}}

<div class="profile-container">
    <div class="page-header">
        <h1 class="profile-page-header-title">API Tokens</h1>
        <p class="text-comment">Manage your personal API tokens</p>
    </div>

    <!-- Settings Navigation -->
    <div class="settings-nav">
        <a href="/users/settings" class="settings-nav-item">Account</a>
        <a href="/users/settings/privacy" class="settings-nav-item">Privacy</a>
        <a href="/users/settings/notifications" class="settings-nav-item">Notifications</a>
        <a href="/users/settings/appearance" class="settings-nav-item">Appearance</a>
        <a href="/users/security" class="settings-nav-item">Security</a>
        <a href="/users/tokens" class="settings-nav-item active">API Tokens</a>
    </div>

    <!-- API Tokens Card -->
    <div class="card profile-card">
        <div class="card-header d-flex justify-between align-center">
            <h2 class="profile-card-header-title">API Tokens</h2>
            <button type="button" class="btn btn-primary" onclick="showNewTokenModal()">+ New Token</button>
        </div>
        <div class="card-body">
            <div id="tokenList">
                {{if .tokens}}
                {{range .tokens}}
                <div class="token-item" data-token-id="{{.ID}}">
                    <div class="token-info">
                        <div class="token-name">{{if .Name}}{{.Name}}{{else}}Unnamed Token{{end}}</div>
                        <div class="token-meta">
                            <span class="token-prefix">{{.TokenPrefix}}</span>
                            {{if .Scopes}}
                            <span class="token-scopes">Scopes: {{.Scopes}}</span>
                            {{end}}
                        </div>
                        <div class="token-dates">
                            <span>Created: {{.CreatedAt.Format "Jan 2, 2006"}}</span>
                            {{if .ExpiresAt}}
                            <span>Expires: {{.ExpiresAt.Format "Jan 2, 2006"}}</span>
                            {{else}}
                            <span>Expires: Never</span>
                            {{end}}
                            {{if .LastUsedAt}}
                            <span>Last used: {{.LastUsedAt.Format "Jan 2, 2006 15:04"}}</span>
                            {{else}}
                            <span>Last used: Never</span>
                            {{end}}
                        </div>
                    </div>
                    <button type="button" class="btn btn-danger btn-sm" onclick="revokeToken({{.ID}})">Revoke</button>
                </div>
                {{end}}
                {{else}}
                <div class="empty-state">
                    <p>No API tokens yet.</p>
                    <p class="text-comment">Create a token to access the API programmatically.</p>
                </div>
                {{end}}
            </div>
        </div>
    </div>

    <!-- Token Info Card -->
    <div class="card profile-card">
        <div class="card-header">
            <h2 class="profile-card-header-title">About API Tokens</h2>
        </div>
        <div class="card-body">
            <div class="info-content">
                <p>API tokens allow you to access the API without using your password. Use them for:</p>
                <ul>
                    <li>CLI applications</li>
                    <li>Scripts and automation</li>
                    <li>Third-party integrations</li>
                </ul>
                <p class="text-comment">
                    <strong>Security note:</strong> Tokens are shown only once when created. Store them securely.
                    If a token is compromised, revoke it immediately.
                </p>
            </div>
        </div>
    </div>
</div>

<!-- New Token Modal -->
<div id="newTokenModal" class="modal d-none">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Create New Token</h3>
            <button class="modal-close" onclick="closeNewTokenModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="newTokenForm">
                <input type="hidden" name="csrf_token" value="{{.csrf_token}}">

                <div class="form-group">
                    <label for="tokenName" class="form-label">Token Name</label>
                    <input type="text" id="tokenName" class="form-input" required placeholder="My CLI Token">
                    <small class="text-comment">A descriptive name to identify this token</small>
                </div>

                <div class="form-group">
                    <label for="tokenScopes" class="form-label">Scopes (optional)</label>
                    <input type="text" id="tokenScopes" class="form-input" placeholder="read, write">
                    <small class="text-comment">Comma-separated list of scopes. Leave empty for full access.</small>
                </div>

                <div class="form-group">
                    <label for="tokenExpires" class="form-label">Expiration</label>
                    <select id="tokenExpires" class="form-input">
                        <option value="0">Never</option>
                        <option value="7">7 days</option>
                        <option value="30">30 days</option>
                        <option value="90">90 days</option>
                        <option value="365">1 year</option>
                    </select>
                </div>

                <div class="profile-form-actions">
                    <button type="submit" class="btn btn-primary">Create Token</button>
                    <button type="button" class="btn btn-secondary" onclick="closeNewTokenModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Token Created Modal -->
<div id="tokenCreatedModal" class="modal d-none">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Token Created</h3>
        </div>
        <div class="modal-body">
            <div class="alert alert-warning">
                <strong>Important:</strong> Copy your token now. You won't be able to see it again!
            </div>
            <div class="form-group">
                <label class="form-label">Your new API token:</label>
                <div class="token-display">
                    <input type="text" id="createdToken" class="form-input" readonly>
                    <button type="button" class="btn btn-secondary" onclick="copyToken()">Copy</button>
                </div>
            </div>
            <div class="profile-form-actions">
                <button type="button" class="btn btn-primary" onclick="closeTokenCreatedModal()">Done</button>
            </div>
        </div>
    </div>
</div>

<style>
.settings-nav {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
    padding: 1rem;
    background: var(--bg-dark);
    border-radius: 8px;
    border: 1px solid var(--border);
}
.settings-nav-item {
    padding: 0.5rem 1rem;
    border-radius: 4px;
    color: var(--text);
    text-decoration: none;
    transition: background 0.2s;
}
.settings-nav-item:hover {
    background: var(--bg);
}
.settings-nav-item.active {
    background: var(--accent);
    color: var(--bg);
}
.d-flex {
    display: flex;
}
.justify-between {
    justify-content: space-between;
}
.align-center {
    align-items: center;
}
.token-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    border: 1px solid var(--border);
    border-radius: 8px;
    margin-bottom: 1rem;
}
.token-info {
    flex: 1;
}
.token-name {
    font-weight: bold;
    margin-bottom: 0.25rem;
}
.token-meta {
    font-family: monospace;
    font-size: 0.9rem;
    color: var(--text-comment);
    margin-bottom: 0.25rem;
}
.token-prefix {
    background: var(--bg-dark);
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    margin-right: 0.5rem;
}
.token-scopes {
    margin-left: 0.5rem;
}
.token-dates {
    font-size: 0.85rem;
    color: var(--text-comment);
}
.token-dates span {
    margin-right: 1rem;
}
.btn-sm {
    padding: 0.25rem 0.75rem;
    font-size: 0.9rem;
}
.empty-state {
    text-align: center;
    padding: 2rem;
    color: var(--text-comment);
}
.info-content ul {
    margin: 1rem 0;
    padding-left: 1.5rem;
}
.info-content li {
    margin-bottom: 0.5rem;
}
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}
.modal-content {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    max-width: 500px;
    width: 90%;
}
.modal-header {
    padding: 1rem;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--text-comment);
}
.modal-body {
    padding: 1.5rem;
}
.token-display {
    display: flex;
    gap: 0.5rem;
}
.token-display input {
    flex: 1;
    font-family: monospace;
}
.d-none {
    display: none !important;
}
</style>

<script>
// Path variables - SPEC compliant (AI.md PART 13)
const API_PATH = '{{.api_path}}';

function showNewTokenModal() {
    document.getElementById('newTokenModal').style.display = 'flex';
}

function closeNewTokenModal() {
    document.getElementById('newTokenModal').style.display = 'none';
    document.getElementById('newTokenForm').reset();
}

function closeTokenCreatedModal() {
    document.getElementById('tokenCreatedModal').style.display = 'none';
    window.location.reload();
}

function copyToken() {
    const tokenInput = document.getElementById('createdToken');
    tokenInput.select();
    document.execCommand('copy');
    Toast.success('Token copied to clipboard');
}

// Create new token
document.getElementById('newTokenForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const data = {
        name: document.getElementById('tokenName').value,
        scopes: document.getElementById('tokenScopes').value,
        expires_in: parseInt(document.getElementById('tokenExpires').value)
    };

    try {
        const response = await fetch(API_PATH + '/users/tokens', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Failed to create token');
        }

        const result = await response.json();

        // Show the created token
        closeNewTokenModal();
        document.getElementById('createdToken').value = result.token;
        document.getElementById('tokenCreatedModal').style.display = 'flex';
    } catch (error) {
        Toast.error('Failed to create token: ' + error.message);
    }
});

// Revoke token
async function revokeToken(tokenId) {
    if (!await showConfirm('Are you sure you want to revoke this token? This action cannot be undone.', 'Revoke Token')) {
        return;
    }

    try {
        const response = await fetch(API_PATH + '/users/tokens/' + tokenId, {
            method: 'DELETE'
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Failed to revoke token');
        }

        Toast.success('Token revoked');
        document.querySelector(`[data-token-id="${tokenId}"]`).remove();
    } catch (error) {
        Toast.error('Failed to revoke token: ' + error.message);
    }
}
</script>

{{template "footer" .}}
</body>
</html>
