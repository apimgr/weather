{{template "head" .}}

{{template "navbar" .}}

    <div class="container">
        <div class="add-location-header">
            <h1 class="text-purple">Add New Location</h1>
            <a href="/user/dashboard" class="add-location-back-link">‚Üê Back to Dashboard</a>
        </div>

        <div class="card">
            <div class="card-body">
                <div id="message"></div>

                <!-- GPS Button -->
                <button class="btn btn-secondary gps-button"
                        onclick="useCurrentLocation()"
                        aria-label="Use my current location"
                        title="Use your device's GPS to automatically detect your current location">
                    üìç Use My Current Location
                </button>

                <!-- Tabs -->
                <div class="tabs" role="tablist" aria-label="Location lookup methods">
                    <button class="tab active"
                            onclick="switchTab('search')"
                            role="tab"
                            aria-label="Search by city name"
                            aria-selected="true"
                            title="Search for a location by city name">üîç Search</button>
                    <button class="tab"
                            onclick="switchTab('zip')"
                            role="tab"
                            aria-label="Search by ZIP or postal code"
                            aria-selected="false"
                            title="Look up a location using ZIP or postal code">üìÆ ZIP Code</button>
                    <button class="tab"
                            onclick="switchTab('coords')"
                            role="tab"
                            aria-label="Search by coordinates"
                            aria-selected="false"
                            title="Enter exact latitude and longitude coordinates">üó∫Ô∏è Coordinates</button>
                </div>

                <!-- Search Tab -->
                <div id="search-tab" class="tab-content active" role="tabpanel" aria-labelledby="search-tab-button">
                    <div class="form-group">
                        <label class="form-label" for="citySearch">Search for a City</label>
                        <input type="text"
                               id="citySearch"
                               class="form-input"
                               placeholder="e.g., New York, London, Tokyo..."
                               oninput="searchCities(this.value)"
                               aria-label="Search for a city"
                               aria-describedby="citySearch-help"
                               aria-autocomplete="list"
                               aria-controls="searchResults"
                               title="Start typing a city name to search for locations worldwide">
                        <p class="form-help" id="citySearch-help">Start typing to search for cities worldwide</p>
                    </div>

                    <div class="search-results">
                        <div id="searchResults" class="results-dropdown" role="listbox" aria-label="Search results"></div>
                    </div>
                </div>

                <!-- ZIP Code Tab -->
                <div id="zip-tab" class="tab-content" role="tabpanel" aria-labelledby="zip-tab-button">
                    <div class="form-group">
                        <label class="form-label" for="zipCode">ZIP / Postal Code</label>
                        <input type="text"
                               id="zipCode"
                               class="form-input"
                               placeholder="e.g., 10001, SW1A 1AA, 75001"
                               aria-label="ZIP or postal code"
                               aria-describedby="zipCode-help"
                               title="Enter a US ZIP code or international postal code to find the location">
                        <p class="form-help" id="zipCode-help">Enter a US ZIP code or international postal code</p>
                    </div>
                    <button class="btn btn-primary"
                            onclick="lookupZipCode()"
                            aria-label="Look up location by ZIP code"
                            title="Search for the location using the ZIP or postal code entered">Look Up Location</button>
                </div>

                <!-- Coordinates Tab -->
                <div id="coords-tab" class="tab-content" role="tabpanel" aria-labelledby="coords-tab-button">
                    <div class="form-group">
                        <label class="form-label" for="manualLat">Latitude</label>
                        <input type="number"
                               id="manualLat"
                               class="form-input"
                               step="0.000001"
                               min="-90"
                               max="90"
                               placeholder="40.7128"
                               aria-label="Latitude coordinate"
                               aria-describedby="manualLat-help"
                               title="Enter latitude coordinate (between -90 and 90 degrees) - positive for North, negative for South">
                        <p class="form-help" id="manualLat-help">Between -90 and 90</p>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="manualLon">Longitude</label>
                        <input type="number"
                               id="manualLon"
                               class="form-input"
                               step="0.000001"
                               min="-180"
                               max="180"
                               placeholder="-74.0060"
                               aria-label="Longitude coordinate"
                               aria-describedby="manualLon-help"
                               title="Enter longitude coordinate (between -180 and 180 degrees) - positive for East, negative for West">
                        <p class="form-help" id="manualLon-help">Between -180 and 180</p>
                    </div>
                    <button class="btn btn-primary"
                            onclick="lookupCoordinates()"
                            aria-label="Look up location by coordinates"
                            title="Search for the location using the coordinates entered">Look Up Location</button>
                </div>

                <!-- Location Form (shown after selection) -->
                <form id="locationForm" class="add-location-form-hidden" role="form" aria-label="Confirm and save location">
    <input type="hidden" name="csrf_token" value="{{.csrf_token}}">
                    <h3 class="text-cyan add-location-form-title">Confirm Location Details</h3>

                    <div class="form-group">
                        <label class="form-label" for="name">Location Name</label>
                        <input type="text"
                               id="name"
                               class="form-input"
                               required
                               placeholder="e.g., Home, Office"
                               aria-label="Location name"
                               aria-required="true"
                               aria-describedby="name-help"
                               title="Give this location a memorable name like 'Home', 'Office', or 'Vacation Spot'">
                        <p class="form-help" id="name-help">Give this location a memorable name</p>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="displayCity">City</label>
                        <input type="text"
                               id="displayCity"
                               class="form-input"
                               readonly
                               aria-label="City and country"
                               aria-readonly="true"
                               title="City and country for the selected location">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="displayCoords">Coordinates</label>
                        <input type="text"
                               id="displayCoords"
                               class="form-input"
                               readonly
                               aria-label="Latitude and longitude coordinates"
                               aria-readonly="true"
                               title="Latitude and longitude coordinates for the selected location">
                    </div>

                    <input type="hidden" id="latitude" name="latitude" aria-hidden="true">
                    <input type="hidden" id="longitude" name="longitude" aria-hidden="true">
                    <input type="hidden" id="timezone" name="timezone" aria-hidden="true">

                    <div class="flex gap-md add-location-form-actions">
                        <button type="submit"
                                class="btn btn-primary"
                                aria-label="Save location"
                                title="Save this location to your dashboard">üíæ Save Location</button>
                        <button type="button"
                                class="btn btn-secondary"
                                onclick="resetForm()"
                                aria-label="Start over"
                                title="Clear the form and search for a different location">üîÑ Start Over</button>
                        <button type="button"
                                class="btn btn-ghost"
                                onclick="window.location.href='/user/dashboard'"
                                aria-label="Cancel"
                                title="Cancel and return to dashboard without saving">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        let searchTimeout;
        let selectedLocation = null;

        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));

            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');

            // Reset form
            resetForm();
        }

        function searchCities(query) {
            clearTimeout(searchTimeout);

            if (query.length < 2) {
                document.getElementById('searchResults').classList.remove('active');
                return;
            }

            searchTimeout = setTimeout(async () => {
                try {
                    const response = await fetch(`/api/v1/locations/search?q=${encodeURIComponent(query)}`);
                    const results = await response.json();

                    displaySearchResults(results);
                } catch (error) {
                    console.error('Search failed:', error);
                }
            }, 300);
        }

        function displaySearchResults(results) {
            const container = document.getElementById('searchResults');

            if (!results || results.length === 0) {
                container.innerHTML = '<div class="result-item">No results found</div>';
                container.classList.add('active');
                return;
            }

            container.innerHTML = results.map(result => `
                <div class="result-item" onclick='selectLocation(${JSON.stringify(result)})'>
                    <div class="result-city">${result.name}</div>
                    <div class="result-details">
                        ${result.admin1 ? result.admin1 + ', ' : ''}${result.country}
                        <span class="add-location-result-opacity">‚Ä¢ ${result.latitude.toFixed(4)}, ${result.longitude.toFixed(4)}</span>
                    </div>
                </div>
            `).join('');

            container.classList.add('active');
        }

        function selectLocation(location) {
            selectedLocation = location;
            document.getElementById('searchResults').classList.remove('active');

            // Fill in the form
            document.getElementById('name').value = location.name;
            document.getElementById('displayCity').value = `${location.name}, ${location.admin1 ? location.admin1 + ', ' : ''}${location.country}`;
            document.getElementById('displayCoords').value = `${location.latitude.toFixed(6)}, ${location.longitude.toFixed(6)}`;
            document.getElementById('latitude').value = location.latitude;
            document.getElementById('longitude').value = location.longitude;
            document.getElementById('timezone').value = location.timezone || '';

            // Show the form
            document.getElementById('locationForm').classList.add('location-form-visible');
            showMessage('Location selected! Adjust the name if needed and click Save.', 'success');
        }

        async function lookupZipCode() {
            const zipCode = document.getElementById('zipCode').value.trim();

            if (!zipCode) {
                showMessage('Please enter a ZIP or postal code', 'error');
                return;
            }

            Loading.show('#zip-tab');

            try {
                const response = await fetch(`/api/v1/locations/lookup/zip/${encodeURIComponent(zipCode)}`);
                const location = await response.json();

                if (response.ok) {
                    selectLocation(location);
                } else {
                    showMessage(location.error || 'ZIP code not found', 'error');
                }
            } catch (error) {
                showMessage('Failed to look up ZIP code', 'error');
            } finally {
                Loading.hide('#zip-tab');
            }
        }

        async function lookupCoordinates() {
            const lat = parseFloat(document.getElementById('manualLat').value);
            const lon = parseFloat(document.getElementById('manualLon').value);

            if (isNaN(lat) || isNaN(lon)) {
                showMessage('Please enter valid coordinates', 'error');
                return;
            }

            Loading.show('#coords-tab');

            try {
                const response = await fetch(`/api/v1/locations/lookup/coords?lat=${lat}&lon=${lon}`);
                const location = await response.json();

                if (response.ok) {
                    selectLocation(location);
                } else {
                    showMessage(location.error || 'Location not found', 'error');
                }
            } catch (error) {
                showMessage('Failed to look up coordinates', 'error');
            } finally {
                Loading.hide('#coords-tab');
            }
        }

        function useCurrentLocation() {
            if (!navigator.geolocation) {
                showMessage('Geolocation is not supported by your browser', 'error');
                return;
            }

            showMessage('Getting your location...', 'info');

            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;

                    try {
                        const response = await fetch(`/api/v1/locations/lookup/coords?lat=${lat}&lon=${lon}`);
                        const location = await response.json();

                        if (response.ok) {
                            selectLocation(location);
                        } else {
                            showMessage('Could not identify your location', 'error');
                        }
                    } catch (error) {
                        showMessage('Failed to look up your location', 'error');
                    }
                },
                (error) => {
                    showMessage('Unable to get your location: ' + error.message, 'error');
                }
            );
        }

        function resetForm() {
            document.getElementById('locationForm').classList.remove('location-form-visible');
            document.getElementById('searchResults').classList.remove('active');
            document.getElementById('citySearch').value = '';
            document.getElementById('zipCode').value = '';
            document.getElementById('manualLat').value = '';
            document.getElementById('manualLon').value = '';
            selectedLocation = null;
            clearMessage();
        }

        document.getElementById('locationForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const data = {
                name: document.getElementById('name').value,
                latitude: parseFloat(document.getElementById('latitude').value),
                longitude: parseFloat(document.getElementById('longitude').value),
                timezone: document.getElementById('timezone').value || ''
            };

            try {
                const response = await fetch('/api/v1/locations', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    Toast.success('Location saved successfully!');
                    setTimeout(() => {
                        window.location.href = '/user/dashboard';
                    }, 1500);
                } else {
                    const error = await response.json();
                    showMessage(error.error || 'Failed to save location', 'error');
                }
            } catch (error) {
                showMessage('Error saving location', 'error');
            }
        });

        function showMessage(message, type) {
            clearMessage(); // Clear previous messages first
            Alert.create(message, {
                type: type,
                container: '#message'
            });
        }

        function clearMessage() {
            const msgEl = document.getElementById('message');
            if (msgEl) {
                msgEl.innerHTML = '';
            }
        }

        // Initialize notification polling
        if (typeof Notifications !== 'undefined') {
            Notifications.startPolling(30000);
        }
    </script>

{{template "footer" .}}
