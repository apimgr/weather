<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üåç Earthquake Monitor - Weather</title>
    <link rel="stylesheet" href="/static/css/dracula.css">
    <script src="/static/js/app.js" defer></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
    {{template "navbar" .}}

    <div class="weather-container">

        <!-- Location Search Form -->
        <form id="earthquake-form" class="search-form" role="form" aria-label="Earthquake search filters">
            <div class="search-row-single flex-column-mobile">
                <input
                    type="text"
                    name="location"
                    id="eq-location-input"
                    class="location-input flex-1"
                    placeholder="üîç Search location or coordinates"
                    value="{{if .Location}}{{.Location}}{{end}}"
                    autocomplete="off"
                    aria-label="Search location or coordinates"
                    title="Search for earthquakes near a specific location - enter a city name or coordinates"
                >
            </div>

            <div class="search-row flex-column-mobile">
                <select name="feed"
                        class="select-input flex-1"
                        aria-label="Select time range and magnitude filter"
                        title="Choose which earthquakes to display based on time range and minimum magnitude">
                    <option value="all_hour" {{if eq .FeedType "all_hour"}}selected{{end}}>Past Hour</option>
                    <option value="all_day" {{if eq .FeedType "all_day"}}selected{{end}}>Past Day</option>
                    <option value="all_week" {{if eq .FeedType "all_week"}}selected{{end}}>Past Week</option>
                    <option value="all_month" {{if eq .FeedType "all_month"}}selected{{end}}>Past Month</option>
                    <option value="4.5_day" {{if eq .FeedType "4.5_day"}}selected{{end}}>M4.5+ Day</option>
                    <option value="4.5_week" {{if eq .FeedType "4.5_week"}}selected{{end}}>M4.5+ Week</option>
                    <option value="significant_day" {{if eq .FeedType "significant_day"}}selected{{end}}>Significant Day</option>
                    <option value="significant_week" {{if eq .FeedType "significant_week"}}selected{{end}}>Significant Week</option>
                </select>
                <select name="sort"
                        class="select-input flex-1"
                        aria-label="Sort earthquakes by"
                        title="Choose how to sort the earthquake results">
                    <option value="newest" {{if or (eq .Sort "newest") (not .Sort)}}selected{{end}}>Newest First</option>
                    <option value="oldest" {{if eq .Sort "oldest"}}selected{{end}}>Oldest First</option>
                    <option value="magnitude" {{if eq .Sort "magnitude"}}selected{{end}}>By Magnitude</option>
                    <option value="depth" {{if eq .Sort "depth"}}selected{{end}}>By Depth</option>
                </select>
                <input
                    type="number"
                    name="number"
                    placeholder="Limit (0 = all)"
                    min="0"
                    value="{{if .Number}}{{.Number}}{{end}}"
                    class="location-input flex-1"
                    aria-label="Maximum number of results"
                    title="Limit the number of results shown (enter 0 to show all earthquakes)"
                >
            </div>

            {{if .Location}}
            <div class="search-row-single">
                <input
                    type="number"
                    name="radius"
                    placeholder="Radius (km)"
                    value="{{if .Radius}}{{.Radius}}{{end}}"
                    min="100"
                    max="20000"
                    class="location-input"
                    aria-label="Search radius in kilometers"
                    title="Search radius around the location in kilometers (100-20000 km)"
                >
            </div>
            {{end}}

            <div class="search-row-single">
                <button type="submit"
                        class="search-button primary flex-1"
                        aria-label="Search for earthquakes"
                        title="Search for earthquakes with the selected filters">
                    üåç Search Earthquakes
                </button>
                {{if .Location}}
                <button type="button"
                        class="search-button secondary flex-1"
                        onclick="window.location.href='/earthquake?feed={{.FeedType}}'"
                        aria-label="View all earthquakes worldwide"
                        title="Clear location filter and view all earthquakes worldwide">
                    üó∫Ô∏è View All
                </button>
                {{end}}
            </div>
        </form>

        {{if .LocationData}}
            {{template "location_details" .LocationData}}
        {{end}}

        <!-- Statistics -->
        <div class="grid-auto-fit-200 margin-y-lg">
            <div class="stat-box">
                <div class="stat-box__value stat-box__value--cyan">{{len .Earthquakes}}</div>
                <div class="stat-box__label">Total Earthquakes</div>
            </div>
            <div class="stat-box">
                {{ $maxMag := 0.0 }}
                {{range .Earthquakes}}
                    {{if gt .Magnitude $maxMag}}{{$maxMag = .Magnitude}}{{end}}
                {{end}}
                <div class="stat-box__value stat-box__value--orange">{{printf "%.1f" $maxMag}}</div>
                <div class="stat-box__label">Largest Magnitude</div>
            </div>
            <div class="stat-box">
                {{ $tsunami := 0 }}
                {{range .Earthquakes}}
                    {{if eq .Tsunami 1}}{{$tsunami = 1}}{{end}}
                {{end}}
                <div class="stat-box__value stat-box__value--purple">{{if gt $tsunami 0}}‚ö†Ô∏è{{else}}‚úì{{end}}</div>
                <div class="stat-box__label">Tsunami Warnings</div>
            </div>
        </div>

        <!-- Interactive Map -->
        <div id="map" class="map-container"></div>

        <!-- Earthquake List -->
        <div class="margin-y-lg">
            <h2 class="text-cyan">Recent Earthquakes</h2>
            <div class="scroll-container">
                {{range .Earthquakes}}
                {{ $severity := "earthquake-item--moderate" }}
                {{ if eq .Tsunami 1 }}
                    {{ $severity = "earthquake-item--tsunami" }}
                {{ else if lt .Magnitude 2.0 }}
                    {{ $severity = "earthquake-item--minor" }}
                {{ else if lt .Magnitude 4.0 }}
                    {{ $severity = "earthquake-item--light" }}
                {{ else if lt .Magnitude 5.0 }}
                    {{ $severity = "earthquake-item--moderate" }}
                {{ else }}
                    {{ $severity = "earthquake-item--strong" }}
                {{ end }}

                {{ $badge := "magnitude-badge--moderate" }}
                {{ if lt .Magnitude 2.0 }}
                    {{ $badge = "magnitude-badge--minor" }}
                {{ else if lt .Magnitude 4.0 }}
                    {{ $badge = "magnitude-badge--light" }}
                {{ else if lt .Magnitude 5.0 }}
                    {{ $badge = "magnitude-badge--moderate" }}
                {{ else if lt .Magnitude 6.0 }}
                    {{ $badge = "magnitude-badge--strong" }}
                {{ else }}
                    {{ $badge = "magnitude-badge--major" }}
                {{ end }}

                <div onclick="focusEarthquake({{.Latitude}}, {{.Longitude}})" class="earthquake-item {{$severity}}">
                    <div class="flex gap-md flex-column-mobile">
                        <span class="magnitude-badge {{$badge}}">
                            {{printf "%.1f" .Magnitude}}
                        </span>
                        <div class="flex-1">
                            <div class="font-semibold">{{.Place}}</div>
                            {{if eq .Tsunami 1}}<span class="text-cyan font-semibold">üåä TSUNAMI</span>{{end}}
                            <div class="eq-info">
                                {{.Time.Format "2006-01-02 15:04:05"}} ‚Ä¢ Depth: {{printf "%.1f" .Depth}}km
                                {{if .Felt}} ‚Ä¢ Felt by {{.Felt}} people{{end}}
                            </div>
                            <div class="eq-details">
                                <div><strong>Coordinates:</strong> {{.Latitude}}, {{.Longitude}}</div>
                                <div><strong>Type:</strong> {{.MagnitudeType}} {{.Type}}</div>
                                <div><strong>Status:</strong> {{.Status}}</div>
                                {{if .CDI}}<div><strong>CDI:</strong> {{printf "%.1f" .CDI}}</div>{{end}}
                                {{if .MMI}}<div><strong>MMI:</strong> {{printf "%.1f" .MMI}}</div>{{end}}
                            </div>
                        </div>
                        <a href="/earthquake/detail/{{.ID}}" onclick="event.stopPropagation();" class="text-cyan font-medium">Details ‚Üí</a>
                    </div>
                </div>
                {{else}}
                <p class="text-center text-comment margin-y-lg">No earthquakes found.</p>
                {{end}}
            </div>
        </div>

        {{if .Earthquakes}}
        <!-- Console Commands -->
        <div class="console-section">
            <h3 class="console-section__title text-green">üìü Console Commands</h3>
            <div class="console-commands">
                <div class="command-item">
                    <strong class="console-section__label">All Earthquakes:</strong>
                    <div class="code-wrapper">
                        <code class="mobile-code">curl -s {{.HostInfo.FullHost}}/api/v1/earthquakes?feed={{.FeedType}}</code>
                        <button class="copy-btn" onclick="copyCommand(this, 'curl -s {{.HostInfo.FullHost}}/api/v1/earthquakes?feed={{.FeedType}}')">Copy</button>
                    </div>
                </div>
                {{if .Location}}
                <div class="command-item">
                    <strong class="console-section__label">Selected Feed:</strong>
                    <div class="code-wrapper">
                        <code class="mobile-code">curl -s {{.HostInfo.FullHost}}/api/v1/earthquakes?feed={{.FeedType}}</code>
                        <button class="copy-btn" onclick="copyCommand(this, 'curl -s {{.HostInfo.FullHost}}/api/v1/earthquakes?feed={{.FeedType}}')">Copy</button>
                    </div>
                </div>
                {{end}}
            </div>
        </div>
        {{end}}

        <div class="data-footer">
            <p class="data-footer__text">
                Data from <a href="https://earthquake.usgs.gov/" target="_blank" class="data-footer__link">USGS Earthquake Hazards Program</a><br>
                Updated frequently throughout the day
            </p>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Auto-fill location with closest earthquake on page load
        window.addEventListener('DOMContentLoaded', function() {
            const earthquakes = [
                {{range .Earthquakes}}
                {
                    lat: {{.Latitude}},
                    lng: {{.Longitude}},
                    mag: {{.Magnitude}},
                    place: "{{.Place}}"
                },
                {{end}}
            ];

            // If no location is set and we have earthquakes, find the closest one
            {{if not .Location}}
            if (earthquakes.length > 0) {
                const centerLat = {{.CenterLat}};
                const centerLon = {{.CenterLon}};

                // Find closest earthquake to user location
                let closest = earthquakes[0];
                let minDist = Number.MAX_VALUE;

                earthquakes.forEach(eq => {
                    const dist = Math.sqrt(Math.pow(eq.lat - centerLat, 2) + Math.pow(eq.lng - centerLon, 2));
                    if (dist < minDist) {
                        minDist = dist;
                        closest = eq;
                    }
                });

                // Extract location from place (e.g., "10 km NE of Albany, NY" -> "Albany, NY")
                let locationName = closest.place;
                const match = locationName.match(/(?:of|near)\s+([^,]+(?:,\s*[^,]+)?)/i);
                if (match) {
                    locationName = match[1].trim();
                }

                // Set the input value
                document.getElementById('eq-location-input').placeholder = 'üîç ' + locationName + ' (closest)';
            }
            {{end}}
        });

        // Initialize map
        const map = L.map('map').setView([{{.CenterLat}}, {{.CenterLon}}], {{if .Location}}6{{else}}2{{end}});

        // Add tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors',
            maxZoom: 18
        }).addTo(map);

        // Add earthquakes to map
        const earthquakes = [
            {{range .Earthquakes}}
            {
                lat: {{.Latitude}},
                lng: {{.Longitude}},
                mag: {{.Magnitude}},
                place: "{{.Place}}",
                time: "{{.Time.Format "2006-01-02 15:04:05"}}",
                depth: {{.Depth}},
                tsunami: {{.Tsunami}},
                url: "{{.URL}}"
            },
            {{end}}
        ];

        const markers = [];
        earthquakes.forEach(eq => {
            // Size marker based on magnitude
            const size = Math.max(5, eq.mag * 4);
            const color = eq.mag < 2 ? '#50fa7b' :
                         eq.mag < 4 ? '#f1fa8c' :
                         eq.mag < 5 ? '#ffb86c' :
                         eq.mag < 6 ? '#ff5555' : '#bd93f9';

            const marker = L.circleMarker([eq.lat, eq.lng], {
                radius: size,
                fillColor: color,
                color: '#f8f8f2',
                weight: 2,
                opacity: 0.8,
                fillOpacity: 0.6
            }).addTo(map);

            // Popup content
        const popupContent = `
            <div class="map-popup">
                <strong class="map-popup__title">M ${eq.mag.toFixed(1)}</strong>
                <div class="map-popup__place">${eq.place}</div>
                <div class="map-popup__time">${eq.time}</div>
                <div class="map-popup__meta">Depth: ${eq.depth.toFixed(1)}km</div>
                ${eq.tsunami ? '<div class="map-popup__warning">üåä Tsunami Warning</div>' : ''}
                <a href="${eq.url}" target="_blank" class="map-popup__link">View Details</a>
            </div>
        `;
            marker.bindPopup(popupContent);
            markers.push(marker);
        });

        // Fit map to show all earthquake markers when location is searched
        {{if .Location}}
        if (markers.length > 0) {
            const group = L.featureGroup(markers);
            map.fitBounds(group.getBounds().pad(0.1));
        }
        {{end}}

        // Function to focus on earthquake
        function focusEarthquake(lat, lng) {
            map.setView([lat, lng], 8);
        }

        // Toggle details on click
        document.querySelectorAll('.earthquake-item').forEach(item => {
            item.addEventListener('click', function() {
                const details = this.querySelector('.eq-details');
                if (details) {
                    details.classList.toggle('visible');
                }
            });
        });

        // Auto-refresh every 5 minutes
        setTimeout(() => location.reload(), 300000);

        // Copy command to clipboard
        function copyCommand(button, text) {
            navigator.clipboard.writeText(text).then(() => {
                const originalText = button.textContent;
                button.textContent = '‚úì Copied!';
                button.classList.add('copied');
                setTimeout(() => {
                    button.textContent = originalText;
                    button.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
                button.textContent = '‚úó Failed';
                setTimeout(() => {
                    button.textContent = 'Copy';
                }, 2000);
            });
        }

        // Initialize notification polling
        if (typeof Notifications !== 'undefined') {
            Notifications.startPolling(30000);
        }
    </script>

{{template "footer" .}}
