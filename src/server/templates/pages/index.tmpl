{{template "head" .}}
{{template "navbar" .}}

<main class="container" id="main-content" role="main" aria-label="Weather forecast content">
    <div class="admin-header">
        <div>
            <h1>üå§Ô∏è Weather Forecast</h1>
            <p class="subtitle">Real-time weather data and forecasts</p>
        </div>
    </div>

        <!-- Location Search Form - Mobile First -->
        <form id="weather-form" class="weather-form" role="search" aria-label="{{t .server.Lang "aria_search_form"}}">
            <div class="weather-form__wrapper">
                <!-- First row: Location input and units -->
                <div class="weather-form__row">
                    <div class="weather-form__input-wrapper">
                        <label for="location-input" class="sr-only">{{t .server.Lang "label_location"}}</label>
                        <input
                            type="text"
                            id="location-input"
                            name="location"
                            class="location-input weather-form__input"
                            placeholder="Enter city or coordinates"
                            value="{{.Location}}"
                            autocomplete="off"
                            aria-label="Location search input"
                            aria-autocomplete="list"
                            aria-controls="autocomplete-dropdown"
                        >
                        <div id="autocomplete-dropdown" class="autocomplete-dropdown" role="listbox" aria-label="Location suggestions"></div>
                    </div>
                    <label for="units-select" class="sr-only">Temperature unit</label>
                    <select name="units" id="units-select" class="location-input weather-form__units" aria-label="Temperature unit selection">
                        <option value="imperial"{{if eq .Units "imperial"}} selected{{end}}>¬∞F</option>
                        <option value="metric"{{if eq .Units "metric"}} selected{{end}}>¬∞C</option>
                    </select>
                </div>

                <!-- Second row: Buttons -->
                <div class="weather-form__button-row">
                    <button type="submit" class="search-button weather-form__button" aria-label="{{t .server.Lang "btn_search"}} weather">
                        üå§Ô∏è Get Weather
                    </button>
                    <button type="button" id="location-btn" class="search-button weather-form__button--location" aria-label="Use my current location">
                        üìç My Location
                    </button>
                </div>
            </div>
        </form>

        {{if .WeatherData}}
            <!-- Location Details Section -->
            <div class="location-details-section">
                <div class="location-info">
                    <!-- Always show location name -->
                    <div class="location-detail">
                        üìç <strong class="text-cyan">Location:</strong>
                        <span class="location-detail-value--yellow">{{if .WeatherData.Location.ShortName}}{{.WeatherData.Location.ShortName}}{{else}}{{.WeatherData.Location.Name}}, {{.WeatherData.Location.Country}}{{end}}</span>
                    </div>
                    <div class="location-detail">
                        üåç <strong class="text-cyan">Country:</strong>
                        <span class="location-detail-value--green">{{.WeatherData.Location.Country}}</span>
                    </div>
                    <div class="location-detail">
                        üó∫Ô∏è <strong class="text-cyan">Coordinates:</strong>
                        <span class="text-pink">{{.WeatherData.Location.Latitude}}, {{.WeatherData.Location.Longitude}}</span>
                    </div>
                    {{if .WeatherData.Location.Population}}
                    <div class="location-detail">
                        üë• <strong class="text-cyan">Population:</strong>
                        <span class="location-detail-value--orange">{{.WeatherData.Location.PopulationFormatted}}</span>
                    </div>
                    {{end}}
                </div>
            </div>
        {{end}}

        {{if .Error}}
            <div class="error-message-box">
                <strong>Error:</strong> {{.Error}}
            </div>
        {{end}}

        {{if .WeatherData}}
            <!-- Current Weather -->
            <div class="current-weather">
                <div class="weather-icon">
                    {{.WeatherData.Current.Icon}}
                </div>
                <div class="weather-details">
                    <div class="temperature">
                        {{printf "%.0f" .WeatherData.Current.Temperature}}{{if eq .Units "imperial"}}¬∞F{{else}}¬∞C{{end}}
                    </div>
                    <div class="description">
                        {{.WeatherData.Current.Description}}
                    </div>
                    <div class="weather-stats">
                        <div class="stat">Feels like: <span class="stat-value">{{printf "%.0f" .WeatherData.Current.FeelsLike}}{{if eq .Units "imperial"}}¬∞F{{else}}¬∞C{{end}}</span></div>
                        <div class="stat">Wind: <span class="stat-value">{{printf "%.0f" .WeatherData.Current.WindSpeed}} {{if eq .Units "imperial"}}mph{{else}}km/h{{end}}</span></div>
                        <div class="stat">Humidity: <span class="stat-value">{{.WeatherData.Current.Humidity}}%</span></div>
                        <div class="stat">Pressure: <span class="stat-value">{{if eq .Units "imperial"}}{{printf "%.2f" .WeatherData.Current.Pressure}} inHg{{else}}{{printf "%.0f" .WeatherData.Current.Pressure}} hPa{{end}}</span></div>
                    </div>
                </div>
            </div>

            <!-- Mobile-Optimized Forecast -->
            <div class="forecast-section">
                <!-- Desktop Table (hidden on mobile) -->
                <table class="forecast-table desktop-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Conditions</th>
                            <th>Temperature</th>
                            <th>Feels Like</th>
                            <th>Wind</th>
                            <th>Precipitation</th>
                        </tr>
                    </thead>
                    <tbody>
                    {{range $index, $day := .WeatherData.Forecast.Days}}
                        {{if lt $index 7}}
                        <tr>
                            <td class="day-header">{{$day.DateFormatted}}</td>
                            <td class="forecast-condition">
                                {{$day.Icon}} {{$day.Description}}
                            </td>
                            <td class="forecast-temp">
                                <span class="forecast-temp-high">‚Üë{{printf "%.0f" $day.TempMax}}¬∞</span>
                                <span class="forecast-temp-low">‚Üì{{printf "%.0f" $day.TempMin}}¬∞</span>
                                {{if eq $.Units "imperial"}}F{{else}}C{{end}}
                            </td>
                            <td class="forecast-feels-like">
                                <span class="forecast-temp-high">‚Üë{{printf "%.0f" $day.FeelsLikeMax}}¬∞</span>
                                <span class="forecast-temp-low">‚Üì{{printf "%.0f" $day.FeelsLikeMin}}¬∞</span>
                            </td>
                            <td class="wind-info">{{printf "%.0f" $day.WindSpeedMax}} {{if eq $.Units "imperial"}}mph{{else}}km/h{{end}}</td>
                            <td class="precipitation">{{printf "%.1f" $day.Precipitation}} {{if eq $.Units "imperial"}}in{{else}}mm{{end}} ({{$day.PrecipitationProbability}}%)</td>
                        </tr>
                        {{end}}
                    {{end}}
                    </tbody>
                </table>

                <!-- Mobile Cards (shown on mobile, hidden on desktop) -->
                <div class="mobile-forecast">
                    {{range $index, $day := .WeatherData.Forecast.Days}}
                        {{if lt $index 5}}
                        <div class="forecast-card">
                            <div class="forecast-card-header">
                                {{$day.DateFormatted}}
                            </div>
                            <div class="forecast-card-content">
                                <div class="forecast-main">
                                    <span class="forecast-icon">{{$day.Icon}}</span>
                                    <span class="forecast-temp">
                                        <span class="forecast-temp-high">‚Üë{{printf "%.0f" $day.TempMax}}¬∞</span>
                                        <span class="forecast-temp-low">‚Üì{{printf "%.0f" $day.TempMin}}¬∞</span>
                                        {{if eq $.Units "imperial"}}F{{else}}C{{end}}
                                    </span>
                                </div>
                                <div class="forecast-details-mobile">
                                    <div>{{$day.Description}}</div>
                                    <div class="wind-info">üí® {{printf "%.0f" $day.WindSpeedMax}} {{if eq $.Units "imperial"}}mph{{else}}km/h{{end}}</div>
                                    <div class="precipitation">‚òî {{printf "%.1f" $day.Precipitation}} {{if eq $.Units "imperial"}}in{{else}}mm{{end}} ({{$day.PrecipitationProbability}}%)</div>
                                    {{if $day.FeelsLikeMax}}
                                    <div class="text-comment">Feels like ‚Üë{{printf "%.0f" $day.FeelsLikeMax}}¬∞ ‚Üì{{printf "%.0f" $day.FeelsLikeMin}}¬∞</div>
                                    {{end}}
                                </div>
                            </div>
                        </div>
                        {{end}}
                    {{end}}
                </div>
            </div>

            <!-- Console Command Examples -->
            <div class="console-container">
                <h3 class="console-title">Console Access</h3>
                <div class="console-commands">
                    <div class="command-item">
                        <strong class="console-label">Weather:</strong>
                        <code class="mobile-code">curl -q -LSs {{.HostInfo.FullHost}}/{{.LocationFormatted}}</code>
                    </div>
                    <div class="command-item">
                        <strong class="console-label">One-Line:</strong>
                        <code class="mobile-code">curl -q -LSs {{.HostInfo.FullHost}}/{{.LocationFormatted}}?format=3</code>
                    </div>
                    <div class="command-item">
                        <strong class="console-label">Moon:</strong>
                        <code class="mobile-code">curl -q -LSs {{.HostInfo.FullHost}}/moon</code>
                    </div>
                    <div class="command-item">
                        <strong class="console-label">Moon Location:</strong>
                        <code class="mobile-code">curl -q -LSs {{.HostInfo.FullHost}}/moon/{{.LocationFormatted}}</code>
                    </div>
                    <div class="command-item">
                        <strong class="console-label">JSON API:</strong>
                        <code class="mobile-code">curl -q -LSs {{.HostInfo.FullHost}}/api/v1/weather?location={{.LocationFormatted}}</code>
                    </div>
                </div>
            </div>
        {{else}}
            <div class="welcome-container">
                <h2 class="welcome-title">Welcome to Weather</h2>
                <p class="welcome-text">Your location has been detected and pre-filled above. Try these examples:</p>
                <div class="city-grid">
                    <a href="?location=London" class="city-link">üá¨üáß London</a>
                    <a href="?location=Tokyo" class="city-link">üáØüáµ Tokyo</a>
                    <a href="?location=Paris" class="city-link">üá´üá∑ Paris</a>
                    <a href="?location=Sydney" class="city-link">üá¶üá∫ Sydney</a>
                </div>

                <div class="city-grid-container">
                    <h4 class="city-grid-title">Console Access:</h4>
                    <div class="console-commands">
                        <code class="mobile-code">curl -q -LSs {{.HostInfo.FullHost}}/London</code>
                        <code class="mobile-code">curl -q -LSs {{.HostInfo.FullHost}}/api/v1/weather?location=Paris</code>
                    </div>
                </div>
            </div>
        {{end}}

        {{if not .HideFooter}}
        <div class="page-footer-main">
            <p class="page-footer-text">
                <a href="https://github.com/apimgr/weather" target="_blank" class="page-footer-link">Weather</a>
                <span class="page-footer-divider">‚Ä¢</span>
                <span>Made with <span class="page-footer-heart">‚ù§Ô∏è</span></span>
                <span class="page-footer-divider">‚Ä¢</span>
                <a href="/docs" class="page-footer-link--green">v2.0.0</a>
            </p>
        </div>
        {{end}}
    </div>

    <script>
        async function getLocation() {
            const button = document.getElementById('location-btn');
            if (!button) {
                console.error('Location button not found');
                return;
            }
            const originalText = button.textContent;
            button.textContent = 'üìç Getting...';
            button.disabled = true;

            try {
                // console.log('Starting geolocation process...');

                // Check permissions first
                if (navigator.permissions) {
                    const permission = await navigator.permissions.query({name: 'geolocation'});
                    // console.log('Geolocation permission state:', permission.state);
                }

                if (!navigator.geolocation) {
                    throw new Error('Geolocation not supported');
                }

                // Try high-accuracy GPS first
                button.textContent = 'üìç GPS...';
                let position = null;

                try {
                    console.log('üì° Attempting high-accuracy GPS location (protocol:', window.location.protocol + ')');

                    // Check if this is a "force refresh" (long press or double click)
                    const forceRefresh = button.dataset.forceRefresh === 'true';
                    if (forceRefresh) {
                        console.log('üîÑ Force refresh requested - bypassing cache');
                        button.dataset.forceRefresh = 'false';
                    }

                    position = await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(
                            (pos) => {
                                console.log('‚úÖ GPS success! Accuracy:', pos.coords.accuracy + 'm');
                                console.log('üìç GPS coordinates:', pos.coords.latitude.toFixed(6), pos.coords.longitude.toFixed(6));

                                // Show accuracy warning if location is imprecise
                                if (pos.coords.accuracy > 1000) {
                                    console.warn('‚ö†Ô∏è Low accuracy GPS reading:', pos.coords.accuracy + 'm');
                                    button.textContent = 'üìç Low Accuracy';
                                    setTimeout(() => {
                                        button.textContent = 'üìç My Location';
                                    }, 2000);
                                }

                                resolve(pos);
                            },
                            (err) => {
                                console.log('‚ùå GPS failed - Code:', err.code, 'Message:', err.message);
                                console.log('Error codes: 1=PERMISSION_DENIED, 2=POSITION_UNAVAILABLE, 3=TIMEOUT');
                                reject(err);
                            },
                            {
                                timeout: forceRefresh ? 30000 : 20000, // Longer timeout for force refresh
                                enableHighAccuracy: true, // Try GPS first
                                maximumAge: forceRefresh ? 0 : 60000 // No cache for force refresh
                            }
                        );
                    });
                } catch (gpsError) {
                    console.log('üîÑ High-accuracy GPS failed, trying network location...');
                    button.textContent = 'üìç Location...';

                    // Fallback to network-based location
                    try {
                        console.log('üåê Attempting network-based location...');
                        position = await new Promise((resolve, reject) => {
                            navigator.geolocation.getCurrentPosition(
                                (pos) => {
                                    console.log('‚úÖ Network location success! Accuracy:', pos.coords.accuracy + 'm');
                                    console.log('üìç Network coordinates:', pos.coords.latitude.toFixed(6), pos.coords.longitude.toFixed(6));
                                    resolve(pos);
                                },
                                (err) => {
                                    console.log('‚ùå Network location failed - Code:', err.code, 'Message:', err.message);
                                    reject(err);
                                },
                                {
                                    timeout: 12000, // Increased from 10 to 12 seconds
                                    enableHighAccuracy: false, // Network-based
                                    maximumAge: 600000 // 10 minute cache
                                }
                            );
                        });
                    } catch (networkError) {
                        console.log('üîÑ Network location failed, trying IP-based detection...');
                        throw networkError; // This will trigger IP fallback
                    }
                }

                console.log('Geolocation success:', position);
                const lat = position.coords.latitude.toFixed(4);
                const lon = position.coords.longitude.toFixed(4);
                const units = document.getElementById('units-select').value;

                console.log('Setting coordinates:', lat + ',' + lon);

                // Build clean coordinate URL and redirect directly
                const coordinateLocation = `${lat},${lon}`;
                const unitsParam = units !== 'imperial' ? `?units=${units}` : '';
                const newUrl = `${window.location.origin}/${coordinateLocation}${unitsParam}`;

                console.log('Geolocation redirecting to:', newUrl);

                // Visual feedback before redirect
                button.textContent = 'üìç Found!';
                setTimeout(() => {
                    window.location.href = newUrl;
                }, 500);

            } catch (error) {
                console.error('Geolocation failed:', error);
                button.textContent = originalText;
                button.disabled = false;

                let userMessage = 'Unable to get your location';

                if (error.code === 1) {
                    userMessage = 'Location access denied. Using IP-based location instead';
                    // Try IP fallback even for permission denied
                    console.log('Location permission denied, attempting IP-based fallback');
                    tryIPLocationFallback(button, originalText);
                    return;
                } else {
                    // For all other errors (GPS unavailable, timeout, etc), try IP fallback
                    userMessage = 'Location services unavailable. Using IP-based location instead';
                    console.log('All location services failed, attempting IP-based fallback');
                    tryIPLocationFallback(button, originalText);
                    return;
                }

                // Show error in a more user-friendly way
                const errorDiv = document.createElement('div');
                errorDiv.className = 'js-error-display-red';
                errorDiv.textContent = userMessage + '. Please enter a location manually.';

                const form = document.querySelector('form');
                form.parentNode.insertBefore(errorDiv, form.nextSibling);

                setTimeout(() => errorDiv.remove(), 5000);
            }
        }

        function tryIPLocationFallback(button, originalText) {
            console.log('üåê Attempting IP-based location detection via our server');
            console.log('‚ÑπÔ∏è This indicates GPS/Network location failed or was denied');
            button.textContent = 'üìç IP Location...';

            // Use our own server's IP detection endpoint
            fetch('/debug/ip')
                .then(response => {
                    console.log('üì° IP detection response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('üó∫Ô∏è Server IP location data:', data);
                    if (data.location && data.location.value) {
                        const detectedLocation = data.location.value;
                        console.log('‚úÖ IP-based location detected:', detectedLocation);
                        const units = document.getElementById('units-select').value;

                        console.log('Using server-detected location:', detectedLocation);

                        // Build clean URL and redirect directly
                        const cleanLocation = detectedLocation.replace(/ /g, '+');
                        const unitsParam = units !== 'imperial' ? `?units=${units}` : '';
                        const newUrl = `${window.location.origin}/${cleanLocation}${unitsParam}`;

                        console.log('IP fallback redirecting to:', newUrl);

                        button.textContent = 'üìç Found!';
                        setTimeout(() => {
                            window.location.href = newUrl;
                        }, 800);
                    } else {
                        throw new Error('No location in server response');
                    }
                })
                .catch(ipError => {
                    console.log('IP location fallback failed:', ipError);
                    button.textContent = originalText;
                    button.disabled = false;

                    // Show helpful message about already detected location
                    const currentLocation = document.querySelector('input[name="location"]').value || 'your approximate location';
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'js-error-display-orange';
                    errorDiv.innerHTML = `üìç Location detection not available on this device.<br>The form above is pre-filled with: <strong>${currentLocation}</strong>`;

                    const form = document.querySelector('form');
                    form.parentNode.insertBefore(errorDiv, form.nextSibling);

                    setTimeout(() => errorDiv.remove(), 6000);
                });
        }

        // Form handling and autocomplete functionality
        document.addEventListener('DOMContentLoaded', function() {
            const locationInput = document.getElementById('location-input');
            const unitsSelect = document.getElementById('units-select');
            const weatherForm = document.getElementById('weather-form');
            const autocompleteDropdown = document.getElementById('autocomplete-dropdown');

            if (locationInput && !locationInput.value) {
                locationInput.focus();
            }

            // Handle form submission - redirect to proper URL path format
            weatherForm.addEventListener('submit', function(e) {
                e.preventDefault();

                const location = locationInput.value.trim();
                const units = unitsSelect.value;

                console.log('Form submitted with location:', location, 'units:', units);

                if (!location) {
                    // Instead of popup, redirect to root with no location to show IP-based weather
                    const unitsParam = units !== 'imperial' ? `?units=${units}` : '';
                    window.location.href = `${window.location.origin}/${unitsParam}`;
                    return;
                }

                // Build clean URL: /Albany,NY instead of /Albany%2CNY
                const cleanLocation = location.replace(/ /g, '+'); // Only encode spaces as +
                const unitsParam = units !== 'imperial' ? `?units=${units}` : '';

                // Use absolute URL to avoid inheriting current path
                const baseUrl = window.location.origin;
                const newUrl = `${baseUrl}/${cleanLocation}${unitsParam}`;

                console.log('Redirecting to:', newUrl);

                // Navigate to the proper URL format
                window.location.href = newUrl;
            });

            // Autocomplete functionality
            let autocompleteTimeout;
            locationInput.addEventListener('input', function() {
                const query = this.value.trim();

                clearTimeout(autocompleteTimeout);

                if (query.length < 3) {
                    hideAutocomplete();
                    return;
                }

                autocompleteTimeout = setTimeout(() => {
                    searchLocations(query);
                }, 300); // Debounce search
            });

            // Hide autocomplete when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('#location-input') && !e.target.closest('#autocomplete-dropdown')) {
                    hideAutocomplete();
                }
            });

            // Attach geolocation button event listener with double-tap for force refresh
            const locationBtn = document.getElementById('location-btn');
            if (locationBtn) {
                let lastTap = 0;
                let tapTimeout;

                locationBtn.addEventListener('click', function(e) {
                    e.preventDefault();

                    const currentTime = new Date().getTime();
                    const tapLength = currentTime - lastTap;

                    // Clear any pending single tap
                    clearTimeout(tapTimeout);

                    if (tapLength < 500 && tapLength > 0) {
                        // Double tap detected - force refresh location
                        console.log('üîÑ Double tap detected - force refresh location');
                        this.dataset.forceRefresh = 'true';
                        this.textContent = 'üîÑ Force Refresh...';
                        setTimeout(() => {
                            this.textContent = 'üìç My Location';
                        }, 1000);
                        getLocation();
                    } else {
                        // Single tap - normal location detection
                        tapTimeout = setTimeout(() => {
                            getLocation();
                        }, 250);
                    }

                    lastTap = currentTime;
                });

                // Add tooltip hint for mobile users
                locationBtn.title = "Tap for location, double-tap for fresh GPS";
            }
        });

        function searchLocations(query) {
            // Use our search API endpoint
            fetch(`/api/v1/search?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.results && data.results.length > 0) {
                        showAutocomplete(data.results);
                    } else {
                        hideAutocomplete();
                    }
                })
                .catch(error => {
                    console.error('Search error:', error);
                    hideAutocomplete();
                });
        }

        function showAutocomplete(results) {
            const dropdown = document.getElementById('autocomplete-dropdown');
            dropdown.innerHTML = '';

            results.forEach(result => { // Show all results (scrollable dropdown)
                const item = document.createElement('div');
                item.className = 'autocomplete-item';
                item.innerHTML = `
                    <div class="city-name">${result.shortName || result.name}</div>
                    <div class="location-details">${result.fullName}</div>
                `;

                item.addEventListener('click', function() {
                    const locationInput = document.getElementById('location-input');
                    const unitsSelect = document.getElementById('units-select');

                    // Use short name with state/country code
                    const locationName = result.shortName || result.name;
                    locationInput.value = locationName;
                    hideAutocomplete();

                    // Use coordinates for navigation (more accurate)
                    const coords = `${result.latitude.toFixed(4)},${result.longitude.toFixed(4)}`;
                    const units = unitsSelect.value;
                    const unitsParam = units !== 'imperial' ? `?units=${units}` : '';
                    const newUrl = `${window.location.origin}/${coords}${unitsParam}`;

                    console.log('Autocomplete selected:', locationName, 'navigating to coords:', coords);

                    // Direct navigation instead of form submission
                    window.location.href = newUrl;
                });

                dropdown.appendChild(item);
            });

            dropdown.classList.add('show');
        }

        function hideAutocomplete() {
            const dropdown = document.getElementById('autocomplete-dropdown');
            dropdown.classList.remove('show');
        }
    </script>
</main>

{{template "footer" .}}
