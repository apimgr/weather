{{define "admin/admin-ssl.tmpl"}}
{{template "head" .}}
{{template "admin_header" .}}
{{template "admin_nav" .}}

<main class="container p-4">
    <h1>üîí SSL/TLS Certificate Management</h1>
    <p class="text-comment mb-4">Manage your SSL certificates and auto-renewal settings</p>

    <div class="grid-2 gap-lg">
        <!-- Certificate Status Card -->
        <section class="card p-4">
            <h2 class="section-title">üìú Certificate Status</h2>

            <div id="certStatus">
                <div class="text-center p-4 text-comment">
                    <div class="loading"></div>
                    <p class="mt-3">Loading certificate information...</p>
                </div>
            </div>

            <div class="flex gap-sm mt-3">
                <button class="btn btn-primary" id="refreshBtn" aria-label="Refresh certificate status">
                    üîÑ Refresh
                </button>
                <button class="btn btn-success" id="verifyBtn" aria-label="Verify certificate">
                    ‚úì Verify Certificate
                </button>
            </div>
        </section>

        <!-- Let's Encrypt Card -->
        <section class="card p-4">
            <h2 class="section-title">üåê Let's Encrypt</h2>

            <form id="letsEncryptForm">
                <input type="hidden" name="csrf_token" value="{{.csrf_token}}">
                <div class="form-group">
                    <label for="domain" class="form-label">Domain Name</label>
                    <input type="text" id="domain" class="form-input" placeholder="example.com" required aria-required="true">
                    <small class="form-help">Primary domain for the certificate</small>
                </div>

                <div class="form-group">
                    <label for="email" class="form-label">Contact Email</label>
                    <input type="email" id="email" class="form-input" placeholder="admin@example.com" required aria-required="true">
                    <small class="form-help">For renewal and security notices</small>
                </div>

                <div class="form-group">
                    <label for="altNames" class="form-label">Alternative Names (Optional)</label>
                    <textarea id="altNames" class="form-textarea" rows="3" placeholder="www.example.com&#10;api.example.com"></textarea>
                    <small class="form-help">One domain per line</small>
                </div>

                <div class="form-group">
                    <label class="checkbox-row">
                        <input type="checkbox" id="agreeToS" required>
                        <span>I agree to the Let's Encrypt Terms of Service</span>
                    </label>
                </div>

                <div class="flex gap-sm">
                    <button type="submit" class="btn btn-success" id="obtainBtn">
                        üîê Obtain Certificate
                    </button>
                    <button type="button" class="btn btn-warning" id="renewBtn">
                        üîÑ Renew Certificate
                    </button>
                </div>
            </form>

            <div id="obtainProgress" class="d-none mt-3">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <p id="progressText" class="text-center text-comment mt-1"></p>
            </div>
        </section>
    </div>

    <!-- Renewal Settings Card -->
    <section class="card p-4 mt-4">
        <h2 class="section-title">‚öôÔ∏è Auto-Renewal Settings</h2>

        <div class="grid-2 gap-lg">
            <div>
                <div class="form-group">
                    <label class="checkbox-row">
                        <input type="checkbox" id="autoRenewal" checked>
                        <span>Enable automatic renewal</span>
                    </label>
                    <small class="form-help">Automatically renew certificates 30 days before expiry</small>
                </div>

                <div class="form-group">
                    <label for="renewalDays" class="form-label">Renewal Threshold (days)</label>
                    <input type="number" id="renewalDays" class="form-input" value="30" min="1" max="60">
                    <small class="form-help">Renew when certificate expires in this many days</small>
                </div>

                <div class="form-group">
                    <label class="checkbox-row">
                        <input type="checkbox" id="emailNotifications" checked>
                        <span>Email notifications for renewals</span>
                    </label>
                </div>

                <button class="btn btn-primary" id="saveSettingsBtn">üíæ Save Settings</button>
            </div>

            <div class="renewal-schedule">
                <h3 class="subsection-title">Renewal Schedule</h3>
                <div id="renewalSchedule">
                    <div class="schedule-item">
                        <span>Next check:</span>
                        <span id="nextCheck">-</span>
                    </div>
                    <div class="schedule-item">
                        <span>Next renewal:</span>
                        <span id="nextRenewal">-</span>
                    </div>
                    <div class="schedule-item">
                        <span>Last renewal:</span>
                        <span id="lastRenewal">Never</span>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Certificate History Card -->
    <section class="card p-4 mt-4">
        <h2 class="section-title">üìã Certificate History</h2>

        <div class="timeline" id="certHistory">
            <div class="text-center text-comment">
                No history available
            </div>
        </div>
    </section>

    <!-- Advanced Options Card -->
    <section class="card p-4 mt-4">
        <h2 class="section-title">üîß Advanced Options</h2>

        <div class="grid-2 gap-lg">
            <div>
                <h3 class="subsection-title">Certificate Actions</h3>
                <div class="btn-group-vertical">
                    <button class="btn btn-secondary" id="exportBtn">
                        üì• Export Certificate
                    </button>
                    <button class="btn btn-secondary" id="importBtn">
                        üì§ Import Certificate
                    </button>
                    <button class="btn btn-danger" id="revokeBtn">
                        ‚ö†Ô∏è Revoke Certificate
                    </button>
                </div>
            </div>

            <div>
                <h3 class="subsection-title">Testing</h3>
                <div class="btn-group-vertical">
                    <button class="btn btn-secondary" id="testBtn">
                        üß™ Test SSL Configuration
                    </button>
                    <button class="btn btn-secondary" id="scanBtn">
                        üîç Security Scan
                    </button>
                </div>
            </div>
        </div>
    </section>
</main>

<script>
    // Load certificate status
    async function loadCertStatus() {
        try {
            const response = await fetch('/api/v1/admin/ssl/status');
            const data = await response.json();

            renderCertStatus(data);
            updateSchedule(data);
        } catch (error) {
            Toast.show('Failed to load certificate status: ' + error.message, 'error');
        }
    }

    // Render certificate status
    function renderCertStatus(data) {
        const container = document.getElementById('certStatus');

        if (!data.certificate) {
            container.innerHTML = `
                <div class="text-center p-4">
                    <div class="status-badge status-none">No Certificate</div>
                    <p class="mt-3 text-comment">No SSL certificate installed</p>
                </div>
            `;
            return;
        }

        const cert = data.certificate;
        const daysUntilExpiry = Math.floor((new Date(cert.notAfter) - new Date()) / (1000 * 60 * 60 * 24));

        let statusClass = 'status-active';
        let statusText = 'Active';

        if (daysUntilExpiry < 0) {
            statusClass = 'status-expired';
            statusText = 'Expired';
        } else if (daysUntilExpiry < 30) {
            statusClass = 'status-expiring';
            statusText = 'Expiring Soon';
        }

        container.innerHTML = `
            <div class="text-center mb-3">
                <div class="status-badge ${statusClass}">${statusText}</div>
            </div>

            <div class="info-grid">
                <div class="info-row">
                    <span class="info-label">Subject:</span>
                    <span class="info-value">${cert.subject || '-'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Issuer:</span>
                    <span class="info-value">${cert.issuer || '-'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Valid From:</span>
                    <span class="info-value">${new Date(cert.notBefore).toLocaleDateString()}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Valid Until:</span>
                    <span class="info-value">${new Date(cert.notAfter).toLocaleDateString()}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Days Remaining:</span>
                    <span class="info-value">${daysUntilExpiry} days</span>
                </div>
            </div>
        `;
    }

    // Update renewal schedule
    function updateSchedule(data) {
        document.getElementById('nextCheck').textContent = data.nextCheck || '-';
        document.getElementById('nextRenewal').textContent = data.nextRenewal || '-';
        document.getElementById('lastRenewal').textContent = data.lastRenewal || 'Never';
    }

    // Obtain certificate
    document.getElementById('letsEncryptForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const obtainBtn = document.getElementById('obtainBtn');
        const progress = document.getElementById('obtainProgress');

        obtainBtn.disabled = true;
        progress.classList.remove('d-none');

        try {
            const domain = document.getElementById('domain').value;
            const email = document.getElementById('email').value;
            const altNames = document.getElementById('altNames').value.split('\n').filter(n => n.trim());

            updateProgress(10, 'Validating domain...');

            const response = await fetch('/api/v1/admin/ssl/obtain', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ domain, email, altNames })
            });

            if (!response.ok) throw new Error('Failed to obtain certificate');

            updateProgress(100, 'Certificate obtained successfully!');
            Toast.show('SSL certificate obtained and installed successfully!', 'success');

            setTimeout(() => {
                progress.classList.add('d-none');
                loadCertStatus();
            }, 2000);

        } catch (error) {
            Toast.show('Failed to obtain certificate: ' + error.message, 'error');
            progress.classList.add('d-none');
        } finally {
            obtainBtn.disabled = false;
        }
    });

    // Renew certificate
    document.getElementById('renewBtn').addEventListener('click', async () => {
        if (!confirm('Renew the SSL certificate now?')) return;

        const renewBtn = document.getElementById('renewBtn');
        renewBtn.disabled = true;

        try {
            const response = await fetch('/api/v1/admin/ssl/renew', { method: 'POST' });
            if (!response.ok) throw new Error('Failed to renew certificate');

            Toast.show('Certificate renewed successfully!', 'success');
            loadCertStatus();
        } catch (error) {
            Toast.show('Failed to renew certificate: ' + error.message, 'error');
        } finally {
            renewBtn.disabled = false;
        }
    });

    // Update progress
    function updateProgress(percent, text) {
        document.getElementById('progressFill').style.width = percent + '%';
        document.getElementById('progressText').textContent = text;
    }

    // Refresh button
    document.getElementById('refreshBtn').addEventListener('click', loadCertStatus);

    // Verify button
    document.getElementById('verifyBtn').addEventListener('click', async () => {
        try {
            const response = await fetch('/api/v1/admin/ssl/verify', { method: 'POST' });
            const data = await response.json();

            if (data.valid) {
                Toast.show('Certificate is valid and properly configured!', 'success');
            } else {
                Toast.show('Certificate validation failed: ' + data.error, 'error');
            }
        } catch (error) {
            Toast.show('Verification failed: ' + error.message, 'error');
        }
    });

    // Save settings
    document.getElementById('saveSettingsBtn').addEventListener('click', async () => {
        try {
            const settings = {
                autoRenewal: document.getElementById('autoRenewal').checked,
                renewalDays: parseInt(document.getElementById('renewalDays').value),
                emailNotifications: document.getElementById('emailNotifications').checked
            };

            const response = await fetch('/api/v1/admin/ssl/settings', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(settings)
            });

            if (!response.ok) throw new Error('Failed to save settings');

            Toast.show('Settings saved successfully!', 'success');
        } catch (error) {
            Toast.show('Failed to save settings: ' + error.message, 'error');
        }
    });

    // Initial load
    loadCertStatus();

    // Auto-refresh every 30 seconds
    setInterval(loadCertStatus, 30000);
</script>

{{template "footer" .}}
{{end}}
