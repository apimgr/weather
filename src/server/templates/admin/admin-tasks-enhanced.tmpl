{{define "admin/admin-tasks-enhanced.tmpl"}}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.title}}</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .header {
            background: #2c3e50;
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .breadcrumb {
            color: #95a5a6;
            margin-top: 0.5rem;
            font-size: 0.9rem;
        }

        .breadcrumb a {
            color: #3498db;
            text-decoration: none;
        }

        .breadcrumb a:hover {
            text-decoration: underline;
        }

        .container {
            max-width: 1600px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .nav-links {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .nav-link {
            padding: 0.5rem 1rem;
            background: white;
            border-radius: 4px;
            text-decoration: none;
            color: #333;
            transition: all 0.2s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .nav-link:hover {
            background: #3498db;
            color: white;
        }

        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid #dee2e6;
        }

        .tab {
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }

        .tab.active {
            color: #3498db;
            border-bottom-color: #3498db;
        }

        .tab:hover {
            color: #3498db;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .stat-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #2c3e50;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
            margin-top: 0.25rem;
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .card h2 {
            font-size: 1.2rem;
            margin-bottom: 1rem;
            color: #2c3e50;
        }

        .timeline {
            position: relative;
            padding: 2rem 0;
        }

        .timeline-track {
            position: relative;
            height: 100px;
            background: #f8f9fa;
            border-radius: 8px;
            overflow: hidden;
        }

        .timeline-grid {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
        }

        .timeline-hour {
            flex: 1;
            border-right: 1px solid #dee2e6;
            position: relative;
        }

        .timeline-hour:last-child {
            border-right: none;
        }

        .timeline-label {
            position: absolute;
            bottom: -1.5rem;
            left: 0;
            font-size: 0.75rem;
            color: #666;
        }

        .timeline-task {
            position: absolute;
            background: #3498db;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
            transition: all 0.2s;
        }

        .timeline-task:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .timeline-task.running {
            background: #27ae60;
            animation: pulse 2s infinite;
        }

        .timeline-task.failed {
            background: #e74c3c;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .task-list {
            display: grid;
            gap: 1rem;
        }

        .task-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            display: grid;
            grid-template-columns: auto 1fr auto auto;
            gap: 1rem;
            align-items: center;
            transition: all 0.2s;
        }

        .task-item:hover {
            background: #e9ecef;
        }

        .task-status {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #95a5a6;
        }

        .task-status.enabled {
            background: #27ae60;
        }

        .task-status.disabled {
            background: #e74c3c;
        }

        .task-status.running {
            background: #3498db;
            animation: pulse 1s infinite;
        }

        .task-info {
            flex: 1;
        }

        .task-name {
            font-weight: 500;
            color: #2c3e50;
        }

        .task-schedule {
            font-size: 0.85rem;
            color: #666;
            margin-top: 0.25rem;
        }

        .task-stats {
            display: flex;
            gap: 1rem;
            font-size: 0.85rem;
            color: #666;
        }

        .task-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-sm {
            padding: 0.25rem 0.75rem;
            font-size: 0.85rem;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
        }

        .history-table th,
        .history-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        .history-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }

        .history-table tr:hover {
            background: #f8f9fa;
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 3px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .badge-running {
            background: #d1ecf1;
            color: #0c5460;
        }

        .dependency-graph {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 2rem;
            min-height: 400px;
        }

        .graph-node {
            background: white;
            border: 2px solid #3498db;
            border-radius: 8px;
            padding: 1rem;
            display: inline-block;
            margin: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .graph-node:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .graph-node.disabled {
            border-color: #95a5a6;
            opacity: 0.6;
        }

        .graph-edge {
            stroke: #95a5a6;
            stroke-width: 2;
            fill: none;
            marker-end: url(#arrowhead);
        }

        .alert {
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
            display: none;
        }

        .alert.show {
            display: block;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        @media (max-width: 768px) {
            .task-item {
                grid-template-columns: auto 1fr;
            }

            .task-actions {
                grid-column: 1 / -1;
                justify-content: flex-start;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>‚öôÔ∏è Scheduled Tasks Management</h1>
        <div class="breadcrumb">
            <a href="/admin">Admin</a> /
            <span>Scheduled Tasks</span>
        </div>
    </div>

    <div class="container">
        <div class="nav-links">
            <a href="/admin" class="nav-link">‚Üê Dashboard</a>
            <a href="/admin/system" class="nav-link">System Info</a>
        </div>

        <div class="alert alert-success" id="successAlert" role="alert"></div>
        <div class="alert alert-error" id="errorAlert" role="alert"></div>

        <!-- Statistics -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üìä</div>
                <div class="stat-value" id="totalTasks">0</div>
                <div class="stat-label">Total Tasks</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">‚úÖ</div>
                <div class="stat-value" id="enabledTasks">0</div>
                <div class="stat-label">Enabled</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">‚ñ∂Ô∏è</div>
                <div class="stat-value" id="runningTasks">0</div>
                <div class="stat-label">Running Now</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">‚úÖ</div>
                <div class="stat-value" id="successRate">0%</div>
                <div class="stat-label">Success Rate</div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" data-tab="timeline">Timeline</button>
            <button class="tab" data-tab="tasks">Task List</button>
            <button class="tab" data-tab="history">History</button>
            <button class="tab" data-tab="dependencies">Dependencies</button>
        </div>

        <!-- Timeline Tab -->
        <div class="tab-content active" id="timeline">
            <div class="card">
                <h2>24-Hour Task Timeline</h2>
                <div class="timeline">
                    <div class="timeline-track">
                        <div class="timeline-grid" id="timelineGrid"></div>
                        <div id="timelineTasks"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Task List Tab -->
        <div class="tab-content" id="tasks">
            <div class="card">
                <h2>All Tasks</h2>
                <div class="task-list" id="taskList">
                    <div style="text-align: center; padding: 2rem; color: #666;">
                        Loading tasks...
                    </div>
                </div>
            </div>
        </div>

        <!-- History Tab -->
        <div class="tab-content" id="history">
            <div class="card">
                <h2>Execution History</h2>
                <table class="history-table" id="historyTable">
                    <thead>
                        <tr>
                            <th>Task</th>
                            <th>Status</th>
                            <th>Started</th>
                            <th>Duration</th>
                            <th>Result</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 2rem; color: #666;">
                                Loading history...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Dependencies Tab -->
        <div class="tab-content" id="dependencies">
            <div class="card">
                <h2>Task Dependencies</h2>
                <div class="dependency-graph" id="dependencyGraph">
                    <svg width="100%" height="400" id="depGraphSvg">
                        <defs>
                            <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                                <polygon points="0 0, 10 3, 0 6" fill="#95a5a6" />
                            </marker>
                        </defs>
                    </svg>
                </div>
            </div>
        </div>
    </div>

    <script>
        let tasks = [];
        let currentTab = 'timeline';

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

                tab.classList.add('active');
                document.getElementById(tab.dataset.tab).classList.add('active');
                currentTab = tab.dataset.tab;

                if (currentTab === 'history') loadHistory();
                if (currentTab === 'dependencies') renderDependencyGraph();
            });
        });

        // Load tasks
        async function loadTasks() {
            try {
                const response = await fetch('/api/v1/admin/tasks');
                const data = await response.json();
                tasks = data.tasks || [];

                updateStats();
                renderTaskList();
                renderTimeline();
            } catch (error) {
                showError('Failed to load tasks: ' + error.message);
            }
        }

        // Update statistics
        function updateStats() {
            const enabled = tasks.filter(t => t.enabled).length;
            const running = tasks.filter(t => t.running).length;
            const total = tasks.length;

            document.getElementById('totalTasks').textContent = total;
            document.getElementById('enabledTasks').textContent = enabled;
            document.getElementById('runningTasks').textContent = running;

            // Calculate success rate from recent history
            const successRate = 95; // Placeholder
            document.getElementById('successRate').textContent = successRate + '%';
        }

        // Render task list
        function renderTaskList() {
            const container = document.getElementById('taskList');

            if (tasks.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #666;">No tasks configured</div>';
                return;
            }

            container.innerHTML = tasks.map(task => `
                <div class="task-item">
                    <div class="task-status ${task.enabled ? 'enabled' : 'disabled'} ${task.running ? 'running' : ''}"></div>
                    <div class="task-info">
                        <div class="task-name">${task.name}</div>
                        <div class="task-schedule">Every ${formatInterval(task.interval)}</div>
                    </div>
                    <div class="task-stats">
                        <span>Last: ${task.lastRun || 'Never'}</span>
                        <span>Next: ${task.nextRun || '-'}</span>
                    </div>
                    <div class="task-actions">
                        <button class="btn btn-sm btn-primary" onclick="triggerTask('${task.name}')">‚ñ∂Ô∏è Run</button>
                        <button class="btn btn-sm ${task.enabled ? 'btn-danger' : 'btn-success'}"
                                onclick="toggleTask('${task.name}', ${task.enabled})">
                            ${task.enabled ? '‚è∏Ô∏è Disable' : '‚ñ∂Ô∏è Enable'}
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Render timeline
        function renderTimeline() {
            const grid = document.getElementById('timelineGrid');
            const tasksContainer = document.getElementById('timelineTasks');

            // Create 24-hour grid
            let gridHTML = '';
            for (let i = 0; i < 24; i++) {
                gridHTML += `<div class="timeline-hour"><span class="timeline-label">${i}:00</span></div>`;
            }
            grid.innerHTML = gridHTML;

            // Plot tasks on timeline
            tasksContainer.innerHTML = tasks.map((task, index) => {
                const hourPos = getHourPosition(task.interval);
                return `
                    <div class="timeline-task ${task.running ? 'running' : ''}"
                         style="left: ${hourPos}%; top: ${(index % 3) * 30 + 10}px; width: 8%;"
                         title="${task.name}">
                        ${task.name}
                    </div>
                `;
            }).join('');
        }

        // Get hour position from interval
        function getHourPosition(interval) {
            // Convert interval to hours and calculate position
            const hours = parseInterval(interval);
            return (hours / 24) * 100;
        }

        // Parse interval string to hours
        function parseInterval(interval) {
            if (interval.includes('h')) return parseInt(interval);
            if (interval.includes('m')) return parseInt(interval) / 60;
            if (interval.includes('s')) return parseInt(interval) / 3600;
            return 1;
        }

        // Format interval for display
        function formatInterval(interval) {
            return interval || '1 hour';
        }

        // Load execution history
        async function loadHistory() {
            try {
                const response = await fetch('/api/v1/admin/tasks/history');
                const data = await response.json();

                const tbody = document.getElementById('historyTable').querySelector('tbody');
                tbody.innerHTML = data.history.map(h => `
                    <tr>
                        <td>${h.task}</td>
                        <td><span class="badge badge-${h.status === 'success' ? 'success' : 'danger'}">${h.status}</span></td>
                        <td>${new Date(h.startedAt).toLocaleString()}</td>
                        <td>${h.duration}</td>
                        <td>${h.result || '-'}</td>
                    </tr>
                `).join('');
            } catch (error) {
                showError('Failed to load history: ' + error.message);
            }
        }

        // Render dependency graph
        function renderDependencyGraph() {
            // Simplified dependency visualization
            const graph = document.getElementById('dependencyGraph');
            graph.innerHTML = `
                <div style="text-align: center; padding: 3rem; color: #666;">
                    <p>Task Dependency Graph</p>
                    <p style="margin-top: 1rem; font-size: 0.9rem;">
                        Most tasks run independently. Complex dependencies can be configured via API.
                    </p>
                </div>
            `;
        }

        // Trigger task
        async function triggerTask(name) {
            if (!confirm(`Manually trigger task: ${name}?`)) return;

            try {
                const response = await fetch(`/api/v1/admin/tasks/${name}/trigger`, { method: 'POST' });
                if (!response.ok) throw new Error('Failed to trigger task');

                showSuccess(`Task "${name}" triggered successfully!`);
                setTimeout(loadTasks, 1000);
            } catch (error) {
                showError('Failed to trigger task: ' + error.message);
            }
        }

        // Toggle task enabled state
        async function toggleTask(name, currentlyEnabled) {
            const action = currentlyEnabled ? 'disable' : 'enable';

            try {
                const response = await fetch(`/api/v1/admin/tasks/${name}/${action}`, { method: 'POST' });
                if (!response.ok) throw new Error(`Failed to ${action} task`);

                showSuccess(`Task "${name}" ${action}d successfully!`);
                loadTasks();
            } catch (error) {
                showError(`Failed to ${action} task: ` + error.message);
            }
        }

        // Show messages
        function showSuccess(msg) {
            const alert = document.getElementById('successAlert');
            alert.textContent = msg;
            alert.classList.add('show');
            setTimeout(() => alert.classList.remove('show'), 5000);
        }

        function showError(msg) {
            const alert = document.getElementById('errorAlert');
            alert.textContent = msg;
            alert.classList.add('show');
            setTimeout(() => alert.classList.remove('show'), 5000);
        }

        // Initial load
        loadTasks();

        // Auto-refresh every 10 seconds
        setInterval(loadTasks, 10000);
    </script>
</body>
</html>
{{end}}
