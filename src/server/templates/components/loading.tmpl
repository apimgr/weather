<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather - Initializing</title>
    <link rel="stylesheet" href="/static/css/dracula.css">
    <link rel="stylesheet" href="/static/css/template-overrides.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>‚òï</text></svg>">
</head>
<body>
    <div class="weather-container">
        <div class="weather-header">
            ‚òï Weather
        </div>

        <div class="loading-page-container">
            <div class="coffee-spinner">‚òï</div>

            <h2 class="loading-page-title">
                Warming up the weather service<span class="loading-dots"></span>
            </h2>

            <div class="status-info">
                <div class="loading-page-status-item--yellow">
                    üåç Loading global location database...
                </div>
                <div class="loading-page-status-item--green">
                    üå§Ô∏è Connecting to weather services...
                </div>
                <div class="loading-page-status-item--purple">
                    üé® Preparing beautiful interfaces...
                </div>
            </div>

            <div class="margin-y-2">
                <p class="text-comment">
                    The service is initializing. This usually takes a few moments while we load
                    weather data and location databases.
                </p>

                <div class="margin-y-15">
                    <span class="loading-page-countdown-label">Next check in:</span>
                    <span id="countdown" class="retry-countdown">30</span>
                    <span class="loading-page-countdown-label">seconds</span>
                    <div class="loading-page-countdown-note">
                        (Auto-checking every 15 seconds)
                    </div>
                </div>

                <button id="retry-btn" class="search-button loading-page-retry-button">
                    üîÑ Try Again Now
                </button>
            </div>

            <div class="loading-page-while-wait-box">
                <h4 class="loading-page-while-wait-title">While You Wait...</h4>
                <p class="loading-page-while-wait-text">
                    This service provides beautiful ASCII weather art for terminals and responsive web interfaces.
                    Try these console commands once it's ready:
                </p>
                <div class="loading-page-code-box">
                    <div class="loading-page-code-line loading-page-code-line--cyan">curl -q -LSs {{.HostInfo.FullHost}}/London,GB?format=3</div>
                    <div class="loading-page-code-line loading-page-code-line--pink">curl -q -LSs {{.HostInfo.FullHost}}/moon/Tokyo,JP</div>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>Loading weather service ‚Ä¢ Please wait while we initialize...</p>
        </div>
    </div>

    <script>
        let countdown = 30;  // Wait 30 seconds before first check
        let countdownInterval;
        let healthCheckInterval;
        let firstCheckDone = false;

        function updateCountdown() {
            document.getElementById('countdown').textContent = Math.max(countdown, 0);
            countdown--;

            if (countdown < 0) {
                clearInterval(countdownInterval);
                retryConnection();
            }
        }

        function startCountdown(seconds) {
            // Clear any existing interval
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }
            countdown = seconds;
            // Start new countdown
            countdownInterval = setInterval(updateCountdown, 1000);
        }

        function checkHealth() {
            console.log('Checking service health...');

            fetch('/healthz')
                .then(response => response.json())
                .then(data => {
                    console.log('Health check:', data);

                    // Check if service is ready
                    if (data.ready === true) {
                        console.log('‚úÖ Service ready! Redirecting...');

                        // Clear all intervals
                        if (countdownInterval) clearInterval(countdownInterval);
                        if (healthCheckInterval) clearInterval(healthCheckInterval);

                        // Redirect to the originally requested URL or homepage
                        const urlParams = new URLSearchParams(window.location.search);
                        const redirectUrl = urlParams.get('redirect') || '/';
                        window.location.href = redirectUrl;
                    } else {
                        console.log('‚è≥ Service still initializing:', data.initialization);

                        // After first check, start periodic checks every 15 seconds
                        if (!firstCheckDone) {
                            firstCheckDone = true;
                            if (healthCheckInterval) clearInterval(healthCheckInterval);
                            healthCheckInterval = setInterval(checkHealth, 15000); // Check every 15 seconds
                            startCountdown(15); // Reset countdown to 15 seconds
                        }
                    }
                })
                .catch(error => {
                    console.log('‚ùå Health check failed:', error.message);

                    // After first check, start periodic checks even if failed
                    if (!firstCheckDone) {
                        firstCheckDone = true;
                        if (healthCheckInterval) clearInterval(healthCheckInterval);
                        healthCheckInterval = setInterval(checkHealth, 15000);
                        startCountdown(15);
                    }
                });
        }

        function retryConnection() {
            console.log('Retrying connection...');

            // Clear countdown interval
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }

            // Show loading state
            const retryBtn = document.getElementById('retry-btn');
            retryBtn.textContent = '‚òï Checking...';
            retryBtn.disabled = true;

            // Check if service is ready
            fetch('/healthz')
                .then(response => response.json())
                .then(data => {
                    if (data.ready === true) {
                        // Service is ready, redirect to main page
                        console.log('‚úÖ Service ready, redirecting...');

                        // Clear all intervals
                        if (healthCheckInterval) clearInterval(healthCheckInterval);

                        const urlParams = new URLSearchParams(window.location.search);
                        const redirectUrl = urlParams.get('redirect') || '/';
                        window.location.href = redirectUrl;
                    } else {
                        throw new Error(`Service not ready: ${JSON.stringify(data.initialization)}`);
                    }
                })
                .catch(error => {
                    console.log('‚è≥ Service still initializing:', error.message);

                    // Reset countdown and try again after 15 seconds
                    retryBtn.textContent = 'üîÑ Try Again Now';
                    retryBtn.disabled = false;

                    // Restart countdown with 15 seconds
                    startCountdown(15);
                });
        }

        // Start initial countdown (30 seconds before first check)
        startCountdown(30);

        // Manual retry button
        document.getElementById('retry-btn').addEventListener('click', function() {
            retryConnection();
        });

        // Do first health check after 30 seconds
        setTimeout(checkHealth, 30000);
    </script>
</body>
</html>
